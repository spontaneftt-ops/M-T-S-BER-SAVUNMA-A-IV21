<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MİT | KIZIL ELMA SİBER SAVUNMA v45.0 (ULTIMATE)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;600;700&family=Courier+New:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --hue: 0; 
            --bg-deep: #020202;
            --accent: #ff0000; 
            --accent-dim: #500000;
            --accent-glow: rgba(255, 0, 0, 0.35);
            --staff-blue: #00ccff;
            --admin-gold: #ffcc00;
            --cyber-green: #00ff41;
            --ai-purple: #bd00ff;
            --text-main: #e0e0e0;
            --discord: #5865F2;
        }

        body.defcon-5 { --accent: #00ff00; --accent-dim: #004400; }
        body.defcon-4 { --accent: #ffff00; --accent-dim: #444400; }
        body.defcon-3 { --accent: #ff8800; --accent-dim: #442200; }
        body.defcon-1 { --accent: #ff0000; --accent-dim: #500000; }

        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--accent) #111; }
        
        body { 
            background-color: var(--bg-deep);
            background-image: url('https://img.freepik.com/premium-photo/digital-world-map-hologram-blue-background_436667-178.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-main); font-family: 'Rajdhani', sans-serif;
            height: 100vh; overflow: hidden; user-select: none;
            transition: --accent 0.5s ease;
        }

        .overlay-bg { position: fixed; inset: 0; background: radial-gradient(circle, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.95) 100%); pointer-events: none; z-index: 0; }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.3; }

        /* BOOT SCREEN */
        #boot-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Share Tech Mono'; color: var(--accent); }
        .mit-logo-anim { width: 150px; height: 150px; background: url('https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png') no-repeat center/contain; filter: drop-shadow(0 0 20px red); animation: pulseLogo 2s infinite; margin-bottom: 20px; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; filter: drop-shadow(0 0 40px red); } }

        /* APP LAYOUT */
        .app-wrapper { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 10; opacity: 0; transition: opacity 1s; }
        header { height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(5,0,0,0.9); border-bottom: 3px solid var(--accent); backdrop-filter: blur(10px); box-shadow: 0 0 30px var(--accent-glow); }
        .workspace { display: flex; flex: 1; overflow: hidden; }
        aside { width: 300px; background: rgba(5,5,5,0.95); border-right: 1px solid #222; display: flex; flex-direction: column; padding: 20px 0; backdrop-filter: blur(5px); }
        main { flex: 1; padding: 30px; overflow-y: auto; background: rgba(0,0,0,0.3); position: relative; }

        /* COMPONENTS */
        .glass-box { background: rgba(10, 15, 20, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); padding: 25px; border-radius: 4px; margin-bottom: 25px; border-left: 2px solid var(--accent); box-shadow: 0 10px 40px rgba(0,0,0,0.7); position: relative; overflow: hidden; }
        h2, h3 { font-family: 'Orbitron'; color: var(--accent); margin-bottom: 15px; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 10px var(--accent-glow); }

        .nav-btn { background: transparent; border: none; color: #888; padding: 15px 25px; text-align: left; cursor: pointer; font-family: 'Rajdhani'; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 15px; width: 100%; transition: 0.3s; border-right: 3px solid transparent; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: linear-gradient(90deg, var(--accent-dim) 0%, transparent 100%); color: white; border-right-color: var(--accent); }
        .nav-btn.disabled { display: none !important; }

        .cyber-btn { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--accent); color: var(--accent); padding: 12px; font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; font-weight: bold; letter-spacing: 1px; }
        .cyber-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 25px var(--accent); }
        .btn-small { width: auto; padding: 6px 12px; font-size: 0.75rem; margin-right: 5px; }
        .btn-green { border-color: #00ff00; color: #00ff00; } .btn-green:hover { background: #00ff00; color: black; }
        .btn-red { border-color: #ff0000; color: #ff0000; }
        .btn-ai { border-color: var(--ai-purple); color: var(--ai-purple); }

        input, textarea, select { width: 100%; background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 12px; color: white; font-family: 'Share Tech Mono'; margin-bottom: 15px; outline: none; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        /* CHAT & CALL UI */
        .chat-container { display: grid; grid-template-columns: 1fr 280px; gap: 15px; height: 500px; }
        .chat-window { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-sidebar { background: rgba(0,0,0,0.4); border: 1px solid #333; padding: 10px; overflow-y: auto; }
        .chat-user-card { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; transition: 0.3s; }
        .chat-user-card:hover { background: rgba(255,255,255,0.05); }
        .user-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; margin-right: 8px; display: inline-block; }
        .status-online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .msg { padding: 10px; border-radius: 4px; max-width: 80%; font-size: 0.9rem; }
        .msg-me { background: var(--accent-dim); align-self: flex-end; border: 1px solid var(--accent); color: white; }
        .msg-other { background: #151515; align-self: flex-start; border: 1px solid #333; color: #ccc; }

        /* GENERATOR */
        .gen-result-box { background: rgba(0,0,0,0.6); border: 1px solid var(--staff-blue); padding: 15px; margin-top: 20px; font-family: 'Courier New', monospace; display: none; }
        .gen-field { margin-bottom: 5px; color: #ccc; }
        .gen-val { color: var(--staff-blue); font-weight: bold; }

        /* MODALS */
        #call-modal, #login-modal, #hack-modal, #app-view-modal, #lockdown-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .call-pulse { width: 100px; height: 100px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; animation: pulseCall 1.5s infinite; margin-bottom: 20px; box-shadow: 0 0 30px var(--accent-glow); }
        @keyframes pulseCall { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 30px rgba(0,0,0,0); } }

        .cyber-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .cyber-table th { text-align: left; border-bottom: 1px solid var(--accent); padding: 10px; color: #aaa; }
        .cyber-table td { padding: 10px; border-bottom: 1px solid #333; }

        .panel { display: none; animation: fadeIn 0.4s ease-out; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media screen and (max-width: 900px) {
            header { flex-direction: column; height: auto; padding: 10px; }
            .workspace { flex-direction: column; overflow: visible; }
            aside { width: 100%; border-right: none; border-bottom: 2px solid var(--accent); }
            .chat-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="defcon-1">

    <div class="overlay-bg"></div>
    <div class="scanlines"></div>
    <div id="particles-js"></div>

    <div id="boot-screen">
        <div class="mit-logo-anim"></div>
        <h1 style="font-size: 2.5rem; letter-spacing: 5px; text-shadow: 0 0 20px red;">MİT <span style="color:var(--accent)">SİBER AĞ</span></h1>
        <div id="boot-text">SİSTEM YÜKLENİYOR...</div>
        <div style="margin-top:20px; width:300px; height:4px; background:#111; border-radius:2px; overflow:hidden;">
            <div style="width:100%; height:100%; background:var(--accent); animation: loadBar 3s ease-in-out;"></div>
        </div>
        <style>@keyframes loadBar { 0% { width:0; } 100% { width:100%; } }</style>
    </div>

    <div id="call-modal" style="flex-direction: column;">
        <div class="call-pulse"><i class="fas fa-phone fa-3x" style="color:white"></i></div>
        <h2 id="call-status" style="color:white; margin-bottom:10px;">GELEN ARAMA</h2>
        <p id="call-caller" style="color:var(--staff-blue); font-size:1.2rem; margin-bottom:30px;">...</p>
        <div id="call-actions" style="display:flex; gap:20px;">
            <button class="cyber-btn btn-green" onclick="app.phone.answerCall()">CEVAPLA</button>
            <button class="cyber-btn btn-red" onclick="app.phone.rejectCall()">REDDET</button>
        </div>
        <div id="in-call-ui" style="display:none; text-align:center;">
            <p style="color:#0f0;">BAĞLANTI GÜVENLİ (ŞİFRELİ)</p>
            <h1 id="call-timer" style="font-size:3rem; font-family:'Share Tech Mono'">00:00</h1>
            <button class="cyber-btn btn-red" style="margin-top:20px;" onclick="app.phone.endCall()">KAPAT</button>
        </div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <div id="app-view-modal" style="display:none; overflow-y:auto; padding:20px;">
        <div class="glass-box" style="max-width:800px; width:100%; border-color:var(--admin-gold);">
            <h3 style="color:var(--admin-gold); text-align:center;">BAŞVURU İNCELEME</h3>
            <div id="app-view-content" style="margin-bottom:20px; max-height: 500px; overflow-y: auto;"></div>
            <div style="display:flex; gap:10px;">
                <button class="cyber-btn btn-green" onclick="app.approveAppCurrent()">ONAYLA</button>
                <button class="cyber-btn btn-red" onclick="app.rejectAppCurrent()">REDDET</button>
                <button class="cyber-btn" onclick="document.getElementById('app-view-modal').style.display='none'">KAPAT</button>
            </div>
        </div>
    </div>

    <div id="login-modal" style="display:flex;">
        <div class="glass-box" style="width:400px; text-align:center; border:2px solid var(--accent);">
            <i class="fas fa-shield-alt fa-3x" style="color:var(--accent); margin-bottom:15px;"></i>
            <h3>GÜVENLİK PROTOKOLÜ v45</h3>
            <input type="password" id="login-pass" placeholder="ERİŞİM KODU" style="text-align:center; letter-spacing:5px;">
            <button class="cyber-btn" onclick="app.login()">GİRİŞ</button>
            <p id="login-msg" style="margin-top:10px; color:var(--accent);"></p>
        </div>
    </div>

    <div class="app-wrapper" id="main-app" style="opacity:0;">
        <header>
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png" height="60" style="filter: drop-shadow(0 0 15px var(--accent));">
                <div>
                    <h1 style="font-family:'Orbitron'; font-size:1.8rem; line-height:1; color:white;">MİT <span style="color:var(--accent)">KIZIL ELMA</span></h1>
                    <small style="color:#aaa; letter-spacing:2px; font-size:0.75rem;">SİBER SAVUNMA AĞI v45.0</small>
                </div>
            </div>
            <div style="text-align:right;">
                <div id="u-role-disp" style="color:var(--admin-gold); font-weight:bold;">MİSAFİR</div>
                <div id="sys-clock" style="font-family:'Share Tech Mono'; color:#888;">00:00:00</div>
            </div>
        </header>

        <div class="workspace">
            <aside>
                <div style="text-align:center; padding: 20px; border-bottom: 1px solid #333; margin-bottom: 10px;">
                    <div style="width:70px; height:70px; border-radius:50%; border:2px solid var(--accent); margin:0 auto 15px; overflow:hidden;">
                        <img id="u-photo" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                        <i id="u-icon" class="fas fa-user-secret fa-2x" style="color:white; margin-top:20px;"></i>
                    </div>
                    <h3 id="u-name" style="font-size:1rem; margin-bottom:5px;">MİSAFİR</h3>
                    <p id="u-code" style="font-size:0.9rem; color:var(--staff-blue);">---</p>
                </div>

                <div id="nav-container">
                    <button class="nav-btn" data-perm="public" onclick="app.nav('public')"><i class="fas fa-globe"></i> Duyurular</button>
                    <button class="nav-btn" data-perm="basvuru" onclick="app.nav('basvuru')"><i class="fas fa-user-plus"></i> Başvuru</button>
                    <button class="nav-btn disabled" data-perm="dashboard" onclick="app.nav('dashboard')"><i class="fas fa-th"></i> Komuta</button>
                    <button class="nav-btn disabled" data-perm="chat" onclick="app.nav('chat')"><i class="fas fa-comments"></i> Güvenli Hat</button>
                    <button class="nav-btn disabled" data-perm="ops" onclick="app.nav('ops')"><i class="fas fa-crosshairs"></i> Operasyon</button>
                    <button class="nav-btn disabled" data-perm="gen" onclick="app.nav('generator')" style="color: #ffaa00;"><i class="fas fa-id-card"></i> Kimlik Üretici</button>
                    <button class="nav-btn disabled" data-perm="cyber" onclick="app.nav('cyber')"><i class="fas fa-code"></i> Siber / Kripto</button>
                    <button class="nav-btn disabled" data-perm="ai" onclick="app.nav('ai')"><i class="fas fa-brain"></i> Y.Z. Görüntü</button>
                    <button class="nav-btn disabled" data-perm="hr" onclick="app.nav('hr')"><i class="fas fa-users"></i> Personel</button>
                    <button class="nav-btn disabled" data-perm="logout" onclick="location.reload()" style="color:var(--accent); margin-top:auto;"><i class="fas fa-power-off"></i> Çıkış</button>
                </div>
            </aside>

            <main>
                <div id="panel-public" class="panel active">
                    <div class="glass-box"><h2><i class="fas fa-bullhorn"></i> RESMİ DUYURULAR</h2><div id="feed-public"></div></div>
                </div>

                <div id="panel-basvuru" class="panel">
                    <div class="glass-box" style="max-width:800px; margin:0 auto;">
                        <h2 style="text-align:center;">MİLLİ İSTİHBARAT AKADEMİSİ</h2>
                        <div id="app-step-1">
                            <h3 style="color:var(--staff-blue);">AŞAMA 1: KİMLİK DOĞRULAMA</h3>
                            <label>TC Kimlik</label><input id="app-tc" maxlength="11"><label>Ad Soyad</label><input id="app-name">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                <div><label>Cinsiyet</label><select id="app-gender"><option value="men">Erkek</option><option value="women">Kadın</option></select></div>
                                <div><label>Branş</label><select id="app-skill"><option value="siber">Siber İstihbarat</option><option value="saha">Saha Operasyon</option><option value="analiz">Stratejik Analiz</option></select></div>
                            </div>
                            <button class="cyber-btn" onclick="app.goToExam()">SINAVA GEÇ</button>
                        </div>
                        <div id="app-step-2" style="display:none;">
                            <h3 style="color:var(--accent);">AŞAMA 2: YETERLİLİK SINAVI</h3>
                            <div class="glass-box" style="border:none; background:rgba(0,0,0,0.3);">
                                <label>1. Motivasyonunuz?</label><input id="q1">
                                <label>2. "Devletin Bekası" nedir?</label><textarea id="q2"></textarea>
                                <label>3. Zor durumda kaldınız?</label><textarea id="q9"></textarea>
                                <button class="cyber-btn btn-gold" onclick="app.submitExam()">BAŞVURUYU TAMAMLA</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-dashboard" class="panel">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:20px;">
                        <div class="glass-box" style="text-align:center;"><small>TEHDİT SEVİYESİ</small><h1 id="defcon-disp" style="color:var(--accent); font-size:3rem; margin-top:5px;">1</h1></div>
                        <div class="glass-box" style="text-align:center;"><small>PERSONEL</small><h1 id="stat-staff" style="color:white;">0</h1></div>
                        <div class="glass-box" style="text-align:center;"><small>GÖREV</small><h1 id="stat-ops" style="color:var(--staff-blue);">0</h1></div>
                    </div>
                    <div class="glass-box" style="padding:0; height:400px;"><div id="map" style="height:100%;"></div></div>
                </div>

                <div id="panel-chat" class="panel">
                    <div class="glass-box" style="max-width:1000px; margin:0 auto;">
                        <h2 style="text-align:center; color:var(--staff-blue);">GÜVENLİ HAT</h2>
                        <div class="chat-container">
                            <div class="chat-window" id="chat-window"></div>
                            <div class="chat-sidebar">
                                <h4 style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:5px;">AKTİF PERSONEL</h4>
                                <div id="active-user-list"></div>
                            </div>
                        </div>
                        <div class="chat-inputs" style="margin-top:10px;">
                            <input id="chat-input" placeholder="Mesajınız..." style="margin:0; flex:1;">
                            <button class="cyber-btn" onclick="app.sendChat()" style="width:100px;">GÖNDER</button>
                        </div>
                    </div>
                </div>

                <div id="panel-generator" class="panel">
                    <div class="glass-box" style="border-color: #ffaa00;">
                        <h2 style="color: #ffaa00;"><i class="fas fa-id-card"></i> GİZLİ KİMLİK ÜRETİCİ</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Cinsiyet</label>
                                <select id="gen-gender"><option value="random">Rastgele</option><option value="men">Erkek</option><option value="women">Kadın</option></select>
                                <button class="cyber-btn" onclick="app.generator.generate()" style="border-color:#ffaa00; color:#ffaa00; margin-top:20px;">KİMLİK OLUŞTUR</button>
                                <div id="gen-data-display" class="gen-result-box">
                                    <div class="gen-field">TC: <span class="gen-val" id="res-tc"></span></div>
                                    <div class="gen-field">AD SOYAD: <span class="gen-val" id="res-name"></span></div>
                                    <div class="gen-field">ANA/BABA: <span class="gen-val" id="res-parents"></span></div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <canvas id="genCanvas" width="500" height="300" style="width:100%; border:1px solid #333; border-radius:10px;"></canvas>
                                <br><br>
                                <button class="cyber-btn btn-small" onclick="app.generator.download()">KARTI İNDİR</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-ops" class="panel">
                    <div class="glass-box">
                        <div style="display:flex; justify-content:space-between;"><h2>OPERASYONLAR</h2><button class="cyber-btn btn-small" onclick="app.addOp()">+ YENİ</button></div>
                        <table class="cyber-table" id="ops-table"><tbody></tbody></table>
                    </div>
                </div>

                <div id="panel-hr" class="panel">
                    <div class="glass-box">
                        <h3>PERSONEL YÖNETİMİ</h3>
                        <table class="cyber-table" id="hr-staff-table"><thead id="hr-table-head"></thead><tbody id="hr-table-body"></tbody></table>
                    </div>
                    <div class="glass-box">
                        <h3>BEKLEYEN BAŞVURULAR</h3>
                        <div id="hr-apps-list"></div>
                    </div>
                </div>
                
                <div id="panel-cyber" class="panel">
                     <div class="glass-box" style="border-color:var(--cyber-green);">
                        <h2 style="color:var(--cyber-green);">KRİPTO MERKEZİ</h2>
                        <input id="crypto-input" placeholder="Gizli Mesaj">
                        <button class="cyber-btn" onclick="app.createCryptoMessage()" style="color:var(--cyber-green);">ŞİFRELE</button>
                        <div id="cyber-messages-list" style="margin-top:20px;"></div>
                    </div>
                </div>
                
                <div id="panel-ai" class="panel">
                    <div class="glass-box" style="border-color:var(--ai-purple);">
                        <h2 style="color:var(--ai-purple);">Y.Z. GÖRÜNTÜLEME</h2>
                        <input id="ai-prompt" placeholder="Prompt...">
                        <button class="cyber-btn btn-ai" onclick="app.generateAIImage()">OLUŞTUR</button>
                        <img id="ai-generated-img" style="display:none; max-width:100%; margin-top:20px; border:2px solid var(--ai-purple);">
                    </div>
                </div>

            </main>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    // FIREBASE SETUP
    const firebaseConfig = { apiKey: "AIzaSyD4mXN8BZ3OMzl35vtEbNGA9BUuHPgoqQU", authDomain: "mit-sistemi.firebaseapp.com", databaseURL: "https://mit-sistemi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "mit-sistemi", storageBucket: "mit-sistemi.firebasestorage.app", messagingSenderId: "195453377116", appId: "1:195453377116:web:85067f5070ecf983bb6499" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ROL VE İZİN TANIMLARI
    const ROLES = {
        'admin': { label: 'YÖNETİCİ', color: '#ffcc00', perms: ['public', 'dashboard', 'chat', 'ops', 'gen', 'cyber', 'ai', 'hr', 'call', 'logout'] },
        'staff': { label: 'PERSONEL', color: '#fff', perms: ['public', 'chat', 'logout'] },
        'cyber': { label: 'SİBER UZMAN', color: '#00ff41', perms: ['public', 'chat', 'cyber', 'ai', 'gen', 'logout'] },
        'agent': { label: 'SAHA AJANI', color: '#00ccff', perms: ['public', 'chat', 'ops', 'gen', 'logout'] }
    };

    // SES EFEKTLERİ
    const SFX={ctx:new(window.AudioContext||window.webkitAudioContext)(),playTone:function(f,t,d){if(this.ctx.state==='suspended')this.ctx.resume();const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(this.ctx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.00001,this.ctx.currentTime+d);o.stop(this.ctx.currentTime+d);},click:function(){this.playTone(1200,'sine',0.1);},error:function(){this.playTone(150,'sawtooth',0.3);},ring:function(){const n=this.ctx.currentTime;const o=this.ctx.createOscillator();const g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(800,n);o.frequency.setValueAtTime(600,n+0.4);g.gain.setValueAtTime(0.1,n);g.gain.exponentialRampToValueAtTime(0.00001,n+0.8);o.start(n);o.stop(n+0.8);}};

    // TELEFON SİSTEMİ (PEERJS)
    const phoneSystem = {
        peer: null, activeCall: null, myStream: null, ringInterval: null,
        init: function(uid) {
            const id = uid + "_" + Math.floor(Math.random()*10000);
            this.peer = new Peer(id);
            this.peer.on('open', pid => {
                database.ref('online_users/' + uid).set({ peerId: pid, name: app.state.user.codename, status: 'online' });
                database.ref('online_users/' + uid).onDisconnect().remove();
            });
            this.peer.on('call', c => this.incomingCall(c));
        },
        callUser: function(targetPeerId, targetName) {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                this.myStream = s;
                const call = this.peer.call(targetPeerId, s);
                this.setupUI(call, targetName, "ARANIYOR...");
            }).catch(e => alert("Mikrofon izni yok"));
        },
        incomingCall: function(c) {
            this.activeCall = c;
            document.getElementById('call-modal').style.display='flex';
            document.getElementById('call-caller').innerText = "BİLİNMEYEN";
            document.getElementById('call-actions').style.display='flex';
            document.getElementById('in-call-ui').style.display='none';
            this.ringInterval = setInterval(()=>SFX.ring(), 1500);
        },
        answerCall: function() {
            clearInterval(this.ringInterval);
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                this.myStream = s;
                this.activeCall.answer(s);
                this.setupUI(this.activeCall, "BAĞLANDI", "GÖRÜŞME SÜRÜYOR");
            });
        },
        rejectCall: function() { clearInterval(this.ringInterval); if(this.activeCall)this.activeCall.close(); document.getElementById('call-modal').style.display='none'; },
        endCall: function() { if(this.activeCall)this.activeCall.close(); if(this.myStream)this.myStream.getTracks().forEach(t=>t.stop()); document.getElementById('call-modal').style.display='none'; },
        setupUI: function(c, n, s) {
            this.activeCall = c;
            document.getElementById('call-modal').style.display='flex';
            document.getElementById('call-status').innerText=s;
            document.getElementById('call-caller').innerText=n;
            document.getElementById('call-actions').style.display='none';
            document.getElementById('in-call-ui').style.display='block';
            c.on('stream', rs => { const a = document.getElementById('remote-audio'); a.srcObject = rs; a.play(); });
            c.on('close', () => { clearInterval(this.ringInterval); this.endCall(); });
        }
    };

    const app = {
        defaultData: {
            defcon: 1,
            personnel: [
                { id: 'ADM-001', name: 'HAKAN F.', codename: 'KARTAL', role: 'admin', pass: 'TURAN', gender: 'men', photoId: 33 },
                { id: 'STF-001', name: 'ZEYNEP', codename: 'ASENA', role: 'staff', pass: '1234', gender: 'women', photoId: 10 }
            ],
            announcements: [{title:"SİSTEM AKTİF", msg:"v45.0 Ultimate Integration", type:"critical", date:"2026"}],
            apps: [], ops: [], chat: []
        },
        state: { user: null, db: null, onlineUsers: {}, viewingAppIdx: null },
        phone: phoneSystem,

        // KIMLIK URETICI (BVD Modülü)
        generator: {
            data: {
                namesM: ["ALPARSLAN","METEHAN","GÖKTUĞ","KÜRŞAD","TİMUR"], namesF: ["ASENA","TOMRİS","BİLGE","GÖKÇE","UMAY"],
                surnames: ["KORTEKİN","BOZKURT","YILDIRIM","DEMİR","KAYA"]
            },
            current: null,
            generate: function() {
                const gInput = document.getElementById('gen-gender').value;
                const g = gInput==='random' ? (Math.random()>0.5?'men':'women') : gInput;
                const n = g==='men' ? this.data.namesM[Math.floor(Math.random()*5)] : this.data.namesF[Math.floor(Math.random()*5)];
                const s = this.data.surnames[Math.floor(Math.random()*5)];
                const tc = Math.floor(10000000000 + Math.random()*90000000000);
                this.current = {tc, name:n, surname:s, gender:g, photoId:Math.floor(Math.random()*99)};
                
                document.getElementById('res-tc').innerText=tc;
                document.getElementById('res-name').innerText=n+" "+s;
                document.getElementById('res-parents').innerText="BİLİNMİYOR";
                document.getElementById('gen-data-display').style.display='block';
                this.draw();
            },
            draw: function() {
                const cvs = document.getElementById('genCanvas'); const ctx = cvs.getContext('2d');
                const w = cvs.width; const h = cvs.height;
                ctx.fillStyle="#111"; ctx.fillRect(0,0,w,h);
                ctx.fillStyle="#e30a17"; ctx.fillRect(0,0,w,60);
                ctx.fillStyle="white"; ctx.font="bold 20px Arial"; ctx.fillText("TÜRKİYE CUMHURİYETİ", 140, 40);
                const img = new Image(); img.crossOrigin="Anonymous";
                img.src=`https://randomuser.me/api/portraits/${this.current.gender}/${this.current.photoId}.jpg`;
                img.onload = () => { ctx.drawImage(img, 20, 80, 150, 180); };
                ctx.fillStyle="#ccc"; ctx.font="16px monospace";
                ctx.fillText("TC: "+this.current.tc, 200, 100);
                ctx.fillText("AD: "+this.current.name, 200, 140);
                ctx.fillText("SOYAD: "+this.current.surname, 200, 180);
            },
            download: function() {
                const l = document.createElement('a'); l.download='ID_CARD.png';
                l.href = document.getElementById('genCanvas').toDataURL(); l.click();
            }
        },

        init: function() {
            this.bootSequence();
            database.ref('mit_database').on('value', s => { this.state.db = s.val() || this.defaultData; this.refreshUI(); });
            database.ref('online_users').on('value', s => { 
                this.state.onlineUsers = s.val() || {}; 
                if(document.getElementById('panel-chat').classList.contains('active')) this.renderChat();
                if(document.getElementById('panel-hr').classList.contains('active')) this.renderHR();
            });
            document.querySelectorAll('.nav-btn').forEach(b => b.addEventListener('click', ()=>SFX.click()));
        },

        bootSequence: function() {
            setTimeout(() => { document.getElementById('boot-screen').style.display='none'; document.getElementById('main-app').style.opacity='1'; }, 2500);
            this.updateClock(); setInterval(() => this.updateClock(), 1000);
        },

        login: function() {
            const p = document.getElementById('login-pass').value;
            const u = this.state.db.personnel.find(x => x.pass === p);
            if(u) {
                this.state.user = u;
                SFX.click();
                document.getElementById('login-modal').style.display='none';
                this.phone.init(u.id);
                // UI Güncelle
                document.getElementById('u-name').innerText = u.name;
                document.getElementById('u-code').innerText = "KOD: " + u.codename;
                document.getElementById('u-photo').src = `https://randomuser.me/api/portraits/${u.gender}/${u.photoId}.jpg`;
                document.getElementById('u-photo').style.display = 'block';
                document.getElementById('u-icon').style.display = 'none';
                const rInfo = ROLES[u.role] || ROLES['staff'];
                document.getElementById('u-role-disp').innerText = rInfo.label;
                document.getElementById('u-role-disp').style.color = rInfo.color;
                this.applyPerms();
                this.nav(u.role === 'admin' ? 'dashboard' : 'public');
            } else { SFX.error(); alert("Hatalı Kod"); }
        },

        applyPerms: function() {
            const perms = ROLES[this.state.user.role].perms;
            document.querySelectorAll('.nav-btn').forEach(b => {
                if(perms.includes(b.getAttribute('data-perm'))) b.classList.remove('disabled');
                else b.classList.add('disabled');
            });
        },

        nav: function(id) {
            document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('panel-'+id).classList.add('active');
            const btn = document.querySelector(`.nav-btn[data-perm="${id}"]`);
            if(btn) btn.classList.add('active');
            if(id==='map') setTimeout(() => { if(!this.map) { this.map = L.map('map').setView([39.92,32.85],6); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map); } }, 200);
            this.refreshUI();
        },

        refreshUI: function() {
            if(document.getElementById('panel-chat').classList.contains('active')) this.renderChat();
            if(document.getElementById('panel-public').classList.contains('active')) this.renderPublic();
            if(document.getElementById('panel-ops').classList.contains('active')) this.renderOps();
            if(document.getElementById('panel-hr').classList.contains('active')) this.renderHR();
            if(document.getElementById('panel-dashboard').classList.contains('active')) {
                document.getElementById('stat-staff').innerText = this.state.db.personnel.length;
                document.getElementById('stat-ops').innerText = (this.state.db.ops||[]).length;
            }
        },

        renderChat: function() {
            const w = document.getElementById('chat-window'); w.innerHTML='';
            (this.state.db.chat||[]).forEach(c => {
                const me = this.state.user && c.user === this.state.user.codename;
                w.innerHTML += `<div class="msg ${me?'msg-me':'msg-other'}"><span class="msg-sender">${c.user}</span>${c.msg}</div>`;
            });
            w.scrollTop = w.scrollHeight;
            
            const ul = document.getElementById('active-user-list'); ul.innerHTML='';
            this.state.db.personnel.forEach(p => {
                const isOnline = this.state.onlineUsers[p.id];
                const isMe = this.state.user && p.id === this.state.user.id;
                let btn = '';
                if(isOnline && !isMe) {
                    btn = `<button class="cyber-btn btn-small btn-green" onclick="app.phone.callUser('${isOnline.peerId}', '${p.codename}')"><i class="fas fa-phone"></i></button>`;
                }
                const op = isOnline ? 1 : 0.5;
                const dot = isOnline ? '<span class="status-online"></span>' : '<span class="user-status-dot"></span>';
                ul.innerHTML += `
                <div class="chat-user-card" style="opacity:${op}">
                    <div style="display:flex;align-items:center;">${dot}<span style="margin-left:10px; color:white;">${p.codename}</span></div>
                    ${btn}
                </div>`;
            });
        },
        
        sendChat: function() {
            const i=document.getElementById('chat-input'); const m=i.value; if(!m)return;
            if(!this.state.db.chat) this.state.db.chat=[];
            this.state.db.chat.push({user:this.state.user.codename, msg:m});
            this.save(); i.value='';
        },

        renderHR: function() {
            if(!this.state.user || this.state.user.role!=='admin') return;
            const b = document.getElementById('hr-table-body'); b.innerHTML='';
            this.state.db.personnel.forEach(p => {
                b.innerHTML += `<tr><td>${p.name}</td><td>${p.codename}</td><td>${p.role}</td></tr>`;
            });
            const al = document.getElementById('hr-apps-list'); al.innerHTML='';
            (this.state.db.apps||[]).forEach((a,i) => {
                al.innerHTML += `<div style="border:1px solid #333; padding:10px; margin-bottom:5px;">${a.name} (${a.skill}) <button class="cyber-btn btn-small" onclick="app.inspectApp(${i})">İNCELE</button></div>`;
            });
        },
        
        inspectApp: function(i) {
            this.state.viewingAppIdx = i;
            const a = this.state.db.apps[i];
            document.getElementById('app-view-content').innerHTML = `AD: ${a.name}<br>TC: ${a.tc}<br>1.SORU: ${a.exam.q1}<br>2.SORU: ${a.exam.q2}`;
            document.getElementById('app-view-modal').style.display='flex';
        },
        approveAppCurrent: function() {
            const idx=this.state.viewingAppIdx;
            const a=this.state.db.apps[idx];
            this.state.db.personnel.push({id:"AG-"+Math.floor(Math.random()*999), name:a.name, codename:"YENİ", role:'staff', pass:'1234', gender:a.gender, photoId:10});
            this.state.db.apps.splice(idx,1); this.save();
            document.getElementById('app-view-modal').style.display='none';
        },
        rejectAppCurrent: function() {
             this.state.db.apps.splice(this.state.viewingAppIdx,1); this.save();
             document.getElementById('app-view-modal').style.display='none';
        },

        renderPublic: function() {
            const d=document.getElementById('feed-public'); d.innerHTML='';
            (this.state.db.announcements||[]).forEach(a=>{ d.innerHTML+=`<div style="padding:10px; background:rgba(255,255,255,0.05); margin-bottom:10px; border-left:3px solid var(--accent);"><h3>${a.title}</h3><p>${a.msg}</p></div>`; });
        },
        renderOps: function() {
            const t=document.querySelector('#ops-table tbody'); t.innerHTML='';
            (this.state.db.ops||[]).forEach(o=>{ t.innerHTML+=`<tr><td>${o.name}</td><td>${o.lead}</td><td style="color:var(--accent)">${o.status}</td></tr>`; });
        },
        addOp: function() {
             const n=prompt("Kod Adı:");
             if(n) { if(!this.state.db.ops)this.state.db.ops=[]; this.state.db.ops.unshift({name:n, lead:this.state.user.codename, status:'AKTİF'}); this.save(); }
        },
        
        // BAŞVURU (Misafir)
        goToExam: function() { 
            if(!document.getElementById('app-tc').value) return alert("TC Giriniz");
            document.getElementById('app-step-1').style.display='none'; document.getElementById('app-step-2').style.display='block'; 
        },
        submitExam: function() {
            const form = {
                tc: document.getElementById('app-tc').value,
                name: document.getElementById('app-name').value,
                gender: document.getElementById('app-gender').value,
                skill: document.getElementById('app-skill').value,
                exam: { q1: document.getElementById('q1').value, q2: document.getElementById('q2').value }
            };
            if(!this.state.db.apps) this.state.db.apps=[];
            this.state.db.apps.push(form); this.save();
            alert("Başvuru Alındı"); location.reload();
        },

        save: function() { if(this.state.db) database.ref('mit_database').set(this.state.db); },
        updateClock: function() { document.getElementById('sys-clock').innerText = new Date().toLocaleTimeString(); },
        generateAIImage: function() {
            const p = document.getElementById('ai-prompt').value;
            const img = document.getElementById('ai-generated-img');
            img.style.display='none';
            if(p) { img.src=`https://image.pollinations.ai/prompt/${encodeURIComponent(p)}`; img.onload=()=>{img.style.display='block';} }
        },
        createCryptoMessage: function() {
            const t=document.getElementById('crypto-input').value;
            if(t) { document.getElementById('cyber-messages-list').innerHTML += `<div class="crypto-card" style="color:white;">${btoa(t)}</div>`; }
        }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
