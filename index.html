<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MİT | KIZIL ELMA SİBER SAVUNMA v45.0 (ROLE & CALL FIX)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;600;700&family=Courier+New:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-deep: #020202;
            --accent: #ff0000; 
            --accent-dim: #330000;
            --accent-glow: rgba(255, 0, 0, 0.35);
            --staff-blue: #00ccff;
            --admin-gold: #ffcc00;
            --cyber-green: #00ff41;
            --ai-purple: #bd00ff;
            --text-main: #e0e0e0;
        }

        body.defcon-5 { --accent: #00ff00; }
        body.defcon-4 { --accent: #ffff00; }
        body.defcon-3 { --accent: #ff8800; }
        body.defcon-1 { --accent: #ff0000; }

        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--accent) #111; }
        
        body { 
            background-color: var(--bg-deep);
            background-image: url('https://img.freepik.com/premium-photo/digital-world-map-hologram-blue-background_436667-178.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-main); font-family: 'Rajdhani', sans-serif;
            height: 100vh; overflow: hidden; user-select: none;
        }

        .overlay-bg { position: fixed; inset: 0; background: radial-gradient(circle, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.95) 100%); pointer-events: none; z-index: 0; }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.3; }

        /* BOOT SCREEN */
        #boot-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Share Tech Mono'; color: var(--accent); }
        .mit-logo-anim { width: 150px; height: 150px; background: url('https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png') no-repeat center/contain; filter: drop-shadow(0 0 20px red); animation: pulseLogo 2s infinite; margin-bottom: 20px; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; filter: drop-shadow(0 0 40px red); } }

        /* APP LAYOUT */
        .app-wrapper { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 10; opacity: 0; transition: opacity 1s; }
        header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--accent); backdrop-filter: blur(5px); }
        .workspace { display: flex; flex: 1; overflow: hidden; }
        aside { width: 280px; background: rgba(5,5,5,0.95); border-right: 1px solid #222; display: flex; flex-direction: column; padding: 10px 0; backdrop-filter: blur(10px); }
        main { flex: 1; padding: 20px; overflow-y: auto; position: relative; }

        /* COMPONENTS */
        .glass-box { background: rgba(10, 15, 20, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 4px; margin-bottom: 20px; border-left: 2px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        h2, h3 { font-family: 'Orbitron'; color: var(--accent); margin-bottom: 15px; letter-spacing: 1px; }

        .nav-btn { background: transparent; border: none; color: #888; padding: 12px 20px; text-align: left; cursor: pointer; font-family: 'Rajdhani'; font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 10px; width: 100%; transition: 0.2s; border-right: 3px solid transparent; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: linear-gradient(90deg, var(--accent-dim) 0%, transparent 100%); color: white; border-right-color: var(--accent); }
        .nav-btn.disabled { display: none !important; } /* Role based hide */

        .cyber-btn { background: rgba(0,0,0,0.4); border: 1px solid var(--accent); color: var(--accent); padding: 10px 20px; font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; font-weight: bold; text-transform: uppercase; }
        .cyber-btn:hover { background: var(--accent); color: black; box-shadow: 0 0 15px var(--accent); }
        .btn-small { padding: 5px 10px; font-size: 0.7rem; }
        .btn-green { border-color: var(--cyber-green); color: var(--cyber-green); } .btn-green:hover { background: var(--cyber-green); color: black; }

        input, textarea, select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 10px; color: white; font-family: 'Share Tech Mono'; margin-bottom: 10px; outline: none; }
        input:focus { border-color: var(--accent); }

        /* CHAT & CALL UI */
        .chat-container { display: grid; grid-template-columns: 1fr 260px; gap: 15px; height: 550px; }
        .chat-window { background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-inputs { display: flex; gap: 10px; margin-top: 10px; }
        .chat-sidebar { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; overflow-y: auto; }
        
        .chat-user-card { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 8px; border-bottom: 1px solid #222; transition: 0.2s; 
        }
        .chat-user-card:hover { background: rgba(255,255,255,0.05); }
        .user-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; margin-right: 8px; display: inline-block; }
        .status-online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }

        .msg { padding: 8px 12px; border-radius: 4px; max-width: 80%; font-size: 0.9rem; }
        .msg-me { background: var(--accent-dim); align-self: flex-end; border: 1px solid var(--accent); }
        .msg-other { background: #151515; align-self: flex-start; border: 1px solid #333; color: #ccc; }

        /* MODALS */
        #call-modal, #login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .call-pulse { width: 100px; height: 100px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; animation: pulseCall 1.5s infinite; margin-bottom: 20px; }
        @keyframes pulseCall { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 30px rgba(0,0,0,0); } }

        /* Tables */
        .cyber-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .cyber-table th { text-align: left; border-bottom: 1px solid var(--accent); padding: 8px; color: #888; }
        .cyber-table td { border-bottom: 1px solid #222; padding: 8px; }

        /* GEN BOX */
        .gen-result { background: rgba(0,0,0,0.8); border: 1px solid var(--staff-blue); padding: 15px; margin-top: 15px; font-family: 'Courier New'; display: none; }
    </style>
</head>
<body class="defcon-1">

    <div class="overlay-bg"></div>
    <div class="scanlines"></div>
    <div id="particles-js"></div>

    <div id="boot-screen">
        <div class="mit-logo-anim"></div>
        <h1>MİT <span style="color:var(--accent)">SİBER AĞ</span></h1>
        <div id="boot-text">SİSTEM BAŞLATILIYOR...</div>
        <div style="margin-top:20px; width:200px; height:2px; background:#333;"><div style="width:0%; height:100%; background:var(--accent); animation: load 2s forwards;"></div></div>
        <style>@keyframes load{to{width:100%}}</style>
    </div>

    <div id="call-modal" style="flex-direction: column;">
        <div class="call-pulse"><i class="fas fa-phone fa-3x" style="color:white"></i></div>
        <h2 id="call-status" style="color:white;">ARANIYOR...</h2>
        <p id="call-name" style="color:var(--staff-blue); margin-bottom: 20px; font-size: 1.2rem;">HEDEF</p>
        <div id="call-actions">
            <button class="cyber-btn btn-green" id="btn-answer" onclick="app.phone.answer()" style="display:none;">CEVAPLA</button>
            <button class="cyber-btn" style="border-color:red; color:red;" onclick="app.phone.hangup()">KAPAT</button>
        </div>
        <div id="call-timer" style="display:none; font-size: 2rem; margin-top: 10px; font-family: 'Share Tech Mono';">00:00</div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <div id="login-modal" style="display: flex;">
        <div class="glass-box" style="width: 400px; text-align: center;">
            <i class="fas fa-shield-alt fa-3x" style="color: var(--accent); margin-bottom: 15px;"></i>
            <h3>GÜVENLİK PROTOKOLÜ v45</h3>
            <p style="color:#666; font-size: 0.8rem; margin-bottom: 15px;">YETKİ SEVİYENİZE GÖRE PANEL AÇILACAKTIR.</p>
            <input type="password" id="login-pass" placeholder="ERİŞİM KODU" style="text-align: center; letter-spacing: 5px;">
            <button class="cyber-btn" style="width: 100%;" onclick="app.login()">GİRİŞ</button>
            <div style="margin-top: 15px; font-size: 0.7rem; color: #444;">
                <p>ADM-001 (Admin): TURAN</p>
                <p>SIB-002 (Siber): KOD123</p>
                <p>SAH-003 (Saha): OPERASYON</p>
                <p>STF-004 (Personel): 1234</p>
            </div>
        </div>
    </div>

    <div class="app-wrapper" id="main-app">
        <header>
            <div style="display:flex; align-items:center; gap:15px;">
                <img src="https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png" height="50">
                <div>
                    <h1 style="font-size:1.5rem; line-height:1;">KIZIL ELMA <span style="color:var(--accent); font-size:0.8rem;">v45.0</span></h1>
                    <small style="color:#666;">YETKİ TABANLI ERİŞİM SİSTEMİ</small>
                </div>
            </div>
            <div style="text-align:right;">
                <div id="u-role-disp" style="color: var(--admin-gold); font-weight: bold;">MİSAFİR</div>
                <div id="sys-clock" style="font-family:'Share Tech Mono'; color: #888;">00:00:00</div>
            </div>
        </header>

        <div class="workspace">
            <aside>
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #222;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--accent); margin: 0 auto 10px; overflow: hidden;">
                        <img id="u-img" src="https://randomuser.me/api/portraits/men/33.jpg" style="width:100%; height:100%;">
                    </div>
                    <div id="u-name">Misafir</div>
                    <small id="u-code" style="color:var(--staff-blue);">---</small>
                </div>

                <div id="nav-container">
                    <button class="nav-btn" data-perm="public" onclick="app.nav('public')"><i class="fas fa-globe"></i> Duyurular</button>
                    <button class="nav-btn" data-perm="dashboard" onclick="app.nav('dashboard')"><i class="fas fa-th"></i> Komuta</button>
                    <button class="nav-btn" data-perm="chat" onclick="app.nav('chat')"><i class="fas fa-comments"></i> Güvenli Hat</button>
                    <button class="nav-btn" data-perm="ops" onclick="app.nav('ops')"><i class="fas fa-crosshairs"></i> Operasyon</button>
                    <button class="nav-btn" data-perm="cyber" onclick="app.nav('cyber')"><i class="fas fa-code"></i> Siber / Kripto</button>
                    <button class="nav-btn" data-perm="ai" onclick="app.nav('ai')"><i class="fas fa-brain"></i> Y.Z. Görüntü</button>
                    <button class="nav-btn" data-perm="gen" onclick="app.nav('gen')" style="color:#ffaa00;"><i class="fas fa-id-card"></i> Kimlik Üretici</button>
                    <button class="nav-btn" data-perm="reports" onclick="app.nav('reports')"><i class="fas fa-file-contract"></i> Raporlar</button>
                    <button class="nav-btn" data-perm="hr" onclick="app.nav('hr')"><i class="fas fa-users"></i> Personel</button>
                </div>

                <button class="nav-btn" onclick="location.reload()" style="margin-top: auto; color: var(--accent);"><i class="fas fa-power-off"></i> ÇIKIŞ</button>
            </aside>

            <main>
                <div id="panel-public" class="panel active">
                    <div class="glass-box"><h2>DUYURULAR</h2><div id="feed-public">Yükleniyor...</div></div>
                </div>

                <div id="panel-dashboard" class="panel">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div class="glass-box" style="text-align:center;">
                            <h3>TEHDİT SEVİYESİ</h3>
                            <h1 id="defcon-disp" style="font-size: 3rem; color: var(--accent);">1</h1>
                        </div>
                        <div class="glass-box" style="text-align:center;"><h3>PERSONEL</h3><h1 id="stat-staff">0</h1></div>
                        <div class="glass-box" style="text-align:center;"><h3>AKTİF GÖREV</h3><h1 id="stat-ops">0</h1></div>
                    </div>
                    <div class="glass-box" style="padding:0; height: 400px;"><div id="map" style="height:100%;"></div></div>
                </div>

                <div id="panel-chat" class="panel">
                    <div class="glass-box">
                        <h2 style="text-align:center; color: var(--staff-blue);">GÜVENLİ İLETİŞİM HATTI</h2>
                        <div class="chat-container">
                            <div style="display:flex; flex-direction:column; height:100%;">
                                <div id="chat-window" class="chat-window"></div>
                                <div class="chat-inputs">
                                    <input id="chat-input" placeholder="Mesajınızı yazın...">
                                    <button class="cyber-btn" onclick="app.chat.send()">GÖNDER</button>
                                </div>
                            </div>
                            <div class="chat-sidebar">
                                <h4 style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:5px;">AKTİF PERSONEL</h4>
                                <div id="active-user-list">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-ops" class="panel">
                    <div class="glass-box">
                        <div style="display:flex; justify-content:space-between;">
                            <h2>OPERASYONLAR</h2>
                            <button class="cyber-btn btn-small" onclick="app.ops.add()">+ YENİ</button>
                        </div>
                        <table class="cyber-table" id="table-ops"><thead><tr><th>KOD</th><th>LİDER</th><th>DURUM</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>

                <div id="panel-cyber" class="panel">
                    <div class="glass-box" style="border-color: var(--cyber-green);">
                        <h2 style="color: var(--cyber-green);">KRİPTO MERKEZİ</h2>
                        <input id="crypto-in" placeholder="Mesaj...">
                        <button class="cyber-btn btn-green" onclick="app.cyber.encrypt()">ŞİFRELE & GÖNDER</button>
                        <div id="crypto-list" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <div id="panel-ai" class="panel">
                    <div class="glass-box" style="border-color: var(--ai-purple);">
                        <h2 style="color: var(--ai-purple);">GÖRÜNTÜ İSTİHBARATI (AI)</h2>
                        <input id="ai-prompt" placeholder="Görüntü tanımı (örn: satellite view of istanbul)...">
                        <button class="cyber-btn" style="border-color: var(--ai-purple); color: var(--ai-purple);" onclick="app.ai.gen()">OLUŞTUR</button>
                        <div id="ai-result" style="margin-top: 20px; text-align: center;"></div>
                    </div>
                </div>

                <div id="panel-gen" class="panel">
                    <div class="glass-box" style="border-color: #ffaa00;">
                        <h2 style="color: #ffaa00;">GİZLİ KİMLİK OLUŞTURUCU</h2>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Cinsiyet</label><select id="gen-sex"><option value="men">Erkek</option><option value="women">Kadın</option></select>
                                <button class="cyber-btn" onclick="app.gen.create()" style="color:#ffaa00; border-color:#ffaa00;">ÜRET</button>
                                <div id="gen-text" class="gen-result"></div>
                            </div>
                            <canvas id="gen-canvas" width="500" height="300" style="width:100%; border:1px solid #333;"></canvas>
                        </div>
                    </div>
                </div>

                <div id="panel-reports" class="panel">
                    <div class="glass-box">
                        <h2>RAPOR HAVUZU</h2>
                        <input id="rep-sub" placeholder="Konu"><textarea id="rep-bod" placeholder="Detay"></textarea>
                        <button class="cyber-btn" onclick="app.reports.send()">GÖNDER</button>
                        <div id="rep-list" style="margin-top:20px;"></div>
                    </div>
                </div>

                <div id="panel-hr" class="panel">
                    <div class="glass-box">
                        <h2>PERSONEL LİSTESİ (HR)</h2>
                        <table class="cyber-table" id="table-hr"><tbody></tbody></table>
                    </div>
                </div>

            </main>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    // --- CONF ---
    const firebaseConfig = { apiKey: "AIzaSyD4mXN8BZ3OMzl35vtEbNGA9BUuHPgoqQU", authDomain: "mit-sistemi.firebaseapp.com", databaseURL: "https://mit-sistemi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "mit-sistemi", storageBucket: "mit-sistemi.firebasestorage.app", messagingSenderId: "195453377116", appId: "1:195453377116:web:85067f5070ecf983bb6499" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ROL VE YETKİ MATRİSİ (PERMISSION MATRIX) ---
    // Her rolün hangi panellere ve aksiyonlara erişebileceği burada tanımlanır.
    const ROLES = {
        admin: {
            label: 'YÖNETİCİ',
            color: '#ffcc00',
            perms: ['public', 'dashboard', 'chat', 'ops', 'cyber', 'ai', 'gen', 'reports', 'hr', 'call', 'admin_ops'] 
        },
        cyber: {
            label: 'SİBER UZMAN',
            color: '#00ff41',
            perms: ['public', 'chat', 'cyber', 'ai', 'gen', 'call'] // Ops ve HR yok
        },
        agent: {
            label: 'SAHA AJANI',
            color: '#00ccff',
            perms: ['public', 'chat', 'ops', 'reports', 'gen', 'call'] // Cyber ve AI yok
        },
        staff: {
            label: 'PERSONEL',
            color: '#ffffff',
            perms: ['public', 'chat'] // Sadece chat ve duyuru
        }
    };

    const SFX = {
        play: (freq, type) => {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const o=ctx.createOscillator(), g=ctx.createGain();
            o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.1);
            o.stop(ctx.currentTime+0.1);
        },
        click: () => SFX.play(1200, 'sine'),
        error: () => SFX.play(150, 'sawtooth'),
        ring: () => {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const o=ctx.createOscillator(), g=ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.frequency.setValueAtTime(800, ctx.currentTime);
            o.frequency.setValueAtTime(600, ctx.currentTime+0.4);
            o.start(); o.stop(ctx.currentTime+0.8);
        }
    };

    const app = {
        user: null,
        data: { personnel: [], chat: [], ops: [] },
        online: {},
        peer: null,
        call: null,
        
        init: function() {
            setTimeout(() => { document.getElementById('boot-screen').style.display='none'; }, 2500);
            
            // Firebase Listeners
            db.ref('mit_database').on('value', s => {
                const val = s.val() || {};
                this.data = val;
                if(!this.data.personnel) this.data.personnel = [
                    {id:'ADM-001', name:'Hakan F.', codename:'KARTAL', role:'admin', pass:'TURAN'},
                    {id:'SIB-002', name:'Zeynep K.', codename:'MATRIX', role:'cyber', pass:'KOD123'},
                    {id:'SAH-003', name:'Burak Y.', codename:'ATMACA', role:'agent', pass:'OPERASYON'},
                    {id:'STF-004', name:'Mehmet', codename:'MEMUR', role:'staff', pass:'1234'}
                ];
                this.refreshUI();
            });

            db.ref('online_users').on('value', s => {
                this.online = s.val() || {};
                this.chat.renderList();
            });
            
            setInterval(() => document.getElementById('sys-clock').innerText = new Date().toLocaleTimeString(), 1000);
        },

        // --- GİRİŞ VE YETKİ KONTROLÜ ---
        login: function() {
            const p = document.getElementById('login-pass').value;
            const u = this.data.personnel.find(x => x.pass === p);
            
            if(u) {
                this.user = u;
                SFX.click();
                document.getElementById('login-modal').style.display = 'none';
                
                // UI Güncelle
                document.getElementById('u-name').innerText = u.name;
                document.getElementById('u-code').innerText = u.codename;
                const rInfo = ROLES[u.role];
                document.getElementById('u-role-disp').innerText = rInfo.label;
                document.getElementById('u-role-disp').style.color = rInfo.color;
                
                // PEERJS (Telefon) Başlat
                const pid = u.id + "_" + Math.floor(Math.random()*9999);
                this.peer = new Peer(pid);
                this.peer.on('open', id => {
                    db.ref('online_users/'+u.id).set({peerId: id, name: u.codename, role: u.role});
                    db.ref('online_users/'+u.id).onDisconnect().remove();
                });
                this.peer.on('call', call => this.phone.incoming(call));

                // Yetkiye Göre Menüyü Düzenle
                this.applyPermissions();
                this.nav('public'); // Varsayılan sayfa
            } else {
                SFX.error();
                alert("HATALI KOD!");
            }
        },

        applyPermissions: function() {
            const userPerms = ROLES[this.user.role].perms;
            const navBtns = document.querySelectorAll('#nav-container .nav-btn');
            
            navBtns.forEach(btn => {
                const reqPerm = btn.getAttribute('data-perm');
                if(userPerms.includes(reqPerm)) {
                    btn.classList.remove('disabled');
                } else {
                    btn.classList.add('disabled');
                }
            });
        },

        hasPerm: function(p) {
            return this.user && ROLES[this.user.role].perms.includes(p);
        },

        nav: function(p) {
            document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            
            document.getElementById('panel-'+p).classList.add('active');
            const btn = document.querySelector(`.nav-btn[data-perm="${p}"]`);
            if(btn) btn.classList.add('active');
            
            if(p==='dashboard') this.dashboard.render();
            SFX.click();
        },

        // --- TELEFON SİSTEMİ (ÖZEL ARAMA) ---
        phone: {
            incoming: function(call) {
                app.call = call;
                document.getElementById('call-modal').style.display = 'flex';
                document.getElementById('btn-answer').style.display = 'inline-block';
                document.getElementById('call-status').innerText = "GELEN ARAMA";
                // Zil sesi
                this.ringInt = setInterval(SFX.ring, 2000);
            },
            callUser: function(peerId, name) {
                if(!peerId) return alert("Kullanıcı hatta değil.");
                navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
                    const call = app.peer.call(peerId, stream);
                    app.phone.setupUI(call, name);
                }).catch(e => alert("Mikrofon izni yok: "+e));
            },
            answer: function() {
                clearInterval(this.ringInt);
                navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
                    app.call.answer(stream);
                    app.phone.setupUI(app.call, "Bilinmeyen");
                });
            },
            setupUI: function(call, name) {
                app.call = call;
                document.getElementById('call-modal').style.display = 'flex';
                document.getElementById('btn-answer').style.display = 'none';
                document.getElementById('call-status').innerText = "BAĞLANDI";
                document.getElementById('call-name').innerText = name;
                document.getElementById('call-timer').style.display = 'block';
                
                call.on('stream', remote => {
                    document.getElementById('remote-audio').srcObject = remote;
                });
                call.on('close', () => app.phone.hangup());
            },
            hangup: function() {
                if(app.call) app.call.close();
                document.getElementById('call-modal').style.display = 'none';
                clearInterval(this.ringInt);
                location.reload(); // Temizle
            }
        },

        // --- CHAT SİSTEMİ ---
        chat: {
            renderList: function() {
                const div = document.getElementById('active-user-list');
                div.innerHTML = '';
                
                app.data.personnel.forEach(p => {
                    const isOnline = app.online[p.id];
                    const isMe = app.user && p.id === app.user.id;
                    
                    let statusDot = isOnline ? 'status-online' : '';
                    let opacity = isOnline ? 1 : 0.5;
                    
                    // ARAMA BUTONU EKLENDİ (BURASI DÜZELTİLDİ)
                    let callBtn = '';
                    if(isOnline && !isMe && app.hasPerm('call')) {
                        callBtn = `<button class="cyber-btn btn-small btn-green" onclick="app.phone.callUser('${isOnline.peerId}', '${p.codename}')"><i class="fas fa-phone"></i></button>`;
                    }

                    div.innerHTML += `
                        <div class="chat-user-card" style="opacity:${opacity}">
                            <div style="display:flex; align-items:center;">
                                <span class="user-status-dot ${statusDot}"></span>
                                <div>
                                    <strong style="color:white; font-size:0.9rem;">${p.codename}</strong>
                                    <div style="font-size:0.7rem; color:#666;">${ROLES[p.role].label}</div>
                                </div>
                            </div>
                            <div>${callBtn}</div>
                        </div>
                    `;
                });
            },
            send: function() {
                const inp = document.getElementById('chat-input');
                const msg = inp.value;
                if(!msg) return;
                const newMsg = { user: app.user.codename, text: msg, time: Date.now() };
                const list = app.data.chat || [];
                list.push(newMsg);
                if(list.length > 50) list.shift();
                db.ref('mit_database/chat').set(list);
                inp.value = '';
            }
        },

        // --- DİĞER FONKSİYONLAR ---
        dashboard: {
            render: function() {
                document.getElementById('stat-staff').innerText = app.data.personnel.length;
                document.getElementById('stat-ops').innerText = (app.data.ops || []).length;
                // Harita (Leaflet)
                if(!this.map) {
                    this.map = L.map('map').setView([39.93, 32.85], 6);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map);
                }
            }
        },
        cyber: {
            encrypt: function() {
                const t = document.getElementById('crypto-in').value;
                if(!t) return;
                const enc = btoa(t).split('').reverse().join(''); // Basit şifreleme
                const l = document.getElementById('crypto-list');
                l.innerHTML = `<div style="border:1px solid var(--cyber-green); padding:10px; margin-top:5px; color:var(--cyber-green);">Encrypted: ${enc}</div>` + l.innerHTML;
                document.getElementById('crypto-in').value = '';
            }
        },
        ops: {
            add: function() {
                const code = prompt("Operasyon Kod Adı:");
                if(code) {
                    const list = app.data.ops || [];
                    list.push({code: code, lead: app.user.codename, status: 'AKTİF'});
                    db.ref('mit_database/ops').set(list);
                }
            }
        },
        gen: {
            create: function() {
                const sex = document.getElementById('gen-sex').value;
                const names = sex==='men' ? ['AHMET','MEHMET','ALİ','CAN'] : ['AYŞE','FATMA','ZEYNEP','ELİF'];
                const surn = ['YILMAZ','DEMİR','KAYA','ÇELİK'];
                const name = names[Math.floor(Math.random()*names.length)] + ' ' + surn[Math.floor(Math.random()*surn.length)];
                const tc = Math.floor(10000000000 + Math.random() * 90000000000);
                
                document.getElementById('gen-text').style.display='block';
                document.getElementById('gen-text').innerHTML = `TC: ${tc}<br>AD SOYAD: ${name}<br>DURUM: OLUŞTURULDU`;
                
                // Canvas Çizim
                const cvs = document.getElementById('gen-canvas');
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = "#111"; ctx.fillRect(0,0,500,300);
                ctx.fillStyle = "#e30a17"; ctx.fillRect(0,0,500,50);
                ctx.fillStyle = "white"; ctx.font = "20px Arial"; ctx.fillText("TÜRKİYE CUMHURİYETİ", 140, 35);
                ctx.font = "16px monospace"; ctx.fillText("TC: "+tc, 20, 100);
                ctx.font = "24px Arial"; ctx.fillText(name, 20, 150);
                ctx.strokeStyle = "gold"; ctx.strokeRect(350, 80, 120, 150);
                ctx.font = "12px monospace"; ctx.fillText("GİZLİ BELGE", 370, 160);
            }
        },
        ai: {
            gen: function() {
                const p = document.getElementById('ai-prompt').value;
                const r = document.getElementById('ai-result');
                r.innerHTML = "Görüntü işleniyor...";
                setTimeout(() => {
                    r.innerHTML = `<img src="https://image.pollinations.ai/prompt/${encodeURIComponent(p)}" style="max-width:100%; border:2px solid var(--ai-purple);">`;
                }, 2000);
            }
        },
        reports: {
            send: function() {
                alert("Rapor havuza iletildi.");
            }
        },

        refreshUI: function() {
            // Chat
            const w = document.getElementById('chat-window');
            w.innerHTML = '';
            (this.data.chat || []).forEach(m => {
                const isMe = app.user && m.user === app.user.codename;
                w.innerHTML += `<div class="msg ${isMe?'msg-me':'msg-other'}"><b>${m.user}:</b> ${m.text}</div>`;
            });
            w.scrollTop = w.scrollHeight;
            this.chat.renderList();

            // Ops
            const t = document.querySelector('#table-ops tbody');
            t.innerHTML = '';
            (this.data.ops || []).forEach(o => {
                t.innerHTML += `<tr><td>${o.code}</td><td>${o.lead}</td><td style="color:var(--accent)">${o.status}</td></tr>`;
            });

            // HR
            const h = document.querySelector('#table-hr tbody');
            h.innerHTML = '';
            this.data.personnel.forEach(p => {
                h.innerHTML += `<tr><td>${p.codename}</td><td>${ROLES[p.role].label}</td></tr>`;
            });
            
            // Duyurular
            document.getElementById('feed-public').innerHTML = 
                `<div style="padding:10px; background:rgba(255,255,255,0.1); border-left:3px solid var(--accent);">
                    <h3>SİSTEM GÜNCELLEMESİ v45.0</h3>
                    <p>Yetki sistemi aktif edildi. Sesli görüşme protokolü düzeltildi.</p>
                </div>`;
        }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
