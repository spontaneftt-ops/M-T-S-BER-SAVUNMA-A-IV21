<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MİT | KIZIL ELMA SİBER SAVUNMA v36.0 (STABLE)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --hue: 0; /* Defcon 1 Kırmızısı */
            --bg-deep: #020202;
            --bg-panel: rgba(10, 11, 14, 0.96);
            --accent: hsl(var(--hue), 100%, 50%); 
            --accent-dim: hsl(var(--hue), 100%, 20%);
            --accent-glow: hsla(var(--hue), 100%, 50%, 0.35);
            --staff-blue: #00ccff;
            --admin-gold: #ffcc00;
            --cyber-green: #00ff41;
            --ai-purple: #bd00ff;
            --text-main: #e0e0e0;
        }

        /* DEFCON RENK DEĞİŞİMLERİ */
        body.defcon-5 { --hue: 120; } /* Yeşil */
        body.defcon-4 { --hue: 60; }  /* Sarı */
        body.defcon-3 { --hue: 30; }  /* Turuncu */
        body.defcon-1 { --hue: 0; }   /* Kırmızı */

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh; overflow: hidden; user-select: none;
        }

        /* --- ÖNEMLİ DÜZELTME: PANEL GİZLEME MANTIĞI --- */
        .panel { 
            display: none !important; /* Varsayılan olarak hepsi gizli */
            height: 100%;
            overflow-y: auto;
        }
        .panel.active { 
            display: block !important; /* Sadece aktif olan görünür */
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BOOT SCREEN */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            font-family: 'Share Tech Mono'; color: var(--accent); padding: 50px;
            display: flex; flex-direction: column; justify-content: flex-start;
            font-size: 1.2rem;
        }

        .app-wrapper { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 10; opacity: 1; }
        
        header {
            height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            background: rgba(5, 0, 0, 0.95); border-bottom: 3px solid var(--accent);
            box-shadow: 0 0 30px var(--accent-glow); z-index: 100;
        }

        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        aside {
            width: 280px; background: #050505; border-right: 1px solid #222;
            display: flex; flex-direction: column; padding: 20px 0;
            flex-shrink: 0;
        }

        main { flex: 1; padding: 30px; overflow-y: auto; background: rgba(0,0,0,0.4); position: relative; }

        .glass-box {
            background: var(--bg-panel); border: 1px solid #333; padding: 25px; 
            border-radius: 4px; margin-bottom: 25px; position: relative; 
            border-left: 2px solid var(--accent);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        
        h2, h3 { font-family: 'Orbitron'; color: var(--accent); margin-bottom: 15px; letter-spacing: 2px; }

        .nav-btn {
            background: transparent; border: none; color: #888; padding: 15px 25px;
            text-align: left; cursor: pointer; font-family: 'Rajdhani'; font-weight: 600; font-size: 1.1rem;
            display: flex; align-items: center; gap: 15px; transition: 0.3s; width: 100%;
            border-right: 3px solid transparent;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-main); }
        .nav-btn.active { background: var(--accent-dim); color: white; border-right-color: var(--accent); }

        input, textarea, select {
            width: 100%; background: #0a0a0a; border: 1px solid #333; padding: 12px;
            color: white; font-family: 'Share Tech Mono'; margin-bottom: 15px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .cyber-btn {
            width: 100%; background: transparent; border: 1px solid var(--accent);
            color: var(--accent); padding: 12px; font-family: 'Orbitron'; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;
        }
        .cyber-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent); }
        .cyber-btn.btn-small { width: auto; padding: 5px 15px; font-size: 0.8rem; margin-right: 5px; }

        .table-container { overflow-x: auto; }
        .cyber-table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        .cyber-table th { text-align: left; border-bottom: 1px solid var(--accent); padding: 10px; color: #aaa; }
        .cyber-table td { padding: 10px; border-bottom: 1px solid #222; font-family: 'Share Tech Mono'; }

        /* MODALS */
        #login-modal, #hack-modal, #lockdown-screen { 
            position: fixed; inset: 0; z-index: 2000; 
            align-items: center; justify-content: center; 
            backdrop-filter: blur(10px); background: rgba(0,0,0,0.9); 
            display: none; 
        }

        /* Responsive Fixes */
        @media screen and (max-width: 900px) {
            header { flex-direction: column; height: auto; padding: 15px; text-align: center; }
            .workspace { flex-direction: column; overflow: auto; }
            aside { width: 100%; border-right: none; border-bottom: 1px solid #333; overflow-x: auto; }
            #menu-guest, #menu-staff { display: flex !important; flex-direction: row; }
            main { overflow: visible; }
            div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body class="defcon-1">

    <div id="boot-screen">
        <div id="boot-text">
            SYSTEM BOOT SEQUENCE INITIATED...<br>
            LOADING KERNEL... SUCCESS<br>
            MOUNTING FILE SYSTEM... SUCCESS<br>
            CHECKING FIREBASE UPLINK... <span id="boot-net-status">WAITING</span>
        </div>
    </div>

    <div id="lockdown-screen">
        <i class="fas fa-biohazard fa-5x" style="color:red; margin-bottom:20px;"></i>
        <h1 style="font-size:3rem; color:red;">SİSTEM KİLİTLENDİ</h1>
        <p>YETKİSİZ ERİŞİM TESPİTİ</p>
        <button class="cyber-btn" style="width:200px; margin-top:20px;" onclick="location.reload()">YENİDEN BAŞLAT</button>
    </div>

    <div class="app-wrapper">
        <header>
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png" height="50">
                <div>
                    <h1 style="font-family:'Orbitron'; font-size:1.5rem; color:white;">MİT <span style="color:var(--accent)">KIZIL ELMA</span></h1>
                    <small style="color:#aaa;">SİBER SAVUNMA AĞI v36.0</small>
                </div>
            </div>
            <div style="text-align:right;">
                <div id="sys-clock" style="font-family:'Share Tech Mono'; font-size:1.2rem; color:white;">00:00:00</div>
                <div id="connection-indicator" style="font-size:0.8rem; color:var(--accent);">BAĞLANTI KONTROL EDİLİYOR</div>
            </div>
        </header>

        <div class="workspace">
            <aside>
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #333; margin-bottom: 10px;">
                    <i class="fas fa-user-secret fa-2x" style="color:white; margin-bottom:10px;"></i>
                    <h3 id="u-name" style="font-size:1rem; margin:0;">MİSAFİR</h3>
                    <p id="u-role" style="font-size:0.7rem; color:#666;">ERİŞİM KISITLI</p>
                </div>

                <div id="menu-guest">
                    <button class="nav-btn active" onclick="app.nav('public')"><i class="fas fa-globe"></i> Duyurular</button>
                    <button class="nav-btn" onclick="app.nav('basvuru')"><i class="fas fa-user-plus"></i> Başvuru</button>
                    <button class="nav-btn" onclick="app.showLogin()" style="color:var(--accent);"><i class="fas fa-fingerprint"></i> Personel Girişi</button>
                </div>

                <div id="menu-staff" style="display:none;">
                    <button class="nav-btn active" onclick="app.nav('dashboard')"><i class="fas fa-th"></i> Komuta Paneli</button>
                    <button class="nav-btn" onclick="app.nav('reports')"><i class="fas fa-file-contract"></i> Raporlar</button>
                    <button class="nav-btn" onclick="app.nav('ops')"><i class="fas fa-crosshairs"></i> Operasyon</button>
                    <button class="nav-btn" onclick="app.nav('chat')"><i class="fas fa-comments"></i> Güvenli Chat</button>
                    <button id="nav-cyber" class="nav-btn" onclick="app.nav('cyber')" style="display:none; color:var(--cyber-green);"><i class="fas fa-code"></i> SİBER</button>
                    <button class="nav-btn" onclick="app.nav('hr')"><i class="fas fa-users"></i> Personel/GBT</button>
                    <button class="nav-btn" onclick="app.logout()" style="color:var(--accent);"><i class="fas fa-power-off"></i> Çıkış</button>
                </div>
            </aside>

            <main>
                <div id="panel-public" class="panel active">
                    <div class="glass-box">
                        <h2><i class="fas fa-bullhorn"></i> RESMİ DUYURULAR</h2>
                        <div id="feed-public">Yükleniyor...</div>
                    </div>
                    <div class="glass-box">
                        <h3>ARANANLAR LİSTESİ</h3>
                        <div class="table-container">
                            <table class="cyber-table" id="wanted-table">
                                <thead><tr><th>KOD ADI</th><th>SUÇ</th><th>DURUM</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="panel-basvuru" class="panel">
                    <div class="glass-box" style="max-width:600px; margin:0 auto;">
                        <h2 style="text-align:center;">AKADEMİ BAŞVURU</h2>
                        <div id="app-form-step1">
                            <label>TC Kimlik No</label><input id="app-tc" maxlength="11">
                            <label>Ad Soyad</label><input id="app-name">
                            <label>Branş Tercihi</label>
                            <select id="app-skill">
                                <option value="siber">Siber İstihbarat</option>
                                <option value="saha">Saha Operasyon</option>
                                <option value="analiz">Analiz</option>
                            </select>
                            <button class="cyber-btn" onclick="app.submitApp()">BAŞVURUYU GÖNDER</button>
                        </div>
                    </div>
                </div>

                <div id="panel-dashboard" class="panel">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:20px;">
                        <div class="glass-box" style="text-align:center;">
                            <small>TEHDİT SEVİYESİ</small>
                            <h1 id="defcon-disp" style="font-size:3rem; margin-top:5px;">1</h1>
                            <div id="defcon-controls" style="display:none; justify-content:center; gap:5px;">
                                <button class="cyber-btn btn-small" onclick="app.setDefcon(5)">5</button>
                                <button class="cyber-btn btn-small" onclick="app.setDefcon(1)">1</button>
                            </div>
                        </div>
                        <div class="glass-box" style="text-align:center;">
                            <small>AKTİF PERSONEL</small>
                            <h1 id="stat-staff" style="color:white;">0</h1>
                        </div>
                        <div class="glass-box" style="text-align:center;">
                            <small>OPERASYONLAR</small>
                            <h1 id="stat-ops" style="color:var(--staff-blue);">0</h1>
                        </div>
                    </div>
                    <div class="glass-box">
                        <h3>CANLI SİSTEM LOGLARI</h3>
                        <div id="dash-logs" style="height:200px; overflow-y:auto; font-size:0.8rem; color:#888;"></div>
                    </div>
                </div>

                <div id="panel-cyber" class="panel">
                    <div class="glass-box" style="border-color:var(--cyber-green);">
                        <h2 style="color:var(--cyber-green);">SİBER SAVAŞ MERKEZİ</h2>
                        <div id="cyber-content">
                            <p>Kriptolu mesajlar ve siber saldırı araçları burada görüntülenir.</p>
                            <div id="cyber-msg-list"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-hr" class="panel">
                    <div class="glass-box">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>PERSONEL LİSTESİ</h3>
                            <button class="cyber-btn btn-small" onclick="app.renderHR()">YENİLE</button>
                        </div>
                        <div class="table-container">
                            <table class="cyber-table" id="hr-table">
                                <thead><tr><th>İSİM</th><th>KOD</th><th>ROL</th><th>DURUM</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="admin-tools" class="glass-box" style="display:none; border-color:var(--admin-gold);">
                        <h3 style="color:var(--admin-gold);">YÖNETİCİ ARAÇLARI</h3>
                        <input id="ann-text" placeholder="Duyuru metni...">
                        <button class="cyber-btn btn-gold" onclick="app.postAnnounce()">DUYURU YAYINLA</button>
                    </div>
                </div>

                <div id="panel-chat" class="panel">
                    <div class="glass-box" style="height:calc(100% - 20px); display:flex; flex-direction:column;">
                        <h3>GÜVENLİ HAT</h3>
                        <div id="chat-window" style="flex:1; border:1px solid #333; margin-bottom:10px; padding:10px; overflow-y:auto; background:rgba(0,0,0,0.5);"></div>
                        <div style="display:flex; gap:10px;">
                            <input id="chat-input" placeholder="Mesajınız...">
                            <button class="cyber-btn" style="width:100px;" onclick="app.sendChat()">GÖNDER</button>
                        </div>
                    </div>
                </div>
                 <div id="panel-ops" class="panel">
                    <div class="glass-box">
                        <h3>OPERASYON LİSTESİ</h3>
                        <div class="table-container">
                            <table class="cyber-table" id="ops-table">
                                <thead><tr><th>GÖREV ADI</th><th>LİDER</th><th>DURUM</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="ops-admin" style="margin-top:20px; display:none;">
                             <input id="op-name" placeholder="Operasyon Adı">
                             <button class="cyber-btn" onclick="app.addOp()">GÖREV BAŞLAT</button>
                        </div>
                    </div>
                </div>
                 <div id="panel-reports" class="panel">
                    <div class="glass-box">
                        <h3>RAPOR HAVUZU</h3>
                        <div id="reports-list"></div>
                        <hr style="border-color:#333; margin:20px 0;">
                        <h4>RAPOR OLUŞTUR</h4>
                        <input id="rep-title" placeholder="Rapor Başlığı">
                        <textarea id="rep-content" rows="5" placeholder="İçerik..."></textarea>
                        <button class="cyber-btn" onclick="app.sendReport()">GÖNDER</button>
                    </div>
                </div>


            </main>
        </div>
    </div>

    <div id="login-modal">
        <div class="glass-box" style="width:400px; text-align:center;">
            <i class="fas fa-lock fa-3x" style="color:var(--accent); margin-bottom:20px;"></i>
            <h3>GÜVENLİK GİRİŞİ</h3>
            <input type="password" id="login-pass" placeholder="ERİŞİM ŞİFRESİ" style="text-align:center; letter-spacing:5px;">
            <button class="cyber-btn" onclick="app.login()">GİRİŞ YAP</button>
            <button class="nav-btn" style="text-align:center; justify-content:center; margin-top:10px;" onclick="document.getElementById('login-modal').style.display='none'">İPTAL</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        /* --- VERİTABANI VE AYARLAR --- */
        const firebaseConfig = {
            apiKey: "AIzaSyD4mXN8BZ3OMzl35vtEbNGA9BUuHPgoqQU", // Mevcut API anahtarınız
            authDomain: "mit-sistemi.firebaseapp.com",
            databaseURL: "https://mit-sistemi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mit-sistemi",
            storageBucket: "mit-sistemi.firebasestorage.app",
            messagingSenderId: "195453377116",
            appId: "1:195453377116:web:85067f5070ecf983bb6499"
        };

        // Varsayılan Veriler (Offline Mode için)
        const defaultData = {
            defcon: 1,
            announcements: [
                { title: "SİSTEM BAŞLATILDI", msg: "Kızıl Elma v36.0 devrede. Tüm sistemler aktif.", date: "SİSTEM" },
                { title: "GÜVENLİK UYARISI", msg: "Yerel ağ bağlantısı izleniyor.", date: "SİBER" }
            ],
            wanted: [
                { name: "GÖLGE", crime: "Siber Casusluk", status: "ARANIYOR" },
                { name: "X-22", crime: "Veri İhlali", status: "YAKALANDI" }
            ],
            personnel: [
                { id: "1", name: "HAKAN F.", codename: "KARTAL", role: "admin", pass: "TURAN" },
                { id: "2", name: "CAN T.", codename: "HACKER", role: "cyber", pass: "1234" },
                { id: "3", name: "AYŞE Y.", codename: "ANKA", role: "agent", pass: "1111" }
            ],
            chat: [],
            ops: [],
            reports: []
        };

        const app = {
            db: null, // Veritabanı nesnesi
            data: null, // Aktif veri
            user: null, // Giriş yapmış kullanıcı
            isOffline: false,

            init: function() {
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);

                // Firebase Başlatmayı Dene
                try {
                    firebase.initializeApp(firebaseConfig);
                    this.db = firebase.database();
                    document.getElementById('boot-net-status').innerText = "CONNECTING...";
                    document.getElementById('boot-net-status').style.color = "yellow";
                    
                    // Veriyi dinle
                    this.db.ref('mit_database').on('value', (snapshot) => {
                        const val = snapshot.val();
                        if (val) {
                            this.data = val;
                            this.onDataUpdate();
                        } else {
                            // Veritabanı boşsa varsayılanı yaz
                            this.db.ref('mit_database').set(defaultData);
                        }
                    }, (error) => {
                        console.error("Firebase Hatası:", error);
                        this.activateOfflineMode();
                    });

                } catch (e) {
                    console.error("Firebase Başlatılamadı:", e);
                    this.activateOfflineMode();
                }
            },

            activateOfflineMode: function() {
                this.isOffline = true;
                this.data = JSON.parse(JSON.stringify(defaultData)); // Derin kopya
                document.getElementById('connection-indicator').innerHTML = "<i class='fas fa-exclamation-triangle'></i> ÇEVRİMDIŞI MOD (YEREL)";
                document.getElementById('connection-indicator').style.color = "orange";
                this.onDataUpdate();
            },

            onDataUpdate: function() {
                // Boot ekranını kapat
                const boot = document.getElementById('boot-screen');
                if (boot && boot.style.display !== 'none') {
                    document.getElementById('boot-net-status').innerText = "SUCCESS";
                    document.getElementById('boot-net-status').style.color = "#00ff41";
                    setTimeout(() => { boot.style.display = 'none'; }, 800);
                }

                // Verileri Arayüze İşle
                this.renderPublic();
                this.renderDashboard();
                if(this.user) {
                    this.renderHR();
                    this.renderChat();
                    this.renderOps();
                    this.renderReports();
                    this.applyDefcon(this.data.defcon);
                }
            },

            // --- NAVİGASYON ---
            nav: function(panelId) {
                // Yetki Kontrolü
                if (panelId === 'cyber' && (!this.user || (this.user.role !== 'admin' && this.user.role !== 'cyber'))) return alert("YETKİSİZ ERİŞİM!");
                if (panelId === 'hr' && (!this.user || (this.user.role !== 'admin'))) return alert("SADECE YÖNETİCİ GİREBİLİR!");

                // Hepsini gizle
                document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

                // İsteneni aç
                const target = document.getElementById('panel-' + panelId);
                if (target) {
                    target.classList.add('active');
                } else {
                    console.error("Panel bulunamadı:", panelId);
                }

                // Menü butonunu aktif yap (Basit döngü)
                const btns = document.querySelectorAll(`button[onclick="app.nav('${panelId}')"]`);
                if(btns.length > 0) btns[0].classList.add('active');
            },

            // --- GİRİŞ / ÇIKIŞ ---
            showLogin: function() { document.getElementById('login-modal').style.display = 'flex'; },
            
            login: function() {
                const pass = document.getElementById('login-pass').value;
                const user = this.data.personnel.find(p => p.pass === pass);
                
                if (user) {
                    this.user = user;
                    document.getElementById('login-modal').style.display = 'none';
                    document.getElementById('menu-guest').style.display = 'none';
                    document.getElementById('menu-staff').style.display = 'block';
                    
                    document.getElementById('u-name').innerText = user.name;
                    document.getElementById('u-role').innerText = user.codename + " | " + user.role.toUpperCase();
                    document.getElementById('u-role').style.color = "var(--staff-blue)";
                    
                    if(user.role === 'admin' || user.role === 'cyber') document.getElementById('nav-cyber').style.display = 'flex';
                    if(user.role === 'admin') {
                         document.getElementById('defcon-controls').style.display = 'flex';
                         document.getElementById('admin-tools').style.display = 'block';
                         document.getElementById('ops-admin').style.display = 'block';
                    }

                    this.nav('dashboard');
                    this.saveLog(`GİRİŞ YAPILDI: ${user.codename}`);
                } else {
                    alert("HATALI ŞİFRE!");
                    document.getElementById('login-pass').value = '';
                }
            },

            logout: function() { location.reload(); },

            // --- RENDER FONKSİYONLARI ---
            renderPublic: function() {
                const feed = document.getElementById('feed-public');
                feed.innerHTML = '';
                if(this.data.announcements) {
                    this.data.announcements.forEach(a => {
                        feed.innerHTML += `<div style="border-left:3px solid var(--accent); padding:10px; margin-bottom:10px; background:rgba(255,255,255,0.05);">
                            <strong style="color:white;">${a.title}</strong><br>
                            <span style="color:#aaa; font-size:0.9rem;">${a.msg}</span>
                        </div>`;
                    });
                }

                const tbl = document.querySelector('#wanted-table tbody');
                tbl.innerHTML = '';
                if(this.data.wanted) {
                    this.data.wanted.forEach(w => {
                        let color = w.status === 'ARANIYOR' ? 'red' : 'lime';
                        tbl.innerHTML += `<tr><td>${w.name}</td><td>${w.crime}</td><td style="color:${color}">${w.status}</td></tr>`;
                    });
                }
            },

            renderDashboard: function() {
                document.getElementById('defcon-disp').innerText = this.data.defcon;
                document.body.className = `defcon-${this.data.defcon}`;
                document.getElementById('stat-staff').innerText = this.data.personnel ? this.data.personnel.length : 0;
                document.getElementById('stat-ops').innerText = this.data.ops ? this.data.ops.length : 0;
            },

            renderHR: function() {
                const tbl = document.querySelector('#hr-table tbody');
                tbl.innerHTML = '';
                if(this.data.personnel) {
                    this.data.personnel.forEach(p => {
                        tbl.innerHTML += `<tr><td>${p.name}</td><td>${p.codename}</td><td>${p.role}</td><td style="color:lime">AKTİF</td></tr>`;
                    });
                }
            },
            
            renderChat: function() {
                const win = document.getElementById('chat-window');
                win.innerHTML = '';
                if(this.data.chat) {
                    this.data.chat.forEach(c => {
                        const isMe = c.user === this.user.codename;
                        const color = isMe ? 'var(--staff-blue)' : '#aaa';
                        const align = isMe ? 'right' : 'left';
                        win.innerHTML += `<div style="text-align:${align}; margin-bottom:5px;">
                            <strong style="color:${color}; font-size:0.8rem;">${c.user}</strong><br>
                            <span style="color:white;">${c.msg}</span>
                        </div>`;
                    });
                    win.scrollTop = win.scrollHeight;
                }
            },

            renderOps: function() {
                const tbl = document.querySelector('#ops-table tbody');
                tbl.innerHTML = '';
                if(this.data.ops) {
                    this.data.ops.forEach(o => {
                        tbl.innerHTML += `<tr><td>${o.name}</td><td>${o.leader}</td><td style="color:lime">${o.status}</td></tr>`;
                    });
                }
            },
            
            renderReports: function() {
                const list = document.getElementById('reports-list');
                list.innerHTML = '';
                if(this.data.reports) {
                    this.data.reports.forEach(r => {
                        list.innerHTML += `<div style="border-bottom:1px solid #333; padding:5px;"><strong style="color:var(--staff-blue)">${r.title}</strong> (${r.author})<br><small>${r.content}</small></div>`;
                    });
                }
            },

            // --- AKSİYONLAR ---
            submitApp: function() { alert("Başvurunuz şifrelenerek merkeze iletildi."); document.getElementById('app-name').value=''; },
            
            setDefcon: function(level) {
                this.data.defcon = level;
                this.saveData();
                this.saveLog(`DEFCON SEVİYESİ DEĞİŞTİ: ${level}`);
            },

            postAnnounce: function() {
                const txt = document.getElementById('ann-text').value;
                if(!txt) return;
                if(!this.data.announcements) this.data.announcements = [];
                this.data.announcements.unshift({title:"YÖNETİCİ DUYURUSU", msg:txt, date:new Date().toLocaleTimeString()});
                this.saveData();
                document.getElementById('ann-text').value = '';
                alert("Duyuru yayınlandı.");
            },
            
            sendChat: function() {
                const txt = document.getElementById('chat-input').value;
                if(!txt) return;
                if(!this.data.chat) this.data.chat = [];
                this.data.chat.push({user:this.user.codename, msg:txt});
                if(this.data.chat.length > 20) this.data.chat.shift();
                this.saveData();
                document.getElementById('chat-input').value = '';
            },

            addOp: function() {
                const name = document.getElementById('op-name').value;
                if(!name) return;
                if(!this.data.ops) this.data.ops = [];
                this.data.ops.push({name:name, leader:this.user.codename, status:"AKTİF"});
                this.saveData();
                document.getElementById('op-name').value = '';
            },
            
            sendReport: function() {
                const t = document.getElementById('rep-title').value;
                const c = document.getElementById('rep-content').value;
                if(!t || !c) return;
                if(!this.data.reports) this.data.reports = [];
                this.data.reports.unshift({title:t, content:c, author:this.user.codename});
                this.saveData();
                document.getElementById('rep-title').value = '';
                document.getElementById('rep-content').value = '';
                alert("Rapor havuza eklendi.");
            },

            // --- YARDIMCILAR ---
            saveData: function() {
                if(!this.isOffline && this.db) {
                    this.db.ref('mit_database').set(this.data);
                } else {
                    // Offline modda sadece UI güncellenir, refresh yapınca gider.
                    this.onDataUpdate();
                }
            },
            
            saveLog: function(msg) {
                const logBox = document.getElementById('dash-logs');
                const time = new Date().toLocaleTimeString();
                logBox.innerHTML = `<div style="color:var(--accent)">[${time}] ${msg}</div>` + logBox.innerHTML;
            },

            updateClock: function() {
                document.getElementById('sys-clock').innerText = new Date().toLocaleTimeString();
            },
            
            applyDefcon: function(lvl) {
                document.body.className = `defcon-${lvl}`;
                document.documentElement.style.setProperty('--hue', lvl == 5 ? 120 : (lvl == 1 ? 0 : 30));
            }
        };

        // Başlat
        window.onload = function() {
            app.init();
        };
    </script>
</body>
</html>
