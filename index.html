<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- 1. FIREBASE AYARLARI (KENDÄ° BÄ°LGÄ°LERÄ°NLE DOLDUR) ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4mXN8BZ3OMzl35vtEbNGA9BUuHPgoqQU",
        authDomain: "mit-sistemi.firebaseapp.com",
        databaseURL: "https://mit-sistemi-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mit-sistemi",
        storageBucket: "mit-sistemi.firebasestorage.app",
        messagingSenderId: "195453377116",
        appId: "1:195453377116:web:85067f5070ecf983bb6499"
    };

    // Firebase'i BaÅŸlat
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- MEVCUT SÄ°STEM AYARLARI ---
    const CONFIG = {
        WEB_REP: "https://discord.com/api/webhooks/1462228533509361839/fZmCO4aEvvwKT_01NGI-KY5rs7t5rQyYIxaaLylENigt13K0EVPbuH7nKfQgSkWQ2nP7",
        WEB_OPS: "https://discord.com/api/webhooks/1462228977346412736/XyP1g3QXXOoXcg9vFnr5DMJ0PMygNHEx-TjhyMzBokQ1b8D9hZ-HGUubZKZUJSJHdi-X",
        TAG_REP: "<@997276536250056855>",
        TAG_OPS: "<@997275075839528970>"
    };

    const SFX = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        playTone: function(freq, type, dur) {
            if(this.ctx.state==='suspended')this.ctx.resume();
            const o=this.ctx.createOscillator(), g=this.ctx.createGain();
            o.type=type; o.frequency.value=freq; o.connect(g); g.connect(this.ctx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime+dur);
            o.stop(this.ctx.currentTime+dur);
        },
        click: function() { this.playTone(1200, 'sine', 0.1); },
        hover: function() { this.playTone(400, 'triangle', 0.05); },
        error: function() { this.playTone(150, 'sawtooth', 0.3); setTimeout(()=>this.playTone(100,'sawtooth',0.3),150); },
        success: function() { this.playTone(800, 'sine', 0.1); setTimeout(()=>this.playTone(1200,'sine',0.2),100); },
        boot: function() { try { let t=0; for(let i=0;i<5;i++){ setTimeout(()=>this.playTone(200+(i*100), 'square', 0.1), t); t+=100; } } catch(e){} }
    };

    // --- ANA UYGULAMA ---
    const app = {
        // VarsayÄ±lan Veriler (VeritabanÄ± boÅŸsa bunlar yÃ¼klenir)
        defaultData: {
            defcon: 1,
            personnel: [
                { id: 'ADM-001', name: 'HAKAN F.', codename: 'KARTAL', role: 'admin', rank: 'MÃœSTEÅžAR', pass: 'TURAN', gender:'men', photoId:33, cover: {fakeName: 'Ahmet YÄ±lmaz', fakeJob: 'Akademisyen', fakePhotoId: 10} },
                { id: 'OPS-007', name: 'ZÃœMRÃœT K.', codename: 'ANKA', role: 'staff', rank: 'SAHA UZMANI', pass: '1234', gender:'women', photoId:45, cover: {fakeName: 'AyÅŸe Demir', fakeJob: 'EczacÄ±', fakePhotoId: 22} }
            ],
            reports: [],
            apps: [],
            tips: [],
            ops: [],
            chat: [{user:'SÄ°STEM', msg:'AÄŸ aktif.', time:'00:00'}],
            audit: [],
            announcements: [{title: "SÄ°STEM GÃœNCEL", msg: "v22.2 KIZIL ELMA", type: "critical", date: new Date().toLocaleDateString()}],
            wanted: [{name:'GÃ–LGE', crime:'Casusluk', status:'ARANIYOR'}]
        },

        state: { 
            user: null, 
            fail: 0, 
            visiblePass: new Set(), 
            tUser: null, 
            genCode: null,
            db: null // Veriler Firebase'den buraya dolacak
        },

        init: function() {
            this.bootSequence();
            this.listenToCloud(); // Firebase Dinlemeyi BaÅŸlat
            
            document.querySelectorAll('button, .nav-btn').forEach(b => {
                b.addEventListener('mouseenter', ()=>SFX.hover());
                b.addEventListener('click', ()=>SFX.click());
            });
        },

        // --- YENÄ°: FIREBASE BAÄžLANTISI ---
        listenToCloud: function() {
            console.log("Bulut baÄŸlantÄ±sÄ± kuruluyor...");
            // 'mit_database' baÅŸlÄ±ÄŸÄ± altÄ±ndaki tÃ¼m verileri dinle
            database.ref('mit_database').on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // Veri varsa state'e yÃ¼kle
                    this.state.db = data;
                } else {
                    // Veri yoksa (ilk kurulum), varsayÄ±lanlarÄ± yÃ¼kle ve kaydet
                    this.state.db = this.defaultData;
                    this.save(); 
                }

                // Veri deÄŸiÅŸtiÄŸinde ekranÄ± o an yenile (CanlÄ± update)
                this.refreshCurrentView();
                
                // Defcon seviyesini uygula
                this.applyDefcon(this.state.db.defcon);
            });
        },

        // --- YENÄ°: KAYDETME FONKSÄ°YONU ---
        save: function() {
            // LocalStorage yerine Firebase'e yaz
            if(this.state.db) {
                database.ref('mit_database').set(this.state.db)
                    .catch(e => console.error("KayÄ±t hatasÄ±:", e));
            }
        },

        // Veri deÄŸiÅŸince aÃ§Ä±k olan paneli yeniler
        refreshCurrentView: function() {
            if(document.getElementById('panel-hr').classList.contains('active')) this.renderHR();
            if(document.getElementById('panel-public').classList.contains('active')) this.renderPublic();
            if(document.getElementById('panel-chat').classList.contains('active')) this.renderChat();
            if(document.getElementById('panel-ops').classList.contains('active')) this.renderOps();
            if(document.getElementById('panel-db').classList.contains('active')) this.renderLogs();
            if(document.getElementById('panel-reports').classList.contains('active')) this.renderReports();
            if(document.getElementById('panel-dashboard').classList.contains('active')) this.updateDash();
        },

        bootSequence: function() {
            const s = document.getElementById('boot-screen');
            if(!s) { this.initAppLogic(); return; }
            const t = document.getElementById('boot-text');
            const lines = ["BIOS DATE 01/18/26 15:00:00", "establishing uplink...... SUCCESS", "INITIATING KIZIL_ELMA PROTOCOL..."];
            let i = 0;
            try { SFX.boot(); } catch(e){}
            const int = setInterval(() => {
                if(i < lines.length) { t.innerHTML += lines[i] + "<br>"; i++; } 
                else { clearInterval(int); s.style.opacity = '0'; document.getElementById('main-app').style.opacity = '1'; setTimeout(() => { s.style.display='none'; this.initAppLogic(); }, 1000); }
            }, 150);
        },

        initAppLogic: function() {
            this.updateClock(); setInterval(() => this.updateClock(), 1000);
            this.initParticles();
            this.nav('public');
        },

        setDefcon: function(lvl) { 
            this.state.db.defcon = lvl; 
            this.save(); // DeÄŸiÅŸikliÄŸi buluta gÃ¶nder
        },
        
        applyDefcon: function(lvl) { 
            document.body.className = `defcon-${lvl}`; 
            const el = document.getElementById('defcon-disp'); 
            if(el) el.innerText = lvl; 
        },

        initParticles: function() {
            const cvs=document.getElementById('particles-js'), ctx=cvs.getContext('2d');
            cvs.width=window.innerWidth; cvs.height=window.innerHeight;
            let pts=[]; for(let i=0;i<50;i++) pts.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, vx:(Math.random()-.5), vy:(Math.random()-.5)});
            function anim(){ ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle='rgba(255,255,255,0.1)'; pts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>cvs.width)p.vx*=-1; if(p.y<0||p.y>cvs.height)p.vy*=-1; ctx.beginPath(); ctx.arc(p.x,p.y,1.5,0,6.28); ctx.fill(); }); requestAnimationFrame(anim); } anim();
        },

        sendDiscord: async function(url, tag, title, desc, color, fields) {
            const p = { username: "MÄ°T Ä°STÄ°HBARAT", avatar_url: "https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png", content: tag, embeds: [{title, description: desc, color, fields, footer: { text: "KIZIL ELMA v22.2" }, timestamp: new Date()}] };
            try { await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(p) }); } catch(e){}
        },

        nav: function(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-' + id).classList.add('active');
            if(id === 'map') setTimeout(() => this.initMap(), 200);
            // Render fonksiyonlarÄ±nÄ± burada Ã§aÄŸÄ±rmÄ±yoruz, listenToCloud otomatik Ã§aÄŸÄ±rÄ±yor
            this.refreshCurrentView();
        },

        showLogin: function() { document.getElementById('login-modal').style.display='flex'; document.getElementById('2fa-box').style.display='none'; document.getElementById('btn-l1').style.display='inline-block'; document.getElementById('btn-l2').style.display='none'; document.getElementById('login-pass').value=''; document.getElementById('login-2fa').value=''; document.getElementById('login-msg').innerText=''; this.state.fail = 0; },
        
        loginStep1: function() {
            // Veri henÃ¼z yÃ¼klenmediyse bekle
            if(!this.state.db) return alert("Sistem yÃ¼kleniyor...");
            
            const p = document.getElementById('login-pass').value.trim();
            const u = this.state.db.personnel.find(x => x.pass === p);
            if(u){ this.state.tUser=u; this.state.genCode=Math.floor(1000+Math.random()*9000); document.getElementById('2fa-code').innerText=this.state.genCode; document.getElementById('2fa-box').style.display='block'; document.getElementById('btn-l1').style.display='none'; document.getElementById('btn-l2').style.display='inline-block'; SFX.success(); } 
            else { SFX.error(); this.failLogin(); }
        },
        
        loginStep2: function() {
            if(parseInt(document.getElementById('login-2fa').value)===this.state.genCode) {
                SFX.success(); this.state.user=this.state.tUser; this.state.fail=0;
                document.getElementById('login-modal').style.display='none'; document.getElementById('menu-guest').style.display='none'; document.getElementById('menu-staff').style.display='block';
                document.getElementById('u-name').innerText=this.state.user.name; document.getElementById('u-code').innerText="KOD: "+this.state.user.codename; document.getElementById('u-code').style.display='block';
                document.getElementById('u-role').innerText=this.state.user.role==='admin'?'YÃ–NETÄ°CÄ°':this.state.user.rank; document.getElementById('u-role').style.color=this.state.user.role==='admin'?'var(--admin-gold)':'#666';
                document.getElementById('u-photo').src=`https://randomuser.me/api/portraits/${this.state.user.gender}/${this.state.user.photoId}.jpg`; document.getElementById('u-photo').style.display='block'; document.getElementById('u-icon').style.display='none';
                this.logAudit('GÄ°RÄ°Åž', `${this.state.user.codename} sisteme girdi.`); this.nav('dashboard');
            } else { SFX.error(); this.failLogin(); }
        },
        
        failLogin: function(){ this.state.fail++; document.getElementById('login-msg').innerText=`HATA (${this.state.fail}/3)`; if(this.state.fail>=3){ SFX.error(); document.getElementById('lockdown-screen').style.display='flex'; } },
        logout: function() { location.reload(); },

        renderReports: function() { 
            const f = document.getElementById('reports-feed'); f.innerHTML=''; 
            if(!this.state.db || !this.state.db.reports) return;
            this.state.db.reports.forEach(r => { f.innerHTML+=`<div class="report-card ${r.type==='op'?'report-op':''}"><div class="discord-tag">SENT > WEBHOOK</div><div style="display:flex; justify-content:space-between;"><span style="color:white; font-weight:bold;">${r.subject}</span><span style="color:#666; font-size:0.7rem;">${r.author} | ${r.date}</span></div><p style="color:#aaa; margin-top:5px; font-size:0.9rem;">${r.content}</p></div>`; }); 
        },
        
        submitReport: function() {
            const t=document.getElementById('report-type').value, s=document.getElementById('report-subj').value, c=document.getElementById('report-content').value;
            if(!s||!c){ SFX.error(); return alert("Eksik!"); }
            
            // Veri dizisini gÃ¼venli gÃ¼ncelle
            if(!this.state.db.reports) this.state.db.reports = [];
            this.state.db.reports.unshift({author:this.state.user.codename, type:t, subject:s, content:c, date:new Date().toLocaleString()}); 
            
            this.save(); // Firebase'e gÃ¶nder
            
            this.sendDiscord(CONFIG.WEB_REP, CONFIG.TAG_REP, "ðŸ“ SAHA RAPORU", `**${s}**`, 3447003, [{name:"Ajan",value:this.state.user.codename, inline:true}, {name:"Tip",value:t.toUpperCase(), inline:true}, {name:"Ä°Ã§erik",value:c}]);
            document.getElementById('report-subj').value=''; document.getElementById('report-content').value=''; SFX.success();
        },

        renderOps: function() { 
            const t=document.querySelector('#ops-table tbody'); t.innerHTML=''; 
            const sel=document.getElementById('op-lead'); sel.innerHTML=''; 
            if(!this.state.db || !this.state.db.ops) return;

            this.state.db.personnel.forEach(p=>sel.innerHTML+=`<option value="${p.codename}">${p.codename}</option>`); 
            this.state.db.ops.forEach((o,i)=>{ t.innerHTML+=`<tr><td style="color:white">${o.name}</td><td>${o.lead}</td><td style="color:${o.status==='AKTÄ°F'?'var(--accent)':'#666'}">${o.status}</td><td>${o.status==='AKTÄ°F'?`<button class="cyber-btn btn-small" onclick="app.endOp(${i})">BÄ°TÄ°R</button>`:'-'}</td></tr>`; }); 
        },
        
        addOp: function() { 
            const n=document.getElementById('op-name').value, l=document.getElementById('op-lead').value; if(!n)return; 
            if(!this.state.db.ops) this.state.db.ops = [];
            this.state.db.ops.unshift({name:n, lead:l, status:'AKTÄ°F'}); 
            this.save(); 
            document.getElementById('new-op-modal').style.display='none'; 
            this.sendDiscord(CONFIG.WEB_OPS, CONFIG.TAG_OPS, "ðŸš¨ YENÄ° GÃ–REV EMRÄ°", `**Operasyon:** ${n}`, 15158332, [{name:"Tim Lideri",value:l,inline:true}, {name:"Durum",value:"BAÅžLATILDI",inline:true}]); SFX.success(); 
        },
        
        endOp: function(i) { this.state.db.ops[i].status='PASÄ°F'; this.save(); },

        renderHR: function() {
            if(!this.state.user) return; // KullanÄ±cÄ± yoksa render etme
            const isAdmin = this.state.user.role==='admin';
            document.getElementById('admin-tools').style.display=isAdmin?'block':'none';
            document.getElementById('admin-apps-section').style.display=isAdmin?'block':'none';
            document.getElementById('hr-table-head').innerHTML=isAdmin?`<tr><th>Ä°SÄ°M</th><th>KOD</th><th>ROL</th><th>SAHTE</th><th>ÅžÄ°FRE</th><th>Ä°ÅžLEM</th></tr>`:`<tr><th>KOD ADI</th><th>RÃœTBE</th><th>DURUM</th></tr>`;
            const body=document.getElementById('hr-table-body'); body.innerHTML='';
            
            if(!this.state.db.personnel) this.state.db.personnel = [];

            this.state.db.personnel.forEach(p=>{
                if(isAdmin){
                    const vis=this.state.visiblePass.has(p.id);
                    body.innerHTML+=`<tr><td>${p.name}</td><td style="color:var(--accent);font-weight:bold;">${p.codename}</td><td style="color:${p.role==='admin'?'var(--admin-gold)':'#fff'}">${p.role.toUpperCase()}</td><td><div style="font-size:0.7rem;color:var(--staff-blue)">${p.cover.fakeName}</div></td><td><span class="blur-text ${vis?'visible':''}" onclick="app.togglePass('${p.id}')">${p.pass}</span></td><td><button class="cyber-btn btn-small btn-gold" onclick="app.editUser('${p.id}')"><i class="fas fa-edit"></i></button><button class="cyber-btn btn-small" onclick="app.drawID('${p.id}','REAL')">R</button><button class="cyber-btn btn-small btn-fake" onclick="app.drawID('${p.id}','FAKE')">S</button><button class="cyber-btn btn-small" style="border-color:#555;" onclick="app.fireStaff('${p.id}')">X</button></td></tr>`;
                } else body.innerHTML+=`<tr><td style="color:var(--staff-blue)">${p.codename}</td><td>${p.rank}</td><td style="color:var(--success)">AKTÄ°F</td></tr>`;
            });
            if(isAdmin){
                const l=document.getElementById('hr-apps-list'); l.innerHTML=this.state.db.apps && this.state.db.apps.length?'':'<span style="color:#666">Bekleyen yok.</span>';
                if(this.state.db.apps) {
                    this.state.db.apps.forEach((a,i)=>{
                        let rank=a.skill==='siber'?"SÄ°BER UZMANI":(a.skill==='saha'?"SAHA AJANI":"ANALÄ°ST");
                        l.innerHTML+=`<div style="background:#0a0a0a; border:1px solid #222; padding:15px;"><strong style="color:white">${a.name}</strong> (${a.skill})<br><small>${a.tc}</small><br><input id="ac-${i}" placeholder="KOD ADI" style="width:100%; margin-top:5px;"><div style="display:flex; gap:5px;"><button class="cyber-btn btn-small" onclick="app.approveApp(${i},'${rank}')">ONAY</button><button class="cyber-btn btn-small" style="border-color:#555;" onclick="app.rejectApp(${i})">RED</button></div></div>`;
                    });
                }
                const tl=document.getElementById('hr-tips-list'); tl.innerHTML=this.state.db.tips && this.state.db.tips.length?'':'<span style="color:#666">Ä°hbar yok.</span>';
                if(this.state.db.tips) {
                    this.state.db.tips.forEach((tp, i)=>{ tl.innerHTML += `<div style="border-bottom:1px solid #333; padding:10px;"><strong style="color:var(--accent)">${tp.subject}</strong> <small style="float:right">${tp.date}</small><p style="font-size:0.9rem; color:#ccc; margin-top:5px;">${tp.text}</p><button class="cyber-btn btn-small" style="margin-top:5px; border-color:#555" onclick="app.delTip(${i})">SÄ°L</button></div>` });
                }
                document.getElementById('id-actions').innerHTML=`<button class="cyber-btn btn-small" onclick="app.downloadID()">Ä°NDÄ°R</button>`;
            } else document.getElementById('id-actions').innerHTML='<span style="color:#666">Yetkisiz</span>';
        },

        editUser: function(id) { 
            const p=this.state.db.personnel.find(x=>x.id===id); 
            document.getElementById('edit-id').value=p.id; 
            document.getElementById('edit-name').value=p.name; 
            document.getElementById('edit-code').value=p.codename; 
            document.getElementById('edit-role').value=p.role; 
            document.getElementById('edit-rank').value = p.rank || "";
            document.getElementById('edit-pass').value = ''; 
            document.getElementById('edit-modal').style.display='flex'; 
        },
        saveEdit: function() { 
            const id=document.getElementById('edit-id').value, p=this.state.db.personnel.find(x=>x.id===id); 
            if(p){ 
                p.name=document.getElementById('edit-name').value; 
                p.codename=document.getElementById('edit-code').value; 
                p.role=document.getElementById('edit-role').value; 
                p.rank = document.getElementById('edit-rank').value.toUpperCase();
                const newPass = document.getElementById('edit-pass').value.trim();
                if(newPass.length > 0) p.pass = newPass;
                this.save(); document.getElementById('edit-modal').style.display='none'; 
            } 
        },
        
        approveApp: function(idx,rank){ const c=document.getElementById(`ac-${idx}`).value.toUpperCase(); if(!c)return alert("Kod!"); const a=this.state.db.apps[idx]; const nP={id:"AG-"+Math.floor(100+Math.random()*900),name:a.name,codename:c,role:'staff',rank,pass:"MIT"+Math.floor(1000+Math.random()*9000),gender:a.gender,photoId:Math.floor(Math.random()*99),cover:{fakeName:"Sivil "+Math.floor(Math.random()*100),fakeJob:"MÃ¼hendis",fakePhotoId:Math.floor(Math.random()*99)}}; this.state.db.personnel.push(nP); this.state.db.apps.splice(idx,1); this.save(); SFX.success(); },
        rejectApp: function(idx){ this.state.db.apps.splice(idx,1); this.save(); },
        delTip: function(idx){ this.state.db.tips.splice(idx,1); this.save(); },
        fireStaff: function(id){ if(confirm("Sil?")){ const i=this.state.db.personnel.findIndex(x=>x.id===id); if(i>-1)this.state.db.personnel.splice(i,1); this.save(); }},
        togglePass: function(id){ this.state.visiblePass.has(id)?this.state.visiblePass.delete(id):this.state.visiblePass.add(id); this.renderHR(); },

        drawID: function(id,mode) {
            const p=this.state.db.personnel.find(x=>x.id===id); if(!p)return;
            const cvs=document.getElementById('idCardCanvas'), ctx=cvs.getContext('2d');
            const w=cvs.width, h=cvs.height, isReal=mode==='REAL';
            const bgC=isReal?["#0a0000","#1c0000"]:["#ffffff","#e0e0e0"];
            const grd=ctx.createLinearGradient(0,0,w,h); grd.addColorStop(0,bgC[0]); grd.addColorStop(1,bgC[1]);
            ctx.fillStyle=grd; ctx.fillRect(0,0,w,h);
            if(isReal){ ctx.save(); ctx.globalAlpha=0.1; ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(w/2,h/2,90,0,6.28); ctx.fill(); ctx.restore(); }
            ctx.fillStyle=isReal?"#ff0000":"#005588"; ctx.fillRect(0,0,w,60);
            ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.font="bold 20px Arial"; ctx.fillText(isReal?"T.C. MÄ°LLÄ° Ä°STÄ°HBARAT TEÅžKÄ°LATI":"TÃœRKÄ°YE CUMHURÄ°YETÄ°",w/2,30);
            ctx.font="12px monospace"; ctx.fillText(isReal?"RESMÄ° KÄ°MLÄ°K":"KÄ°MLÄ°K KARTI",w/2,50);
            const img=new Image(); img.crossOrigin="Anonymous"; img.src=`https://randomuser.me/api/portraits/${p.gender}/${isReal?p.photoId:p.cover.fakePhotoId}.jpg`;
            const px=30,py=80,pw=120,ph=150; ctx.strokeStyle=isReal?"#ff0000":"#005588"; ctx.lineWidth=3; ctx.strokeRect(px,py,pw,ph); ctx.fillStyle="#222"; ctx.fillRect(px,py,pw,ph);
            const tx=170; ctx.textAlign="left";
            const df=(l,v,y)=>{ ctx.fillStyle=isReal?"#888":"#555"; ctx.font="10px Arial"; ctx.fillText(l,tx,y); ctx.fillStyle=isReal?"#fff":"#000"; ctx.font="bold 16px Arial"; ctx.fillText(v.toUpperCase(),tx,y+18); };
            df("ADI SOYADI",isReal?p.name:p.cover.fakeName,90); df("GÃ–REVÄ°",isReal?p.rank:p.cover.fakeJob,130);
            if(isReal){ df("KOD ADI",p.codename,170); ctx.fillStyle="red"; ctx.font="bold 12px monospace"; ctx.fillText("GÄ°ZLÄ°",tx,220); } else { df("DOÄžUM", "15.04.1990",170); }
            img.onload=()=>{ ctx.drawImage(img,px,py,pw,ph); };
        },
        downloadID: function(){ const l=document.createElement('a'); l.download='ID.png'; l.href=document.getElementById('idCardCanvas').toDataURL(); l.click(); },

        renderPublic: function(){ 
            document.getElementById('feed-public').innerHTML=''; 
            if(!this.state.db || !this.state.db.announcements) return;
            this.state.db.announcements.forEach(a=>{ document.getElementById('feed-public').innerHTML+=`<div style="padding:15px; background:#0f0f0f; border-left:4px solid ${a.type==='critical'?'var(--accent)':'var(--staff-blue)'}; margin-bottom:10px;"><strong style="color:white">${a.title}</strong> <span style="float:right;font-size:0.7rem;color:#666">${a.date}</span><p style="color:#aaa;margin-top:5px;">${a.msg}</p></div>`; }); 
            const t=document.querySelector('#wanted-table tbody'); t.innerHTML=''; 
            if(this.state.db.wanted) this.state.db.wanted.forEach(w=>t.innerHTML+=`<tr><td>${w.name}</td><td>${w.crime}</td><td style="color:var(--accent)">${w.status}</td></tr>`); 
        },
        
        adminPostAnnounce: function(){ 
            if(this.state.user.role!=='admin')return; 
            const t=document.getElementById('ann-title').value, m=document.getElementById('ann-msg').value, tp=document.getElementById('ann-type').value; if(!t)return; 
            if(!this.state.db.announcements) this.state.db.announcements = [];
            this.state.db.announcements.unshift({title:t, msg:m, type:tp, date:new Date().toLocaleDateString()}); 
            this.save(); alert("YayÄ±nlandÄ±"); 
        },
        
        submitApp: function(){ 
            const tc=document.getElementById('app-tc').value, name=document.getElementById('app-name').value, g=document.getElementById('app-gender').value, s=document.getElementById('app-skill').value; if(!tc||!name){SFX.error(); return alert("Eksik!");} 
            if(!this.state.db.apps) this.state.db.apps = [];
            this.state.db.apps.push({tc, name, skill:s, gender:g, date:new Date().toLocaleDateString()}); 
            this.save(); alert("GÃ¶nderildi."); this.nav('public'); 
        },
        
        sendTip: function(){ 
            const s=document.getElementById('tip-subj').value, t=document.getElementById('tip-text').value; 
            if(!t){ SFX.error(); return; }
            if(!this.state.db.tips) this.state.db.tips = [];
            this.state.db.tips.unshift({subject:s||"Ä°simsiz", text:t, date:new Date().toLocaleString()});
            this.save();
            alert("Ä°hbar ÅŸifrelendi ve havuza iletildi."); 
            document.getElementById('tip-subj').value=''; document.getElementById('tip-text').value=''; SFX.success();
        },
        
        updateDash: function(){ 
            if(!this.state.db) return;
            document.getElementById('stat-staff').innerText=this.state.db.personnel ? this.state.db.personnel.length : 0; 
            document.getElementById('stat-ops').innerText=this.state.db.ops ? this.state.db.ops.filter(o=>o.status==='AKTÄ°F').length : 0; 
            const l=document.getElementById('dash-logs'); l.innerHTML=''; 
            if(this.state.db.audit) this.state.db.audit.slice(-8).reverse().forEach(x=>l.innerHTML+=`<div style="border-bottom:1px solid #222; padding:5px;"><span style="color:var(--accent)">[${x.time}]</span> ${x.detail}</div>`); 
        },
        
        renderChat: function(){ 
            const w=document.getElementById('chat-window'); w.innerHTML=''; 
            if(!this.state.db.chat) return;
            this.state.db.chat.forEach(c=>{ const me=this.state.user&&c.user===this.state.user.codename; w.innerHTML+=`<div class="msg ${me?'msg-me':'msg-other'}"><span class="msg-sender">${me?'BEN':c.user}</span>${c.msg}</div>`; }); w.scrollTop=w.scrollHeight; 
        },
        
        sendChat: function(){ const t=document.getElementById('chat-input').value; if(!t)return; 
            if(!this.state.db.chat) this.state.db.chat = [];
            this.state.db.chat.push({user:this.state.user.codename, msg:t, time:new Date().toLocaleTimeString()}); this.save(); document.getElementById('chat-input').value=''; SFX.click(); 
        },
        
        queryDB: function(){ 
            const q=document.getElementById('db-q').value; if(!q){SFX.error(); return;}
            this.logAudit('SORGU', `Aranan: ${q}`);
            SFX.success();
            const blood = ["A Rh+", "0 Rh+", "B Rh-", "AB Rh+"][Math.floor(Math.random()*4)];
            const gender = Math.random()>0.5 ? 'men' : 'women';
            const photo = Math.floor(Math.random()*80);
            const score = Math.floor(Math.random()*100);
            const status = score > 80 ? "<span style='color:red'>KRÄ°MÄ°NAL</span>" : "<span style='color:lime'>TEMÄ°Z</span>";
            const hash = Array(16).fill(0).map(()=>Math.random().toString(36)[2]).join('').toUpperCase();

            const html = `
                <div class="bio-grid">
                    <img src="https://randomuser.me/api/portraits/${gender}/${photo}.jpg" class="bio-img">
                    <div class="bio-data">
                        <div><span class="bio-label">KÄ°MLÄ°K</span> <span>${q.toUpperCase()}</span></div>
                        <div><span class="bio-label">KAN GRUBU</span> <span>${blood}</span></div>
                        <div><span class="bio-label">GSM SÄ°NYAL</span> <span>AKTÄ°F (Baz: Ä°st-Avr-342)</span></div>
                        <div><span class="bio-label">PARMAK Ä°ZÄ°</span> <span>${hash}</span></div>
                        <div><span class="bio-label">GBT SKORU</span> <span>${score}/100</span></div>
                        <div><span class="bio-label">DURUM</span> <strong>${status}</strong></div>
                    </div>
                </div>
            `;
            document.getElementById('db-res').innerHTML = html;
        },
        
        renderLogs: function(){ const t=document.querySelector('#audit-table tbody'); t.innerHTML=''; if(this.state.db.audit) this.state.db.audit.slice().reverse().forEach(l=>t.innerHTML+=`<tr><td>${l.time}</td><td>${l.user}</td><td>${l.detail}</td></tr>`); },
        
        logAudit: function(act, det){ 
            if(!this.state.db.audit) this.state.db.audit = [];
            this.state.db.audit.push({time:new Date().toLocaleString(), user:this.state.user?this.state.user.name:'SÄ°STEM', detail:`${act}: ${det}`}); this.save(); 
        },
        
        initMap: function(){ if(this.mapInit)return; const m=L.map('map',{zoomControl:false}).setView([39.92,32.85],6); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(m); this.mapInit=true; m.invalidateSize(); },
        updateClock: function(){ document.getElementById('sys-clock').innerText=new Date().toLocaleTimeString(); }
    };
    window.onload = () => app.init();
</script>
