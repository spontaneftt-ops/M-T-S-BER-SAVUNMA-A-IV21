<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MİT | KIZIL ELMA SİBER SAVUNMA v43.0 (INTEGRATED SYSTEM)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;600;700&family=Courier+New:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --hue: 0; 
            --bg-deep: #020202;
            --bg-panel: rgba(10, 11, 14, 0.90);
            --primary: #0a0a0a;
            --accent: hsl(var(--hue), 100%, 50%); 
            --accent-dim: hsl(var(--hue), 100%, 20%);
            --accent-glow: hsla(var(--hue), 100%, 50%, 0.35);
            --discord: #5865F2;
            --staff-blue: #00ccff;
            --admin-gold: #ffcc00;
            --cyber-green: #00ff41;
            --ai-purple: #bd00ff;
            --text-main: #e0e0e0;
        }

        body.defcon-5 { --hue: 120; }
        body.defcon-4 { --hue: 60; }
        body.defcon-3 { --hue: 30; }
        body.defcon-1 { --hue: 0; }

        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--accent) var(--primary); }
        
        body { 
            background-color: var(--bg-deep);
            /* ENTEGRASYON: Sixday Arka Planı */
            background-image: url('https://img.freepik.com/premium-photo/digital-world-map-hologram-blue-background_436667-178.jpg'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh; overflow: hidden; user-select: none;
            transition: --accent 0.5s ease;
        }

        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            animation: scanlineMove 10s linear infinite;
            opacity: 0.2;
        }
        @keyframes scanlineMove { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* YENİ BOOT EKRANI */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            font-family: 'Share Tech Mono'; color: var(--accent); padding: 50px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .mit-logo-anim {
            width: 150px; height: 150px;
            background-image: url('https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            filter: drop-shadow(0 0 20px red);
            animation: pulseLogo 2s infinite;
            margin-bottom: 20px;
        }
        @keyframes pulseLogo { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; filter: drop-shadow(0 0 40px red); } 100% { transform: scale(1); opacity: 0.8; } }

        #particles-js { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        .app-wrapper { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 10; opacity: 0; transition: opacity 1s; }
        
        header {
            height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            background: rgba(5, 0, 0, 0.90); border-bottom: 3px solid var(--accent);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px var(--accent-glow); z-index: 100;
        }

        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        aside {
            width: 300px; background: rgba(5, 5, 5, 0.95); border-right: 1px solid #222;
            display: flex; flex-direction: column; padding: 20px 0; transition: 0.3s;
            flex-shrink: 0;
            backdrop-filter: blur(5px);
        }

        main { flex: 1; padding: 30px; overflow-y: auto; background: rgba(0,0,0,0.3); position: relative; }

        /* SIXDAY STİLİNDE GLASS BOX */
        .glass-box {
            background: rgba(10, 15, 20, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1); padding: 25px; 
            border-radius: 4px; margin-bottom: 25px; position: relative; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.7); overflow: hidden;
            border-left: 2px solid var(--accent);
            transition: border-color 0.5s;
        }
        
        h2, h3 { font-family: 'Orbitron'; color: var(--accent); margin-bottom: 15px; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 10px var(--accent-glow); transition: color 0.5s; }

        .nav-btn {
            background: transparent; border: none; color: #888; padding: 16px 25px;
            text-align: left; cursor: pointer; font-family: 'Rajdhani'; font-weight: 600; font-size: 1.1rem;
            display: flex; align-items: center; gap: 15px; transition: 0.3s; width: 100%;
            border-right: 3px solid transparent;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-main); text-shadow: 0 0 5px white; }
        .nav-btn.active { background: linear-gradient(90deg, var(--accent-dim) 0%, transparent 100%); color: white; border-right-color: var(--accent); }

        input, textarea, select {
            width: 100%; background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 12px;
            color: white; font-family: 'Share Tech Mono'; margin-bottom: 15px; outline: none; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); background: rgba(0,0,0,0.9); }

        .cyber-btn {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--accent);
            color: var(--accent); padding: 12px; font-family: 'Orbitron'; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;
            position: relative; overflow: hidden;
        }
        .cyber-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 25px var(--accent); }
        .cyber-btn:active { transform: scale(0.98); }
        .cyber-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-small { width: auto; padding: 6px 12px; font-size: 0.75rem; margin-right: 5px; }
        .btn-blue { border-color: var(--staff-blue); color: var(--staff-blue); }
        .btn-blue:hover { background: var(--staff-blue); color: #000; box-shadow: 0 0 15px var(--staff-blue); }
        .btn-gold { border-color: var(--admin-gold); color: var(--admin-gold); }
        .btn-green { border-color: #00ff00; color: #00ff00; }
        .btn-red { border-color: #ff0000; color: #ff0000; }
        .btn-ai { border-color: var(--ai-purple); color: var(--ai-purple); }

        .table-container { overflow-x: auto; }
        .cyber-table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        .cyber-table th { text-align: left; border-bottom: 1px solid var(--accent); padding: 10px; color: #aaa; font-size: 0.8rem; }
        .cyber-table td { padding: 12px 10px; border-bottom: 1px solid #333; font-family: 'Share Tech Mono'; font-size: 0.9rem; vertical-align: middle; }
        .cyber-table tr:hover { background: rgba(255,255,255,0.05); }

        .chat-container { display: grid; grid-template-columns: 1fr 280px; gap: 15px; height: 500px; }
        .chat-main { display: flex; flex-direction: column; height: 100%; min-height: 0; }
        .chat-window { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
        .chat-inputs { flex-shrink: 0; display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #333; }
        .chat-sidebar { background: rgba(0,0,0,0.4); border: 1px solid #333; padding: 10px; overflow-y: auto; }
        .chat-user-card { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; transition: 0.3s; }
        .user-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; margin-right: 8px; display: inline-block; }
        .status-online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }

        .msg { padding: 10px; border-radius: 4px; max-width: 80%; font-size: 0.9rem; position: relative; word-wrap: break-word; }
        .msg-me { background: var(--accent-dim); align-self: flex-end; border: 1px solid var(--accent); color: white; }
        .msg-other { background: #151515; align-self: flex-start; border: 1px solid #333; color: #ccc; }
        .msg-sender { font-size: 0.7rem; color: var(--staff-blue); display: block; margin-bottom: 3px; font-weight: bold; }
        .chat-img { max-width: 200px; border-radius: 4px; border: 1px solid #444; margin-top: 5px; cursor: pointer; }
        .chat-audio { width: 200px; margin-top: 5px; height: 30px; }
        .recording-pulse { animation: pulseRed 1s infinite; background: red !important; color: white !important; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        .report-card { border-left: 3px solid var(--staff-blue); background: rgba(20,20,20,0.8); padding: 15px; margin-bottom: 10px; position: relative; }
        .report-op { border-left-color: var(--accent); }
        .discord-tag { position: absolute; top: 5px; right: 5px; font-size: 0.6rem; color: var(--discord); opacity: 0.8; font-weight: bold; }

        .bio-grid { display: grid; grid-template-columns: 100px 1fr; gap: 15px; border: 1px solid var(--accent); padding: 10px; background: rgba(0,0,0,0.5); margin-top: 10px; }
        .bio-img { width: 100%; height: 100px; object-fit: cover; border: 1px solid #444; }
        .bio-data div { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 3px 0; font-family: 'Share Tech Mono'; font-size: 0.9rem; }
        .bio-label { color: var(--accent); font-size: 0.8rem; }

        .crypto-card { border: 1px solid var(--cyber-green); background: rgba(0, 20, 0, 0.8); padding: 15px; margin-bottom: 15px; font-family: 'Share Tech Mono'; position: relative; overflow: hidden; }
        .crypto-glitch { animation: glitchText 0.3s infinite; color: var(--cyber-green); font-weight: bold; font-size: 1.1rem; word-break: break-all; }
        #hack-terminal { background: #000; border: 2px solid var(--cyber-green); height: 300px; padding: 20px; font-family: 'Share Tech Mono'; color: var(--cyber-green); overflow: hidden; position: relative; }
        .hack-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.2rem; }
        .hack-char { width: 20px; text-align: center; cursor: pointer; transition: 0.1s; }
        .hack-char:hover { background: var(--cyber-green); color: black; }
        #hack-progress-bar { width: 0%; height: 5px; background: var(--cyber-green); transition: width 0.1s; box-shadow: 0 0 10px var(--cyber-green); }

        #ai-preview-area { min-height: 300px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .ai-loading-scan { position: absolute; width: 100%; height: 5px; background: var(--ai-purple); animation: scanDown 1.5s infinite linear; box-shadow: 0 0 15px var(--ai-purple); display: none; }
        #ai-generated-img { max-width: 100%; max-height: 500px; display: none; border: 2px solid var(--ai-purple); box-shadow: 0 0 30px rgba(189,0,255,0.3); }

        #lockdown-screen { background: #000; display: none; position: fixed; inset: 0; z-index: 2000; align-items: center; justify-content: center; flex-direction: column; color: var(--accent); text-align: center; }
        #login-modal, #edit-modal, #call-modal, #hack-modal, #app-view-modal { position: fixed; inset: 0; z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(15px); background: rgba(0,0,0,0.85); display: none; }

        .sec-matrix { position: relative; width: 100%; height: 200px; background: #000; border: 1px solid #333; overflow: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .sec-circle { position: absolute; border: 2px dashed var(--accent); border-radius: 50%; animation: spinSec 10s linear infinite; opacity: 0.5; }
        .sec-circle:nth-child(1) { width: 150px; height: 150px; border-color: var(--staff-blue); animation-duration: 5s; }
        .sec-circle:nth-child(2) { width: 100px; height: 100px; animation-direction: reverse; }
        .sec-scan-line { position: absolute; width: 100%; height: 2px; background: var(--accent); top: 0; animation: scanDown 2s linear infinite; box-shadow: 0 0 10px var(--accent); }
        .sec-text { font-family: 'Share Tech Mono'; color: var(--accent); z-index: 10; font-size: 0.8rem; background: rgba(0,0,0,0.7); padding: 5px; }
        .decoy-btn { background: rgba(255, 0, 0, 0.1); border: 2px solid red; color: red; padding: 15px; width: 100%; margin-top: 15px; font-weight: bold; font-family: 'Orbitron'; cursor: pointer; position: relative; overflow: hidden; }
        .decoy-btn:hover { background: red; color: black; box-shadow: 0 0 20px red; }
        .hidden-trigger { position: absolute; top: 10px; right: 10px; color: #333; font-size: 1rem; cursor: pointer; transition: color 0.3s; z-index: 100; }
        .hidden-trigger:hover { color: #444; }

        /* TELEFON SİSTEMİ GÖRSELLERİ */
        #call-modal { flex-direction: column; }
        .call-pulse { animation: callPulse 1.5s infinite; border-radius: 50%; width: 100px; height: 100px; background: var(--accent); display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px var(--accent-glow); }
        @keyframes callPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 30px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        @keyframes spinSec { 100% { transform: rotate(360deg); } }
        @keyframes scanDown { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes glitchText { 0% { opacity: 1; transform: translate(0); } 20% { opacity: 0.8; transform: translate(-2px, 2px); } 40% { opacity: 1; transform: translate(2px, -2px); } 100% { opacity: 1; transform: translate(0); } }
        @keyframes pulseAlert { 0% { opacity: 1; text-shadow: 0 0 30px var(--accent); } 50% { opacity: 0.4; } 100% { opacity: 1; text-shadow: 0 0 30px var(--accent); } }

        .panel { display: none; animation: fadeIn 0.4s ease-out; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .blur-text { filter: blur(5px); transition: 0.3s; cursor: pointer; }
        .blur-text.visible { filter: blur(0); }

        /* SINAV SORULARI İÇİN STİL */
        .exam-q-box { background: rgba(0,0,0,0.4); padding: 15px; border-left: 3px solid var(--accent); margin-bottom: 20px; }
        .exam-label { display: block; margin-bottom: 10px; color: var(--text-main); font-weight: bold; }
        .exam-radio-group { display: flex; flex-direction: column; gap: 5px; }
        .exam-radio-group label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9rem; color: #aaa; }
        .exam-radio-group input { width: auto; margin: 0; }

        @media screen and (max-width: 900px) {
            body { overflow: auto; background-attachment: scroll; }
            header { height: auto; flex-direction: column; gap: 10px; padding: 15px; text-align: center; }
            header > div { width: 100%; justify-content: center; }
            .workspace { flex-direction: column; overflow: visible; }
            aside { width: 100%; border-right: none; border-bottom: 2px solid var(--accent); padding: 10px 0; }
            #menu-guest, #menu-staff { display: flex !important; flex-direction: row; overflow-x: auto; white-space: nowrap; padding: 0 10px 10px 10px; gap: 10px; }
            #menu-guest[style*="none"], #menu-staff[style*="none"] { display: none !important; }
            .nav-btn { width: auto; padding: 8px 15px; border-right: none; border-bottom: 3px solid transparent; background: rgba(255,255,255,0.05); }
            .nav-btn.active { border-right: none; border-bottom-color: var(--accent); background: var(--accent-dim); }
            main { padding: 15px; }
            div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; gap: 15px !important; }
            .chat-container { grid-template-columns: 1fr; height: auto; }
            .chat-sidebar { height: 200px; margin-top: 15px; }
        }
    </style>
</head>
<body class="defcon-1">

    <div class="overlay-bg"></div>
    <div class="scanlines"></div>
    <canvas id="particles-js"></canvas>

    <div id="boot-screen">
        <div class="mit-logo-anim"></div>
        <h1 style="color:white; font-size:2.5rem; letter-spacing:5px; margin-bottom:20px; text-shadow:0 0 20px red;">MİT <span style="color:var(--accent)">SİBER AĞ</span></h1>
        <div id="boot-text"></div>
        <div style="margin-top:20px; width:300px; height:4px; background:#111; border-radius:2px; overflow:hidden;">
            <div style="width:100%; height:100%; background:var(--accent); animation: loadBar 3s ease-in-out;"></div>
        </div>
        <style>@keyframes loadBar { 0% { width:0; } 100% { width:100%; } }</style>
    </div>

    <div id="call-modal">
        <div class="call-pulse">
            <i class="fas fa-phone fa-3x" style="color:white"></i>
        </div>
        <h2 id="call-status" style="color:white; margin-bottom:10px;">GELEN ARAMA</h2>
        <p id="call-caller" style="color:var(--staff-blue); font-size:1.2rem; margin-bottom:30px;">...</p>
        <div id="call-actions" style="display:flex; gap:20px;">
            <button class="cyber-btn btn-green" onclick="app.phone.answerCall()">CEVAPLA</button>
            <button class="cyber-btn btn-red" onclick="app.phone.rejectCall()">REDDET</button>
        </div>
        <div id="in-call-ui" style="display:none; text-align:center;">
            <p style="color:#0f0;">BAĞLANTI GÜVENLİ (ŞİFRELİ)</p>
            <h1 id="call-timer" style="font-size:3rem; font-family:'Share Tech Mono'">00:00</h1>
            <button class="cyber-btn btn-red" style="margin-top:20px;" onclick="app.phone.endCall()">KAPAT</button>
        </div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <div id="hack-modal">
        <div class="glass-box" style="width:500px; border-color:var(--cyber-green);">
            <h3 style="color:var(--cyber-green); text-align:center;"><i class="fas fa-terminal"></i> KRİPTO DEŞİFRE MODÜLÜ</h3>
            <div id="hack-terminal"></div>
            <div style="margin-top:10px; background:#111; height:10px; width:100%; border:1px solid #333;">
                <div id="hack-progress-bar"></div>
            </div>
            <p id="hack-status" style="font-family:'Share Tech Mono'; color:white; text-align:center; margin-top:5px;">HEDEF: ŞİFREYİ KIR</p>
            <button id="btn-hack-action" class="cyber-btn" style="margin-top:15px; border-color:var(--cyber-green); color:var(--cyber-green);" onmousedown="app.hack.processHack()">BRUTE FORCE BAŞLAT</button>
            <button class="nav-btn" onclick="app.hack.closeHack()" style="margin-top:10px; text-align:center;">İPTAL</button>
        </div>
    </div>

    <div id="app-view-modal" style="display:none; overflow-y:auto; padding:20px;">
        <div class="glass-box" style="max-width:800px; width:100%; border-color:var(--admin-gold);">
            <h3 style="color:var(--admin-gold); text-align:center; border-bottom:1px solid #333; padding-bottom:10px;">BAŞVURU DOSYASI & SINAV SONUÇLARI</h3>
            <div id="app-view-content" style="margin-bottom:20px; max-height: 500px; overflow-y: auto;"></div>
            <div style="display:flex; gap:10px;">
                <button class="cyber-btn btn-green" onclick="app.approveAppCurrent()">ONAYLA</button>
                <button class="cyber-btn btn-red" onclick="app.rejectAppCurrent()">REDDET</button>
                <button class="cyber-btn" onclick="document.getElementById('app-view-modal').style.display='none'">KAPAT</button>
            </div>
        </div>
    </div>

    <div id="lockdown-screen">
        <i class="fas fa-biohazard fa-6x" style="margin-bottom:30px; animation: pulseAlert 1s infinite;"></i>
        <h1 style="font-size:4rem; margin-bottom:10px; font-family: 'Orbitron';">SİSTEM KİLİTLENDİ</h1>
        <p style="letter-spacing: 5px; font-size:1.5rem;">YETKİSİZ ERİŞİM TESPİTİ</p>
        <p style="margin-top:20px; color:#666; font-family:'Share Tech Mono'">PROTOKOL: KIZIL-ELMA // IP LOGLANDI</p>
    </div>

    <div class="app-wrapper" id="main-app">
        <header>
            <div style="display:flex; align-items:center; gap:20px;">
                <img src="https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png" height="60" style="filter: drop-shadow(0 0 15px var(--accent));">
                <div>
                    <h1 style="font-family:'Orbitron'; font-size:1.8rem; line-height:1; color:white;">MİT <span style="color:var(--accent)">KIZIL ELMA</span></h1>
                    <small style="color:#aaa; letter-spacing:2px; font-size:0.75rem;">SİBER SAVUNMA AĞI v43.0</small>
                </div>
            </div>
            <div style="text-align:right; font-family:'Share Tech Mono'; width:100%; text-align:center; margin-top:5px;">
                <div id="sys-clock" style="font-size:1.4rem; color:white;">00:00:00</div>
                <div id="net-status" style="font-size:0.8rem; color:var(--accent);"><i class="fas fa-shield-alt"></i> BAĞLANTI GÜVENLİ</div>
            </div>
        </header>

        <div class="workspace">
            <aside>
                <div style="text-align:center; padding: 20px; border-bottom: 1px solid #333; margin-bottom: 10px;">
                    <div style="width:70px; height:70px; border-radius:50%; border:2px solid var(--accent); margin:0 auto 15px; display:flex; align-items:center; justify-content:center; box-shadow: 0 0 20px var(--accent-glow); overflow:hidden; background:#000;">
                        <i class="fas fa-user-secret fa-2x" id="u-icon" style="color:white;"></i>
                        <img id="u-photo" style="display:none; width:100%; height:100%; object-fit:cover;">
                    </div>
                    <h3 id="u-name" style="font-size:1rem; margin-bottom:5px;">MİSAFİR</h3>
                    <p id="u-code" style="font-size:0.9rem; color:var(--staff-blue); font-weight:bold; letter-spacing:1px; display:none;">KOD: YOK</p>
                    <p id="u-role" style="font-size:0.7rem; color:#666;">ERİŞİM KISITLI</p>
                </div>

                <div id="menu-guest">
                    <button class="nav-btn active" onclick="app.nav('public')"><i class="fas fa-globe"></i> Duyurular</button>
                    <button class="nav-btn" onclick="app.nav('basvuru')"><i class="fas fa-user-plus"></i> Başvuru</button>
                    <button class="nav-btn" onclick="app.showLogin()" style="color:var(--accent);"><i class="fas fa-fingerprint"></i> Personel</button>
                </div>

                <div id="menu-staff" style="display:none;">
                    <button class="nav-btn active" onclick="app.nav('dashboard')"><i class="fas fa-th"></i> Komuta</button>
                    <button class="nav-btn" onclick="app.nav('reports')"><i class="fas fa-file-contract"></i> Rapor</button>
                    <button class="nav-btn" onclick="app.nav('ops')"><i class="fas fa-crosshairs"></i> Operasyon</button>
                    <button id="nav-cyber" class="nav-btn" onclick="app.nav('cyber')" style="color:var(--cyber-green);"><i class="fas fa-code"></i> SİBER</button>
                    <button id="nav-ai" class="nav-btn" onclick="app.nav('ai')" style="color:var(--ai-purple);"><i class="fas fa-brain"></i> Y.Z. GÖRÜNTÜ</button>
                    <button class="nav-btn" onclick="app.nav('chat')"><i class="fas fa-comments"></i> Chat</button>
                    <button class="nav-btn" onclick="app.nav('hr')"><i class="fas fa-users"></i> Ekip</button>
                    <button class="nav-btn" onclick="app.nav('db')"><i class="fas fa-database"></i> Sorgu</button>
                    <button class="nav-btn" onclick="app.logout()" style="color:var(--accent);"><i class="fas fa-power-off"></i> Çıkış</button>
                </div>
            </aside>

            <main>
                <div id="panel-public" class="panel active">
                    <div class="glass-box">
                        <h2><i class="fas fa-bullhorn"></i> RESMİ DUYURULAR</h2>
                        <div id="feed-public"></div>
                    </div>
                    <div class="glass-box"><h3>ARANANLAR</h3><div class="table-container"><table class="cyber-table" id="wanted-table"><thead><tr><th>KOD</th><th>SUÇ</th><th>DURUM</th></tr></thead><tbody></tbody></table></div></div>
                    <div class="glass-box" style="max-width:600px;">
                        <h3>İHBAR HATTI (ŞİFRELİ)</h3>
                        <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Kimliğiniz sistem tarafından gizli tutulacaktır.</p>
                        <input id="tip-subj" placeholder="İhbar Konusu">
                        <textarea id="tip-text" placeholder="Detaylar, Yer, Zaman, Eşkal..."></textarea>
                        <button class="cyber-btn" onclick="app.sendTip()">GÜVENLİ GÖNDER</button>
                    </div>
                </div>

                <div id="panel-basvuru" class="panel">
                    <div class="glass-box" style="max-width:800px; margin:0 auto;">
                        <h2 style="text-align:center;">MİLLİ İSTİHBARAT AKADEMİSİ</h2>
                        
                        <div id="app-step-1">
                            <h3 style="color:var(--staff-blue); border-bottom:1px solid #333; padding-bottom:10px;">AŞAMA 1: KİMLİK DOĞRULAMA</h3>
                            <label>TC Kimlik</label><input id="app-tc" maxlength="30">
                            <label>Ad Soyad</label><input id="app-name">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                <div><label>Cinsiyet</label><select id="app-gender"><option value="men">Erkek</option><option value="women">Kadın</option></select></div>
                                <div><label>Branş</label><select id="app-skill"><option value="siber">Siber İstihbarat</option><option value="saha">Saha Operasyon</option><option value="analiz">Stratejik Analiz</option></select></div>
                            </div>
                            <button class="cyber-btn" style="margin-top:20px;" onclick="app.goToExam()">SINAVA GEÇ <i class="fas fa-arrow-right"></i></button>
                        </div>

                        <div id="app-step-2" style="display:none;">
                            <h3 style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:10px;">AŞAMA 2: PERSONEL YETERLİLİK SINAVI</h3>
                            <p style="color:#666; font-size:0.8rem; margin-bottom:20px;">Aşağıdaki soruları dikkatle cevaplayınız. Cevaplarınız psikolojik analiz algoritmaları ile incelenecektir.</p>

                            <div class="exam-q-box">
                                <span class="exam-label">1. MİT'e katılma motivasyonunuzu tek cümle ile özetleyin.</span>
                                <input id="q1" placeholder="Cevabınız...">
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">2. "Devletin Bekası" kavramı sizin için ne ifade ediyor?</span>
                                <textarea id="q2" rows="2"></textarea>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">3. Bir operasyonda tim komutanınızın verdiği emrin sivillere zarar verebileceğini fark ettiniz. Ne yaparsınız?</span>
                                <div class="exam-radio-group">
                                    <label><input type="radio" name="q3" value="A"> Emri sorgusuz uygularım. Hiyerarşi esastır.</label>
                                    <label><input type="radio" name="q3" value="B"> Emri reddederim ve operasyonu durdururum.</label>
                                    <label><input type="radio" name="q3" value="C"> Emri teyit ederim, alternatif bir çözüm öneririm, emir kesinse uygularım.</label>
                                </div>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">4. Yakın bir arkadaşınızın devlet aleyhine faaliyet yürüttüğünü tespit ettiniz. İlk hamleniz?</span>
                                <div class="exam-radio-group">
                                    <label><input type="radio" name="q4" value="A"> Onunla konuşup vazgeçirmeye çalışırım.</label>
                                    <label><input type="radio" name="q4" value="B"> Derhal amirlerime rapor ederim ve takibe başlarım.</label>
                                    <label><input type="radio" name="q4" value="C"> İlişkimi keserim.</label>
                                </div>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">5. Yurt dışında deşifre oldunuz ve yakalanmak üzeresiniz. Yanınızda kriptolu veriler var. Ne yaparsınız?</span>
                                <div class="exam-radio-group">
                                    <label><input type="radio" name="q5" value="A"> Verileri imha eder, kaçmaya çalışırım.</label>
                                    <label><input type="radio" name="q5" value="B"> Verileri pazarlık unsuru olarak kullanırım.</label>
                                    <label><input type="radio" name="q5" value="C"> Teslim olurum.</label>
                                </div>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">6. Baskı ve stres altında karar verme mekanizmanızı 1-10 arası puanlayın.</span>
                                <select id="q6">
                                    <option value="10">10 - Mükemmel (Soğukkanlı)</option>
                                    <option value="8">8 - İyi</option>
                                    <option value="5">5 - Orta</option>
                                    <option value="1">1 - Paniklerim</option>
                                </select>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">7. Hangi alanda kendinizi daha yetkin görüyorsunuz?</span>
                                <div class="exam-radio-group">
                                    <label><input type="radio" name="q7" value="Teknik"> Teknik (Yazılım, Elektronik, Kripto)</label>
                                    <label><input type="radio" name="q7" value="Fiziki"> Fiziki (Takip, Operasyon, Silah)</label>
                                    <label><input type="radio" name="q7" value="İnsan"> İnsan İstihbaratı (İkna, Sorgu, Psikoloji)</label>
                                </div>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">8. Geçmişinizde herhangi bir yasadışı örgüte sempati duydunuz mu?</span>
                                <div class="exam-radio-group">
                                    <label><input type="radio" name="q8" value="Hayır"> Hayır, asla.</label>
                                    <label><input type="radio" name="q8" value="Evet"> Evet (Bu dürüstlüğünüz not edilecektir)</label>
                                </div>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">9. Görev gereği ailenizden ve kimliğinizden yıllarca vazgeçebilir misiniz?</span>
                                <textarea id="q9" rows="2"></textarea>
                            </div>

                            <div class="exam-q-box">
                                <span class="exam-label">10. Son olarak: "Vatan söz konusuysa..." cümlesini tamamlayın.</span>
                                <input id="q10">
                            </div>

                            <button class="cyber-btn btn-gold" onclick="app.submitExam()">BAŞVURUYU VE SINAVI TAMAMLA</button>
                            <button class="nav-btn" style="text-align:center; width:100%; margin-top:10px;" onclick="document.getElementById('app-step-2').style.display='none'; document.getElementById('app-step-1').style.display='block';">GERİ DÖN</button>
                        </div>

                    </div>
                </div>

                <div id="panel-dashboard" class="panel">
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:20px;">
                        <div class="glass-box" style="text-align:center;">
                            <small>TEHDİT SEVİYESİ</small>
                            <h1 id="defcon-disp" style="color:var(--accent); font-size:3rem; margin-top:5px;">1</h1>
                            <div id="defcon-controls" style="display:none; gap:5px; margin-top:10px; justify-content:center;">
                                <button class="cyber-btn btn-small" style="border-color:#00ff00; color:#00ff00;" onclick="app.setDefcon(5)">5</button>
                                <button class="cyber-btn btn-small" style="border-color:#ffff00; color:#ffff00;" onclick="app.setDefcon(4)">4</button>
                                <button class="cyber-btn btn-small" style="border-color:#ff8800; color:#ff8800;" onclick="app.setDefcon(3)">3</button>
                                <button class="cyber-btn btn-small" style="border-color:#ff0000; color:#ff0000;" onclick="app.setDefcon(1)">1</button>
                            </div>
                        </div>
                        <div class="glass-box" style="text-align:center;"><small>PERSONEL</small><h1 id="stat-staff" style="color:white;">0</h1></div>
                        <div class="glass-box" style="text-align:center;"><small>GÖREV</small><h1 id="stat-ops" style="color:var(--staff-blue);">0</h1></div>
                    </div>
                    <div class="glass-box"><h3>CANLI AKIŞ</h3><div id="dash-logs" style="height:200px; overflow-y:auto; color:#888; font-size:0.8rem;"></div></div>
                    <div class="glass-box" style="padding:0; height:400px;"><div id="map" style="height:100%;"></div></div>
                </div>

                <div id="panel-cyber" class="panel">
                    <div class="glass-box" style="border-color:var(--cyber-green);">
                        <h2 style="color:var(--cyber-green);">SİBER SAVAŞ & KRİPTO MERKEZİ</h2>
                        <div style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
                             <h4 style="color:var(--accent); margin-bottom:10px;">KRİPTOLU MESAJ OLUŞTUR (YÖNETİCİ)</h4>
                             <input id="crypto-input" placeholder="Gizli Mesaj İçeriği">
                             <button class="cyber-btn" style="border-color:var(--cyber-green); color:var(--cyber-green);" onclick="app.createCryptoMessage()">ŞİFRELE VE GÖNDER</button>
                        </div>
                        <div id="cyber-messages-list"></div>
                    </div>
                </div>

                <div id="panel-ai" class="panel">
                    <div class="glass-box" style="border-color:var(--ai-purple); max-width:800px; margin:0 auto;">
                        <h2 style="color:var(--ai-purple); text-align:center;">GEMINI VISION - GÖRÜNTÜ İSTİHBARATI</h2>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input id="ai-prompt" placeholder="Görüntü parametrelerini girin..." style="flex:1;">
                            <select id="ai-style" style="width:150px;">
                                <option value="">MOD SEÇ</option>
                                <option value="photorealistic">Realistik</option>
                                <option value="satellite">Uydu (SAT)</option>
                                <option value="cctv">CCTV Kamera</option>
                                <option value="sketch">Robot Resim</option>
                            </select>
                            <button class="cyber-btn btn-ai" style="width:120px;" onclick="app.generateAIImage()">OLUŞTUR</button>
                        </div>
                        <div id="ai-preview-area">
                            <div class="ai-loading-scan" id="ai-loader"></div>
                            <p id="ai-placeholder" style="color:#666; font-size:0.8rem;">GÖRÜNTÜ İŞLEME BEKLENİYOR...</p>
                            <img id="ai-generated-img" src="" onload="this.style.display='block'; document.getElementById('ai-loader').style.display='none'; document.getElementById('ai-placeholder').style.display='none';">
                        </div>
                        <p style="font-size:0.7rem; color:var(--ai-purple); margin-top:10px;">NOT: Görüntüler yapay zeka tarafından sentezlenmektedir. Kesin delil niteliği taşımaz.</p>
                    </div>
                </div>

                <div id="panel-reports" class="panel">
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px;">
                        <div class="glass-box">
                            <h3>RAPOR GÖNDER</h3>
                            <p style="font-size:0.7rem; color:var(--discord);">Bu rapor Discord kanalına iletilecektir.</p>
                            <select id="report-type"><option value="field">SAHA RAPORU</option><option value="intel">İSTİHBARAT</option></select>
                            <input id="report-subj" placeholder="Başlık">
                            <textarea id="report-content" rows="8" placeholder="Detay..."></textarea>
                            <button class="cyber-btn btn-blue" style="width:100%" onclick="app.submitReport()">HAVUZA & DISCORD'A İLET</button>
                        </div>
                        <div class="glass-box">
                            <h3>HAVUZ</h3>
                            <div id="reports-feed" style="height:500px; overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-chat" class="panel">
                    <div class="glass-box" style="max-width:1000px; margin:0 auto;">
                        <h2 style="text-align:center; color:var(--staff-blue);">GÜVENLİ HAT (KOD ADI)</h2>
                        <div class="chat-container">
                            <div class="chat-main">
                                <div class="chat-window" id="chat-window"></div>
                                <div class="chat-inputs">
                                    <button class="cyber-btn btn-small" style="width:40px;" onclick="document.getElementById('chat-file').click()"><i class="fas fa-paperclip"></i></button>
                                    <input type="file" id="chat-file" style="display:none" onchange="app.sendFileChat(this)">
                                    <input id="chat-input" placeholder="Mesajınız..." style="margin:0; flex:1;">
                                    <button id="btn-mic" class="cyber-btn btn-small" style="width:40px;" onmousedown="app.startVoice()" onmouseup="app.stopVoice()" onmouseleave="app.stopVoice()"><i class="fas fa-microphone"></i></button>
                                    <button class="cyber-btn" onclick="app.sendChat()" style="width:100px; border-color:var(--staff-blue); color:var(--staff-blue);">GÖNDER</button>
                                </div>
                            </div>
                            <div class="chat-sidebar">
                                <h3 style="color:var(--accent); font-size:1rem; border-bottom:1px solid #333; padding-bottom:5px;">AKTİF PERSONEL</h3>
                                <div id="active-user-list"><small style="color:#666">Yükleniyor...</small></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-ops" class="panel">
                    <div class="glass-box">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h2>OPERASYON LİSTESİ</h2>
                            <button class="cyber-btn btn-small" onclick="document.getElementById('new-op-modal').style.display='block'">+ YENİ GÖREV</button>
                        </div>
                        <div id="new-op-modal" style="display:none; background:#000; padding:20px; border:1px solid var(--accent); margin:20px 0;">
                            <h3>GÖREV EMRİ</h3>
                            <p style="color:var(--discord); font-size:0.7rem;">Operasyon emri Discord kanalına düşecektir.</p>
                            <input id="op-name" placeholder="Kod Adı">
                            <label>Lider</label><select id="op-lead"></select>
                            <button class="cyber-btn" onclick="app.addOp()">BAŞLAT</button>
                            <button class="cyber-btn" style="border-color:#555; color:#555;" onclick="document.getElementById('new-op-modal').style.display='none'">İPTAL</button>
                        </div>
                        <div class="table-container"><table class="cyber-table" id="ops-table"><thead><tr><th>GÖREV</th><th>LİDER</th><th>DURUM</th><th>AKSİYON</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>

                <div id="panel-hr" class="panel">
                    <div id="admin-tools" class="glass-box" style="display:none; border-color:var(--admin-gold);">
                        <h3 style="color:var(--admin-gold);"><i class="fas fa-cogs"></i> YÖNETİCİ KONSOLU</h3>
                        <div style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
                            <label style="color:var(--text-main); font-weight:bold;">TEHDİT SEVİYESİ (DEFCON)</label>
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <button class="cyber-btn btn-small" style="border-color:#00ff00; color:#00ff00;" onclick="app.setDefcon(5)">YEŞİL (5)</button>
                                <button class="cyber-btn btn-small" style="border-color:#ffff00; color:#ffff00;" onclick="app.setDefcon(4)">SARI (4)</button>
                                <button class="cyber-btn btn-small" style="border-color:#ff8800; color:#ff8800;" onclick="app.setDefcon(3)">TURUNCU (3)</button>
                                <button class="cyber-btn btn-small" style="border-color:#ff0000; color:#ff0000;" onclick="app.setDefcon(1)">KIRMIZI (1)</button>
                            </div>
                        </div>

                        <h3 style="color:var(--admin-gold); margin-top:15px;">DUYURU YAYINLA</h3>
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                            <input id="ann-title" placeholder="Duyuru Başlığı" style="flex:1; min-width:200px;">
                            <select id="ann-type" style="width:150px;"><option value="info">Bilgi</option><option value="critical">KRİTİK</option></select>
                        </div>
                        <textarea id="ann-msg" rows="2" placeholder="Mesaj..."></textarea>
                        <button class="cyber-btn btn-gold" onclick="app.adminPostAnnounce()">YAYINLA</button>
                        
                        <h4 style="color:var(--accent); margin-top:20px;">KRİPTO MESAJ SİLME</h4>
                        <div id="admin-crypto-list" style="max-height:150px; overflow-y:auto; border:1px solid #333; padding:5px;"></div>
                    </div>

                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:25px;">
                        <div class="glass-box">
                            <h3 id="hr-table-title">EKİP LİSTESİ</h3>
                            <div style="max-height:500px; overflow-y:auto;" class="table-container">
                                <table class="cyber-table" id="hr-staff-table"><thead id="hr-table-head"></thead><tbody id="hr-table-body"></tbody></table>
                            </div>
                        </div>
                        <div class="glass-box" style="text-align:center;">
                            <h3>DİJİTAL KİMLİK SİSTEMİ</h3>
                            <canvas id="idCardCanvas" width="1000" height="600" style="width:100%; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.8);"></canvas>
                            <br><br>
                            <div id="id-actions"></div>
                        </div>
                    </div>
                    
                    <div id="admin-apps-section" style="display:none;">
                        <div class="glass-box">
                            <h3>BEKLEYEN BAŞVURULAR</h3>
                            <div id="hr-apps-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;"></div>
                        </div>
                        <div class="glass-box">
                            <h3>VATANDAŞ İHBARLARI (WHISTLEBLOWER)</h3>
                            <div id="hr-tips-list" style="max-height:300px; overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-db" class="panel">
                    <div class="glass-box">
                        <h2>GDBS SORGU</h2>
                        <input id="db-q" placeholder="TC Kimlik / Ad Soyad / Plaka">
                        <button class="cyber-btn" onclick="app.queryDB()">SİSTEMDE ARA</button>
                        <div id="db-res" style="margin-top:20px;"></div>
                    </div>
                    <div class="glass-box"><h3>DENETİM İZLERİ</h3><div class="table-container"><table class="cyber-table" id="audit-table"><thead><tr><th>ZAMAN</th><th>KULLANICI</th><th>DETAY</th></tr></thead><tbody></tbody></table></div></div>
                </div>

            </main>
        </div>
    </div>

    <div id="login-modal">
        <div class="glass-box" style="width:450px; text-align:center; border:2px solid var(--accent); position:relative;">
            <i class="fas fa-lock hidden-trigger" onclick="app.secretUnlock()"></i>
            <i class="fas fa-shield-alt fa-3x" style="color:var(--accent); margin-bottom:15px;"></i>
            <h3>GÜVENLİK PROTOKOLÜ</h3>
            <div id="login-form-init">
                <input type="password" id="login-pass" placeholder="ERİŞİM ANAHTARI" style="text-align:center; letter-spacing:5px;">
                <button class="cyber-btn" onclick="app.loginStep1()">DOĞRULA</button>
                <p id="login-msg" style="margin-top:10px; color:var(--accent);"></p>
            </div>
            <div id="login-form-sec" style="display:none; margin-top:20px;">
                <div class="sec-matrix"><div class="sec-circle"></div><div class="sec-circle"></div><div class="sec-scan-line"></div><div class="sec-text">BİYOMETRİK VERİ ANALİZİ...</div></div>
                <button class="decoy-btn" onclick="app.fakeScan()"><i class="fas fa-fingerprint fa-2x"></i><br>TARAMAYI BAŞLAT</button>
                <p style="font-size:0.7rem; color:#666; margin-top:10px;">YETKİSİZ ERİŞİM TESPİT EDİLDİĞİNDE SİSTEM KİLİTLENİR.</p>
            </div>
            <button class="nav-btn" onclick="document.getElementById('login-modal').style.display='none'" style="justify-content:center; margin-top:15px;">İPTAL</button>
        </div>
    </div>

    <div id="edit-modal">
        <div class="glass-box" style="width:400px; border-color:var(--admin-gold);">
            <h3 style="color:var(--admin-gold);">PERSONEL DÜZENLE</h3>
            <input type="hidden" id="edit-id">
            <label>Ad Soyad</label><input id="edit-name">
            <label>Kod Adı</label><input id="edit-code">
            <label>Rütbe / Ünvan</label><input id="edit-rank" placeholder="Örn: SAHA UZMANI, DAİRE BAŞKANI">
            <label>Yetki Seviyesi</label>
            <select id="edit-role">
                <option value="staff">Personel</option>
                <option value="admin">Yönetici</option>
                <option value="cyber">Siber Uzman</option>
                <option value="agent">Saha Ajanı</option>
                <option value="analyst">Analist</option>
            </select>
            <label style="color:var(--accent);">Yeni Şifre (Opsiyonel)</label>
            <input id="edit-pass" placeholder="Değiştirmek için yeni şifreyi yazın..." style="border:1px dashed var(--accent);">
            <button class="cyber-btn btn-gold" style="width:100%" onclick="app.saveEdit()">KAYDET & GÜNCELLE</button>
            <button class="nav-btn" onclick="document.getElementById('edit-modal').style.display='none'" style="text-align:center; width:100%">İPTAL</button>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- FIREBASE AYARLARI ---
    const firebaseConfig = { apiKey: "AIzaSyD4mXN8BZ3OMzl35vtEbNGA9BUuHPgoqQU", authDomain: "mit-sistemi.firebaseapp.com", databaseURL: "https://mit-sistemi-default-rtdb.europe-west1.firebasedatabase.app", projectId: "mit-sistemi", storageBucket: "mit-sistemi.firebasestorage.app", messagingSenderId: "195453377116", appId: "1:195453377116:web:85067f5070ecf983bb6499" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- SİSTEM SABİTLERİ ---
    const CONFIG = {
        WEB_REP: "https://discord.com/api/webhooks/1462228533509361839/fZmCO4aEvvwKT_01NGI-KY5rs7t5rQyYIxaaLylENigt13K0EVPbuH7nKfQgSkWQ2nP7",
        WEB_OPS: "https://discord.com/api/webhooks/1462228977346412736/XyP1g3QXXOoXcg9vFnr5DMJ0PMygNHEx-TjhyMzBokQ1b8D9hZ-HGUubZKZUJSJHdi-X",
        TAG_REP: "<@997276536250056855>",
        TAG_OPS: "<@997275075839528970>"
    };

    const ROLE_DEFS = { 'admin': { label: 'YÖNETİCİ', color: '#ffcc00' }, 'staff': { label: 'PERSONEL', color: '#fff' }, 'cyber': { label: 'SİBER UZMAN', color: '#00ff41' }, 'agent': { label: 'SAHA AJANI', color: '#00ccff' }, 'analyst': { label: 'ANALİST', color: '#bd00ff' } };
    const SFX = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        playTone: function(freq, type, dur) { if(this.ctx.state==='suspended')this.ctx.resume(); const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(this.ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime+dur); o.stop(this.ctx.currentTime+dur); },
        click: function() { this.playTone(1200, 'sine', 0.1); }, hover: function() { this.playTone(400, 'triangle', 0.05); }, error: function() { this.playTone(150, 'sawtooth', 0.3); setTimeout(()=>this.playTone(100,'sawtooth',0.3),150); }, success: function() { this.playTone(800, 'sine', 0.1); setTimeout(()=>this.playTone(1200,'sine',0.2),100); }, boot: function() { try { let t=0; for(let i=0;i<5;i++){ setTimeout(()=>this.playTone(200+(i*100), 'square', 0.1), t); t+=100; } } catch(e){} }, ring: function() { const now=this.ctx.currentTime; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); o.frequency.setValueAtTime(800,now); o.frequency.setValueAtTime(600,now+0.4); g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.00001,now+0.8); o.start(now); o.stop(now+0.8); }, hack: function() { this.playTone(3000, 'square', 0.05); }
    };

    // --- TELEFON SİSTEMİ (SESLİ ARAMA ENTEGRASYONU) ---
    const phoneSystem = {
        peer: null, activeCall: null, myStream: null, ringInterval: null,
        init: function(userId) {
            const randomSuffix = Math.floor(Math.random() * 10000);
            const dynamicId = userId + "_" + randomSuffix; 
            this.peer = new Peer(dynamicId); 
            this.peer.on('open', (id) => {
                database.ref('online_users/' + userId).set({ peerId: id, name: app.state.user.codename, status: 'online' });
                database.ref('online_users/' + userId).onDisconnect().remove();
            });
            this.peer.on('error', (err) => { console.error("PeerJS Error:", err); });
            this.peer.on('call', (call) => { this.incomingCall(call); });
        },
        callUser: function(targetPeerId, targetName) {
            if(!targetPeerId) return alert("Kullanıcı çevrimdışı veya hatta değil.");
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                this.myStream = stream; const call = this.peer.call(targetPeerId, stream); this.setupCallUI(call, targetName, "ARANIYOR...");
            }).catch(err => { alert("Mikrofon izni gerekli!"); });
        },
        incomingCall: function(call) {
            this.activeCall = call; document.getElementById('call-modal').style.display = 'flex';
            document.getElementById('call-status').innerText = "GELEN ARAMA"; document.getElementById('call-caller').innerText = "BİLİNMEYEN NUMARA"; 
            document.getElementById('call-actions').style.display = 'flex'; document.getElementById('in-call-ui').style.display = 'none';
            this.ringInterval = setInterval(() => SFX.ring(), 1500);
        },
        answerCall: function() {
            clearInterval(this.ringInterval);
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                this.myStream = stream; this.activeCall.answer(stream); this.setupCallUI(this.activeCall, "BAĞLANDI", "GÖRÜŞME SÜRÜYOR");
            });
        },
        rejectCall: function() { clearInterval(this.ringInterval); if(this.activeCall) this.activeCall.close(); document.getElementById('call-modal').style.display = 'none'; },
        endCall: function() {
            if(this.activeCall) this.activeCall.close(); if(this.myStream) this.myStream.getTracks().forEach(track => track.stop());
            document.getElementById('call-modal').style.display = 'none'; app.logAudit("TELEFON", "Görüşme sonlandırıldı.");
        },
        setupCallUI: function(call, name, statusText) {
            this.activeCall = call; document.getElementById('call-modal').style.display = 'flex';
            document.getElementById('call-status').innerText = statusText; document.getElementById('call-caller').innerText = name || "GİZLİ HAT";
            document.getElementById('call-actions').style.display = 'none'; document.getElementById('in-call-ui').style.display = 'block';
            let sec = 0; const timer = document.getElementById('call-timer');
            const interval = setInterval(() => { if(!this.activeCall || !this.activeCall.open) { clearInterval(interval); return; } sec++; const m = Math.floor(sec/60).toString().padStart(2,'0'); const s = (sec%60).toString().padStart(2,'0'); timer.innerText = `${m}:${s}`; }, 1000);
            call.on('stream', (remoteStream) => { const audio = document.getElementById('remote-audio'); audio.srcObject = remoteStream; audio.play().catch(e => console.log("Otomatik oynatma engellendi.")); });
            call.on('close', () => { clearInterval(interval); this.endCall(); });
        }
    };

    // --- ANA UYGULAMA ---
    const app = {
        defaultData: {
            defcon: 1,
            personnel: [
                { id: 'ADM-001', name: 'HAKAN F.', codename: 'KARTAL', role: 'admin', rank: 'MÜSTEŞAR', pass: 'TURAN', gender:'men', photoId:33, cover: {fakeName: 'Ahmet Yılmaz', fakeJob: 'Akademisyen', fakePhotoId: 10} },
                { id: 'OPS-007', name: 'ZÜMRÜT K.', codename: 'ANKA', role: 'staff', rank: 'SAHA UZMANI', pass: '1234', gender:'women', photoId:45, cover: {fakeName: 'Ayşe Demir', fakeJob: 'Eczacı', fakePhotoId: 22} }
            ],
            reports: [], apps: [], tips: [], ops: [],
            chat: [{user:'SİSTEM', msg:'Ağ aktif.', time:'00:00', type:'text'}],
            cryptoMessages: [], audit: [],
            announcements: [{title: "SİSTEM GÜNCEL", msg: "v43.0 INTEGRATED SYSTEM", type: "critical", date: new Date().toLocaleDateString()}],
            wanted: [{name:'GÖLGE', crime:'Casusluk', status:'ARANIYOR'}]
        },

        state: { user: null, fail: 0, visiblePass: new Set(), tUser: null, genCode: null, db: null, mediaRec: null, audioChunks: [], onlineUsers: {}, viewingAppIdx: null },
        phone: phoneSystem,

        hack: {
            activeMsgId: null, progress: 0,
            startHack: function(id) { this.activeMsgId = id; this.progress = 0; document.getElementById('hack-modal').style.display = 'flex'; this.renderTerminal(); },
            renderTerminal: function() { const term = document.getElementById('hack-terminal'); term.innerHTML = ''; for(let i=0; i<15; i++) { const row = document.createElement('div'); row.className = 'hack-row'; row.innerHTML = Array(20).fill(0).map(() => `<span class="hack-char">${Math.floor(Math.random()*2)}</span>`).join(''); term.appendChild(row); } },
            processHack: function() { this.progress += 5; SFX.hack(); document.getElementById('hack-progress-bar').style.width = this.progress + '%'; if(this.progress >= 100) this.finishHack(); },
            finishHack: function() { SFX.success(); alert("ŞİFRE ÇÖZÜLDÜ!"); const msg = app.state.db.cryptoMessages.find(m => m.id === this.activeMsgId); if(msg) msg.status = 'OPEN'; app.save(); this.closeHack(); app.renderCyber(); },
            closeHack: function() { document.getElementById('hack-modal').style.display = 'none'; this.progress = 0; }
        },

        init: function() {
            this.bootSequence();
            this.listenToCloud();
            document.querySelectorAll('button, .nav-btn').forEach(b => { b.addEventListener('mouseenter', ()=>SFX.hover()); b.addEventListener('click', ()=>SFX.click()); });
        },

        listenToCloud: function() {
            database.ref('mit_database').on('value', (snapshot) => { const data = snapshot.val(); if (data) { this.state.db = data; } else { this.state.db = this.defaultData; this.save(); } this.refreshCurrentView(); this.applyDefcon(this.state.db.defcon); });
            database.ref('online_users').on('value', (snap) => { this.state.onlineUsers = snap.val() || {}; if(document.getElementById('panel-chat').classList.contains('active')) this.renderChat(); if(document.getElementById('panel-hr').classList.contains('active')) this.renderHR(); });
        },

        save: function() { if(this.state.db) { database.ref('mit_database').set(this.state.db).catch(e => console.error(e)); } },

        refreshCurrentView: function() {
            if(document.getElementById('panel-hr').classList.contains('active')) this.renderHR();
            if(document.getElementById('panel-public').classList.contains('active')) this.renderPublic();
            if(document.getElementById('panel-chat').classList.contains('active')) this.renderChat();
            if(document.getElementById('panel-ops').classList.contains('active')) this.renderOps();
            if(document.getElementById('panel-db').classList.contains('active')) this.renderLogs();
            if(document.getElementById('panel-reports').classList.contains('active')) this.renderReports();
            if(document.getElementById('panel-dashboard').classList.contains('active')) this.updateDash();
            if(document.getElementById('panel-cyber').classList.contains('active')) this.renderCyber();
        },

        bootSequence: function() {
            const s = document.getElementById('boot-screen'); if(!s) { this.initAppLogic(); return; }
            const t = document.getElementById('boot-text'); const lines = ["BIOS DATE 01/20/26 15:00:00", "establishing uplink...... SUCCESS", "INITIATING KIZIL_ELMA PROTOCOL..."]; let i = 0;
            try { SFX.boot(); } catch(e){}
            const int = setInterval(() => { if(i < lines.length) { t.innerHTML += lines[i] + "<br>"; i++; } else { clearInterval(int); s.style.opacity = '0'; document.getElementById('main-app').style.opacity = '1'; setTimeout(() => { s.style.display='none'; this.initAppLogic(); }, 1000); } }, 150);
        },

        initAppLogic: function() { this.updateClock(); setInterval(() => this.updateClock(), 1000); this.initParticles(); this.nav('public'); },
        setDefcon: function(lvl) { this.state.db.defcon = lvl; this.save(); },
        applyDefcon: function(lvl) { document.body.className = `defcon-${lvl}`; const el = document.getElementById('defcon-disp'); if(el) el.innerText = lvl; },
        initParticles: function() { const cvs=document.getElementById('particles-js'), ctx=cvs.getContext('2d'); cvs.width=window.innerWidth; cvs.height=window.innerHeight; let pts=[]; for(let i=0;i<50;i++) pts.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, vx:(Math.random()-.5), vy:(Math.random()-.5)}); function anim(){ ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle='rgba(255,255,255,0.1)'; pts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>cvs.width)p.vx*=-1; if(p.y<0||p.y>cvs.height)p.vy*=-1; ctx.beginPath(); ctx.arc(p.x,p.y,1.5,0,6.28); ctx.fill(); }); requestAnimationFrame(anim); } anim(); },

        sendDiscord: async function(url, tag, title, desc, color, fields) { const p = { username: "MİT İSTİHBARAT", avatar_url: "https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png", content: tag, embeds: [{title, description: desc, color, fields, footer: { text: "KIZIL ELMA v43.0" }, timestamp: new Date()}] }; try { await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(p) }); } catch(e){} },

        nav: function(id) { document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); document.getElementById('panel-' + id).classList.add('active'); if(id === 'map') setTimeout(() => this.initMap(), 200); this.refreshCurrentView(); },

        showLogin: function() { document.getElementById('login-modal').style.display='flex'; document.getElementById('login-form-init').style.display='block'; document.getElementById('login-form-sec').style.display='none'; document.getElementById('login-pass').value=''; document.getElementById('login-msg').innerText=''; this.state.fail = 0; },
        loginStep1: function() { if(!this.state.db) return alert("Sistem yükleniyor..."); const p = document.getElementById('login-pass').value.trim(); const u = this.state.db.personnel.find(x => x.pass === p); if(u){ this.state.tUser=u; SFX.success(); document.getElementById('login-form-init').style.display='none'; document.getElementById('login-form-sec').style.display='block'; } else { SFX.error(); this.failLogin(); } },
        fakeScan: function() { SFX.error(); alert("⚠️ ERİŞİM REDDEDİLDİ: BİYOMETRİK VERİ UYUŞMAZLIĞI!\n\nGüvenlik protokolü ihlali tespit edildi."); this.failLogin(); },
        secretUnlock: function() { if(!this.state.tUser) return; SFX.success(); this.finishLogin(); },
        finishLogin: function() {
            this.state.user=this.state.tUser; this.state.fail=0; this.phone.init(this.state.user.id);
            document.getElementById('login-modal').style.display='none'; document.getElementById('menu-guest').style.display='none'; document.getElementById('menu-staff').style.display='block';
            document.getElementById('u-name').innerText=this.state.user.name; document.getElementById('u-code').innerText="KOD: "+this.state.user.codename; document.getElementById('u-code').style.display='block';
            const rDef = ROLE_DEFS[this.state.user.role] || {label:'PERSONEL', color:'#ccc'};
            document.getElementById('u-role').innerText=rDef.label; document.getElementById('u-role').style.color=rDef.color;
            document.getElementById('u-photo').src=`https://randomuser.me/api/portraits/${this.state.user.gender}/${this.state.user.photoId}.jpg`; document.getElementById('u-photo').style.display='block'; document.getElementById('u-icon').style.display='none';
            this.logAudit('GİRİŞ', `${this.state.user.codename} sisteme girdi.`); this.nav('dashboard');
        },
        failLogin: function(){ this.state.fail++; document.getElementById('login-msg').innerText=`HATA (${this.state.fail}/3)`; if(this.state.fail>=3){ SFX.error(); document.getElementById('lockdown-screen').style.display='flex'; } },
        logout: function() { location.reload(); },

        createCryptoMessage: function() { if(this.state.user.role !== 'admin') return alert("Yetkisiz!"); const txt = document.getElementById('crypto-input').value; if(!txt) return; const encrypted = btoa(unescape(encodeURIComponent(txt))).split('').map(c => c.charCodeAt(0).toString(16)).join(' ').toUpperCase(); if(!this.state.db.cryptoMessages) this.state.db.cryptoMessages = []; this.state.db.cryptoMessages.unshift({ id: Date.now(), sender: this.state.user.codename, content: txt, encrypted: encrypted.substring(0, 50) + "...", status: 'LOCKED', date: new Date().toLocaleString() }); this.save(); alert("Kriptolandı."); document.getElementById('crypto-input').value = ''; },
        deleteCrypto: function(id) { if(confirm("Mesajı kalıcı olarak sil?")) { const idx = this.state.db.cryptoMessages.findIndex(m => m.id === id); if(idx > -1) { this.state.db.cryptoMessages.splice(idx, 1); this.save(); this.renderHR(); alert("Mesaj imha edildi."); } } },

        generateAIImage: function() {
            const prompt = document.getElementById('ai-prompt').value.trim(); const style = document.getElementById('ai-style').value;
            if(!prompt) { SFX.error(); return alert("Görüntü parametresi (prompt) girilmedi!"); }
            document.getElementById('ai-loader').style.display = 'block'; document.getElementById('ai-placeholder').style.display = 'block'; document.getElementById('ai-placeholder').innerText = "GEMINI VISION İŞLENİYOR... %0"; document.getElementById('ai-generated-img').style.display = 'none'; SFX.click();
            let progress = 0; const int = setInterval(() => { progress += 10; if(progress <= 90) document.getElementById('ai-placeholder').innerText = `GEMINI VISION İŞLENİYOR... %${progress}`; else clearInterval(int); }, 200);
            let fullPrompt = prompt; if(style === 'satellite') fullPrompt = "satellite view map photography, high resolution, tactical " + prompt; else if(style === 'cctv') fullPrompt = "cctv security camera footage, low quality, surveillance " + prompt; else if(style === 'sketch') fullPrompt = "police sketch, hand drawn pencil, suspect portrait " + prompt; else if(style === 'photorealistic') fullPrompt = "photorealistic 8k, cinematic lighting " + prompt;
            const encodedPrompt = encodeURIComponent(fullPrompt); const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true`;
            setTimeout(() => { const img = document.getElementById('ai-generated-img'); img.src = url; img.onload = () => { clearInterval(int); document.getElementById('ai-loader').style.display = 'none'; document.getElementById('ai-placeholder').style.display = 'none'; img.style.display = 'block'; SFX.success(); }; img.onerror = () => { alert("Görüntü oluşturulamadı (Sunucu Hatası)."); document.getElementById('ai-loader').style.display = 'none'; }; }, 2000);
        },

        renderCyber: function() {
            const list = document.getElementById('cyber-messages-list'); list.innerHTML = '';
            if(!this.state.db.cryptoMessages || this.state.db.cryptoMessages.length === 0) { list.innerHTML = '<p style="color:#666">Veri yok.</p>'; return; }
            this.state.db.cryptoMessages.forEach(msg => { let bodyHTML = msg.status === 'LOCKED' ? `<div class="crypto-glitch">${msg.encrypted}</div><div style="margin-top:10px;"><button class="cyber-btn btn-small" onclick="app.hack.startHack(${msg.id})">ŞİFREYİ ÇÖZ</button></div>` : `<div style="color:white; font-weight:bold; border-left:3px solid var(--cyber-green); padding-left:10px;">${msg.content}</div><div style="margin-top:5px; color:#666; font-size:0.8rem;">DEŞİFRE EDİLDİ</div>`; list.innerHTML += `<div class="crypto-card"><div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; margin-bottom:10px;"><span style="color:#aaa;">GÖNDEREN: ${msg.sender}</span><span style="color:#aaa;">${msg.date}</span></div>${bodyHTML}</div>`; });
        },

        renderReports: function() { const f = document.getElementById('reports-feed'); f.innerHTML=''; if(!this.state.db || !this.state.db.reports) return; this.state.db.reports.forEach(r => { f.innerHTML+=`<div class="report-card ${r.type==='op'?'report-op':''}"><div class="discord-tag">SENT > WEBHOOK</div><div style="display:flex; justify-content:space-between;"><span style="color:white; font-weight:bold;">${r.subject}</span><span style="color:#666; font-size:0.7rem;">${r.author} | ${r.date}</span></div><p style="color:#aaa; margin-top:5px; font-size:0.9rem;">${r.content}</p></div>`; }); },
        submitReport: function() { const t=document.getElementById('report-type').value, s=document.getElementById('report-subj').value, c=document.getElementById('report-content').value; if(!s||!c){ SFX.error(); return alert("Eksik!"); } if(!this.state.db.reports) this.state.db.reports = []; this.state.db.reports.unshift({author:this.state.user.codename, type:t, subject:s, content:c, date:new Date().toLocaleString()}); this.save(); this.sendDiscord(CONFIG.WEB_REP, CONFIG.TAG_REP, "📝 SAHA RAPORU", `**${s}**`, 3447003, [{name:"Ajan",value:this.state.user.codename, inline:true}, {name:"Tip",value:t.toUpperCase(), inline:true}, {name:"İçerik",value:c}]); document.getElementById('report-subj').value=''; document.getElementById('report-content').value=''; SFX.success(); },

        renderOps: function() { const t=document.querySelector('#ops-table tbody'); t.innerHTML=''; const sel=document.getElementById('op-lead'); sel.innerHTML=''; if(!this.state.db || !this.state.db.ops) return; this.state.db.personnel.forEach(p=>sel.innerHTML+=`<option value="${p.codename}">${p.codename}</option>`); this.state.db.ops.forEach((o,i)=>{ t.innerHTML+=`<tr><td style="color:white">${o.name}</td><td>${o.lead}</td><td style="color:${o.status==='AKTİF'?'var(--accent)':'#666'}">${o.status}</td><td>${o.status==='AKTİF'?`<button class="cyber-btn btn-small" onclick="app.endOp(${i})">BİTİR</button>`:'-'}</td></tr>`; }); },
        addOp: function() { const n=document.getElementById('op-name').value, l=document.getElementById('op-lead').value; if(!n)return; if(!this.state.db.ops) this.state.db.ops = []; this.state.db.ops.unshift({name:n, lead:l, status:'AKTİF'}); this.save(); document.getElementById('new-op-modal').style.display='none'; this.sendDiscord(CONFIG.WEB_OPS, CONFIG.TAG_OPS, "🚨 YENİ GÖREV EMRİ", `**Operasyon:** ${n}`, 15158332, [{name:"Tim Lideri",value:l,inline:true}, {name:"Durum",value:"BAŞLATILDI",inline:true}]); SFX.success(); },
        endOp: function(i) { this.state.db.ops[i].status='PASİF'; this.save(); },

        renderHR: function() {
            if(!this.state.user) return;
            const isAdmin = this.state.user.role==='admin';
            document.getElementById('admin-tools').style.display=isAdmin?'block':'none';
            document.getElementById('admin-apps-section').style.display=isAdmin?'block':'none';
            document.getElementById('hr-table-head').innerHTML=isAdmin?`<tr><th>İSİM</th><th>KOD</th><th>ROL</th><th>SAHTE</th><th>ŞİFRE</th><th>İŞLEM</th></tr>`:`<tr><th>KOD ADI</th><th>RÜTBE</th><th>DURUM</th><th>İLETİŞİM</th></tr>`;
            const body=document.getElementById('hr-table-body'); body.innerHTML='';
            
            if(isAdmin) {
                const cryptoList = document.getElementById('admin-crypto-list'); cryptoList.innerHTML = '';
                if(this.state.db.cryptoMessages && this.state.db.cryptoMessages.length > 0) { this.state.db.cryptoMessages.forEach(m => { cryptoList.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px;"><span style="color:#aaa; font-size:0.8rem;">${m.date} - ${m.status}</span><button class="cyber-btn btn-small btn-red" onclick="app.deleteCrypto(${m.id})">SİL</button></div>`; }); } else { cryptoList.innerHTML = '<small style="color:#666">Mesaj yok.</small>'; }
            }

            if(!this.state.db.personnel) this.state.db.personnel = [];
            this.state.db.personnel.forEach(p=>{
                const rStyle = ROLE_DEFS[p.role] || {label:p.role.toUpperCase(), color:'#fff'};
                const isOnline = this.state.onlineUsers[p.id] ? true : false; 
                const peerId = isOnline ? this.state.onlineUsers[p.id].peerId : null;
                const isMe = p.id === this.state.user.id;
                
                if(isAdmin){
                    const vis=this.state.visiblePass.has(p.id);
                    body.innerHTML+=`<tr><td>${p.name}</td><td style="color:var(--accent);font-weight:bold;">${p.codename}</td><td style="color:${rStyle.color}">${rStyle.label}</td><td><div style="font-size:0.7rem;color:var(--staff-blue)">${p.cover.fakeName}</div></td><td><span class="blur-text ${vis?'visible':''}" onclick="app.togglePass('${p.id}')">${p.pass}</span></td><td><button class="cyber-btn btn-small btn-gold" onclick="app.editUser('${p.id}')"><i class="fas fa-edit"></i></button><button class="cyber-btn btn-small" onclick="app.drawID('${p.id}','REAL')">R</button><button class="cyber-btn btn-small btn-fake" onclick="app.drawID('${p.id}','FAKE')">S</button><button class="cyber-btn btn-small" style="border-color:#555;" onclick="app.fireStaff('${p.id}')">X</button></td></tr>`;
                } else {
                    let callBtn = "-"; 
                    if(isOnline && !isMe) { callBtn = `<button class="cyber-btn btn-small btn-green" onclick="app.phone.callUser('${peerId}', '${p.codename}')"><i class="fas fa-phone"></i> ARA</button>`; } 
                    else if (!isOnline) { callBtn = `<span style="color:#666; font-size:0.7rem;">ÇEVRİMDIŞI</span>`; }
                    body.innerHTML+=`<tr><td style="color:var(--staff-blue)">${p.codename}</td><td><span style="color:${rStyle.color}">${rStyle.label}</span></td><td style="color:${isOnline?'var(--success)':'#666'}">${isOnline?'ONLINE':'OFFLINE'}</td><td>${callBtn}</td></tr>`;
                }
            });

            if(isAdmin){
                const l=document.getElementById('hr-apps-list'); l.innerHTML=this.state.db.apps && this.state.db.apps.length?'':'<span style="color:#666">Bekleyen yok.</span>';
                if(this.state.db.apps) { this.state.db.apps.forEach((a,i)=>{ l.innerHTML+=`<div style="background:#0a0a0a; border:1px solid #222; padding:15px; margin-bottom:10px;"><div style="display:flex; justify-content:space-between;"><strong style="color:white">${a.name}</strong> <span style="color:var(--accent); font-size:0.8rem;">${a.skill}</span></div><small style="color:#666">${a.tc}</small><button class="cyber-btn btn-small" style="width:100%; margin-top:10px; border-color:var(--admin-gold); color:var(--admin-gold);" onclick="app.inspectApp(${i})"><i class="fas fa-file-contract"></i> DOSYAYI İNCELE</button></div>`; }); }
                const tl=document.getElementById('hr-tips-list'); tl.innerHTML=this.state.db.tips && this.state.db.tips.length?'':'<span style="color:#666">İhbar yok.</span>';
                if(this.state.db.tips) { this.state.db.tips.forEach((tp, i)=>{ tl.innerHTML += `<div style="border-bottom:1px solid #333; padding:10px;"><strong style="color:var(--accent)">${tp.subject}</strong> <small style="float:right">${tp.date}</small><p style="font-size:0.9rem; color:#ccc; margin-top:5px;">${tp.text}</p><button class="cyber-btn btn-small" style="margin-top:5px; border-color:#555" onclick="app.delTip(${i})">SİL</button></div>` }); }
                document.getElementById('id-actions').innerHTML=`<button class="cyber-btn btn-small" onclick="app.downloadID()">İNDİR</button>`;
            } else document.getElementById('id-actions').innerHTML='<span style="color:#666">Yetkisiz</span>';
        },

        editUser: function(id) { const p=this.state.db.personnel.find(x=>x.id===id); document.getElementById('edit-id').value=p.id; document.getElementById('edit-name').value=p.name; document.getElementById('edit-code').value=p.codename; document.getElementById('edit-role').value=p.role; document.getElementById('edit-rank').value = p.rank || ""; document.getElementById('edit-pass').value = ''; document.getElementById('edit-modal').style.display='flex'; },
        saveEdit: function() { const id=document.getElementById('edit-id').value, p=this.state.db.personnel.find(x=>x.id===id); if(p){ p.name=document.getElementById('edit-name').value; p.codename=document.getElementById('edit-code').value; p.role=document.getElementById('edit-role').value; p.rank = document.getElementById('edit-rank').value.toUpperCase(); const newPass = document.getElementById('edit-pass').value.trim(); if(newPass.length > 0) p.pass = newPass; this.save(); document.getElementById('edit-modal').style.display='none'; this.renderHR(); } },
        
        goToExam: function() { const tc=document.getElementById('app-tc').value, name=document.getElementById('app-name').value; if(!tc||!name){ SFX.error(); return alert("Lütfen kimlik bilgilerini eksiksiz doldurun."); } document.getElementById('app-step-1').style.display = 'none'; document.getElementById('app-step-2').style.display = 'block'; SFX.click(); },

        submitExam: function() {
            const tc=document.getElementById('app-tc').value, name=document.getElementById('app-name').value, g=document.getElementById('app-gender').value, s=document.getElementById('app-skill').value;
            const answers = {}; answers.q1 = document.getElementById('q1').value; answers.q2 = document.getElementById('q2').value; answers.q3 = document.querySelector('input[name="q3"]:checked')?.value || "BOŞ"; answers.q4 = document.querySelector('input[name="q4"]:checked')?.value || "BOŞ"; answers.q5 = document.querySelector('input[name="q5"]:checked')?.value || "BOŞ"; answers.q6 = document.getElementById('q6').value; answers.q7 = document.querySelector('input[name="q7"]:checked')?.value || "BOŞ"; answers.q8 = document.querySelector('input[name="q8"]:checked')?.value || "BOŞ"; answers.q9 = document.getElementById('q9').value; answers.q10 = document.getElementById('q10').value;
            if(!answers.q1 || !answers.q2 || !answers.q9) { SFX.error(); return alert("Lütfen tüm yazılı soruları cevaplayın!"); }
            if(!this.state.db.apps) this.state.db.apps = []; this.state.db.apps.push({ tc, name, skill:s, gender:g, date:new Date().toLocaleDateString(), exam: answers }); 
            this.save(); alert("BAŞVURUNUZ ALINDI. GÜVENLİK SORUŞTURMASI BAŞLATILDI."); 
            document.getElementById('app-tc').value=''; document.getElementById('app-name').value=''; document.getElementById('q1').value=''; document.getElementById('q2').value=''; document.getElementById('q9').value=''; document.getElementById('q10').value=''; document.querySelectorAll('input[type=radio]').forEach(r => r.checked = false);
            document.getElementById('app-step-2').style.display='none'; document.getElementById('app-step-1').style.display='block'; this.nav('public'); SFX.success();
        },

        inspectApp: function(idx) { 
            this.state.viewingAppIdx = idx; const a = this.state.db.apps[idx]; const modal = document.getElementById('app-view-modal'); const content = document.getElementById('app-view-content'); const examData = a.exam || {};
            content.innerHTML = `<div style="border-bottom:1px solid #333; margin-bottom:15px; padding-bottom:10px;"><h4 style="color:var(--staff-blue)">${a.name}</h4><p style="color:#aaa;">TC: ${a.tc} | Branş: <span style="color:white">${a.skill.toUpperCase()}</span> | Cinsiyet: ${a.gender}</p></div><h4 style="color:var(--accent); margin-bottom:10px;">SINAV CEVAPLARI</h4><div style="background:rgba(0,0,0,0.5); padding:10px; border:1px solid #333; font-size:0.9rem;"><p><strong>1. Motivasyon:</strong> ${examData.q1 || '-'}</p><p><strong>2. Devlet Bekası:</strong> ${examData.q2 || '-'}</p><p><strong>3. Emir/Vicdan:</strong> ${examData.q3 || '-'} (A:İtaat, B:Red, C:Çözüm)</p><p><strong>4. İhanet:</strong> ${examData.q4 || '-'} (A:İkna, B:Rapor, C:Kes)</p><p><strong>5. Yakalanma:</strong> ${examData.q5 || '-'} (A:İmha, B:Pazarlık, C:Teslim)</p><p><strong>6. Stres Puanı:</strong> ${examData.q6 || '-'}/10</p><p><strong>7. Yetkinlik:</strong> ${examData.q7 || '-'}</p><p><strong>8. Örgüt Geçmişi:</strong> <span style="color:${examData.q8==='Evet'?'red':'lime'}">${examData.q8 || '-'}</span></p><p><strong>9. Fedakarlık:</strong> ${examData.q9 || '-'}</p><p><strong>10. Yemin:</strong> ${examData.q10 || '-'}</p></div><div style="margin-top:15px;"><label>Onaylanırsa Atanacak Kod Adı:</label><input id="inspect-code" placeholder="Örn: ATMACA"></div>`; modal.style.display = 'flex'; 
        },

        approveAppCurrent: function() { const idx = this.state.viewingAppIdx; const code = document.getElementById('inspect-code').value.toUpperCase(); if(!code) return alert("Kod adı girin!"); const a = this.state.db.apps[idx]; let rank = a.skill==='siber'?"SİBER UZMANI":(a.skill==='saha'?"SAHA AJANI":"ANALİST"); const role = a.skill==='siber'?'cyber':(a.skill==='saha'?'agent':'analyst'); const nP={ id:"AG-"+Math.floor(100+Math.random()*900), name:a.name, codename:code, role:role, rank, pass:"MIT"+Math.floor(1000+Math.random()*9000), gender:a.gender, photoId:Math.floor(Math.random()*99), cover:{fakeName:"Sivil "+Math.floor(Math.random()*100),fakeJob:"Mühendis",fakePhotoId:Math.floor(Math.random()*99)} }; this.state.db.personnel.push(nP); this.state.db.apps.splice(idx,1); this.save(); SFX.success(); document.getElementById('app-view-modal').style.display='none'; this.renderHR(); },
        rejectAppCurrent: function() { const idx = this.state.viewingAppIdx; this.state.db.apps.splice(idx,1); this.save(); document.getElementById('app-view-modal').style.display='none'; this.renderHR(); },
        delTip: function(idx){ this.state.db.tips.splice(idx,1); this.save(); },
        fireStaff: function(id){ if(confirm("Sil?")){ const i=this.state.db.personnel.findIndex(x=>x.id===id); if(i>-1)this.state.db.personnel.splice(i,1); this.save(); this.renderHR(); }},
        togglePass: function(id){ this.state.visiblePass.has(id)?this.state.visiblePass.delete(id):this.state.visiblePass.add(id); this.renderHR(); },

        // --- ENTEGRE EDİLMİŞ GELİŞMİŞ ID CARD ÇİZİM MOTORU (SIXDAY) ---
        drawID: function(id, mode) {
            const p = this.state.db.personnel.find(x => x.id === id); if (!p) return;
            const cvs = document.getElementById('idCardCanvas'); const ctx = cvs.getContext('2d');
            const w = cvs.width; const h = cvs.height;
            const isReal = (mode === 'REAL');

            // 1. Arka Plan (Metalik Gradient)
            const grd = ctx.createLinearGradient(0, 0, w, h);
            grd.addColorStop(0, "#1a1a1a"); grd.addColorStop(1, "#000000");
            ctx.fillStyle = grd; ctx.fillRect(0, 0, w, h);

            // 2. Kırmızı Şerit
            ctx.fillStyle = "#e30a17"; ctx.fillRect(0, 0, w, 120);
            
            // 3. Başlıklar
            ctx.textAlign = "center"; ctx.fillStyle = "#ffffff";
            ctx.font = "bold 45px 'Arial'"; ctx.fillText("TÜRKİYE CUMHURİYETİ", w/2, 60);
            ctx.font = "30px 'Arial'"; ctx.fillText(isReal ? "MİLLİ İSTİHBARAT TEŞKİLATI" : "NÜFUS CÜZDANI", w/2, 100);

            // 4. Logo ve Watermark
            const logo = new Image(); logo.crossOrigin = "Anonymous"; logo.src = "https://upload.wikimedia.org/wikipedia/tr/6/61/Mitlogo.png";
            logo.onload = () => {
                ctx.save(); ctx.globalAlpha = 0.1; ctx.drawImage(logo, w/2 - 200, h/2 - 200, 400, 400); ctx.restore(); // Watermark
                ctx.drawImage(logo, w - 150, 10, 100, 100); // Küçük Logo

                // 5. Fotoğraf
                const photo = new Image(); photo.crossOrigin = "Anonymous";
                const photoId = isReal ? p.photoId : (p.cover ? p.cover.fakePhotoId : 1);
                photo.src = `https://randomuser.me/api/portraits/${p.gender}/${photoId}.jpg`;
                
                photo.onload = () => {
                    const px = 50, py = 150, pw = 250, ph = 300;
                    ctx.save(); ctx.strokeStyle = isReal ? "#e30a17" : "#aaa"; ctx.lineWidth = 5; ctx.strokeRect(px, py, pw, ph); ctx.drawImage(photo, px, py, pw, ph);
                    if(isReal) { ctx.fillStyle = "rgba(0, 255, 0, 0.2)"; ctx.fillRect(px, py + 50, pw, 2); ctx.font = "10px monospace"; ctx.fillStyle = "#0f0"; ctx.fillText("BIO-VERIFIED", px + pw/2, py + ph + 15); }
                    ctx.restore();
                    
                    // 6. Bilgiler
                    ctx.textAlign = "left"; const lx = 350; let ly = 180; const gap = 60;
                    const drawField = (label, value, color="#fff") => {
                        ctx.fillStyle = "#888"; ctx.font = "20px 'Courier New'"; ctx.fillText(label, lx, ly);
                        ctx.fillStyle = color; ctx.font = "bold 35px 'Arial'"; ctx.fillText(value.toUpperCase(), lx, ly + 35); ly += gap + 20;
                    };

                    drawField("AD SOYAD", isReal ? p.name : (p.cover?.fakeName || "BILINMIYOR"));
                    const randTC = Math.floor(10000000000 + Math.random() * 90000000000);
                    drawField("TC KİMLİK NO", randTC.toString());
                    drawField("GÖREV / UNVAN", isReal ? (p.rank || "MEMUR") : (p.cover?.fakeJob || "SİVİL"));
                    
                    if(isReal) {
                        drawField("KOD ADI", p.codename, "#e30a17");
                        ctx.save(); ctx.translate(w - 200, h - 150); ctx.rotate(-0.2); ctx.strokeStyle = "rgba(255,0,0,0.5)"; ctx.lineWidth = 4; ctx.strokeRect(0, 0, 180, 60);
                        ctx.fillStyle = "rgba(255,0,0,0.5)"; ctx.font = "bold 40px 'Arial'"; ctx.fillText("ÇOK GİZLİ", 90, 45); ctx.restore();
                    }

                    // 7. Çip ve Barkod
                    ctx.fillStyle = "#ffd700"; ctx.fillRect(80, 480, 80, 60); ctx.strokeStyle = "#b8860b"; ctx.strokeRect(80, 480, 80, 60);
                    ctx.beginPath(); ctx.moveTo(80,510); ctx.lineTo(160,510); ctx.stroke();
                    ctx.fillStyle = "#fff"; ctx.fillRect(350, h - 80, 600, 50);
                    ctx.fillStyle = "#000"; ctx.font = "30px 'OCR A Std', monospace";
                    const mrz = `IDTUR${randTC}<<<<<<<<<<<<<<<<\n${p.gender === 'men' ? 'M' : 'F'}<<<<<<MIT<<<<<<<<<<<<<<<<`;
                    ctx.fillText(mrz, 650, h - 45);
                };
            };
        },
        downloadID: function(){ const l=document.createElement('a'); l.download='MIT_ID_CARD.png'; l.href=document.getElementById('idCardCanvas').toDataURL(); l.click(); },

        renderPublic: function(){ 
            document.getElementById('feed-public').innerHTML=''; 
            if(!this.state.db || !this.state.db.announcements) return;
            this.state.db.announcements.forEach(a=>{ document.getElementById('feed-public').innerHTML+=`<div style="padding:15px; background:rgba(0,0,0,0.5); border-left:4px solid ${a.type==='critical'?'var(--accent)':'var(--staff-blue)'}; margin-bottom:10px;"><strong style="color:white">${a.title}</strong> <span style="float:right;font-size:0.7rem;color:#666">${a.date}</span><p style="color:#aaa;margin-top:5px;">${a.msg}</p></div>`; }); 
            const t=document.querySelector('#wanted-table tbody'); t.innerHTML=''; 
            if(this.state.db.wanted) this.state.db.wanted.forEach(w=>t.innerHTML+=`<tr><td>${w.name}</td><td>${w.crime}</td><td style="color:var(--accent)">${w.status}</td></tr>`); 
        },
        
        adminPostAnnounce: function(){ 
            if(this.state.user.role!=='admin')return; 
            const t=document.getElementById('ann-title').value, m=document.getElementById('ann-msg').value, tp=document.getElementById('ann-type').value; if(!t)return; 
            if(!this.state.db.announcements) this.state.db.announcements = [];
            this.state.db.announcements.unshift({title:t, msg:m, type:tp, date:new Date().toLocaleDateString()}); 
            this.save(); alert("Yayınlandı"); 
        },
        
        sendTip: function(){ 
            const s=document.getElementById('tip-subj').value, t=document.getElementById('tip-text').value; 
            if(!t){ SFX.error(); return; }
            if(!this.state.db.tips) this.state.db.tips = [];
            this.state.db.tips.unshift({subject:s||"İsimsiz", text:t, date:new Date().toLocaleString()});
            this.save();
            alert("İhbar şifrelendi ve havuza iletildi."); 
            document.getElementById('tip-subj').value=''; document.getElementById('tip-text').value=''; SFX.success();
        },
        
        updateDash: function(){ 
            if(!this.state.db) return;
            document.getElementById('stat-staff').innerText=this.state.db.personnel ? this.state.db.personnel.length : 0; 
            document.getElementById('stat-ops').innerText=this.state.db.ops ? this.state.db.ops.filter(o=>o.status==='AKTİF').length : 0; 
            const l=document.getElementById('dash-logs'); l.innerHTML=''; 
            if(this.state.db.audit) this.state.db.audit.slice(-8).reverse().forEach(x=>l.innerHTML+=`<div style="border-bottom:1px solid #222; padding:5px;"><span style="color:var(--accent)">[${x.time}]</span> ${x.detail}</div>`); 
            if(this.state.user && this.state.user.role === 'admin') { document.getElementById('defcon-controls').style.display='flex'; }
        },
        
        renderChat: function(){ 
            const w=document.getElementById('chat-window'); w.innerHTML=''; 
            if(this.state.db.chat) {
                this.state.db.chat.forEach(c => { 
                    const me = this.state.user && c.user === this.state.user.codename; 
                    let contentHTML = `<span>${c.msg}</span>`;
                    if (c.type === 'image') { contentHTML = `<img src="${c.msg}" class="chat-img" onclick="window.open(this.src)">`; } 
                    else if (c.type === 'audio') { contentHTML = `<audio controls src="${c.msg}" class="chat-audio"></audio>`; }
                    w.innerHTML += `<div class="msg ${me?'msg-me':'msg-other'}"><span class="msg-sender">${me?'BEN':c.user}</span>${contentHTML}</div>`; 
                }); 
                w.scrollTop = w.scrollHeight;
            }
            const userList = document.getElementById('active-user-list'); userList.innerHTML = '';
            if(this.state.db.personnel) {
                this.state.db.personnel.forEach(p => {
                    const isOnline = this.state.onlineUsers[p.id] ? true : false;
                    const peerId = isOnline ? this.state.onlineUsers[p.id].peerId : null;
                    const isMe = p.id === this.state.user.id;
                    let callBtn = '';
                    if(isOnline && !isMe) { callBtn = `<button class="cyber-btn btn-small btn-green" style="padding:2px 8px;" onclick="app.phone.callUser('${peerId}', '${p.codename}')"><i class="fas fa-phone"></i></button>`; }
                    userList.innerHTML += `<div class="chat-user-card" style="opacity:${isOnline ? 1 : 0.5}"><div style="display:flex; align-items:center;"><span class="user-status-dot ${isOnline ? 'status-online' : ''}"></span><div><strong style="color:white; font-size:0.9rem;">${p.codename}</strong></div></div><div>${callBtn}</div></div>`;
                });
            }
        },
        
        sendChat: function(content = null, type = 'text'){ 
            const input = document.getElementById('chat-input'); const msg = content || input.value;
            if(!msg) return; 
            if(!this.state.db.chat) this.state.db.chat = [];
            this.state.db.chat.push({ user: this.state.user.codename, msg: msg, type: type, time: new Date().toLocaleTimeString() });
            if(this.state.db.chat.length > 50) this.state.db.chat.shift();
            this.save(); if(input) input.value = ''; SFX.click(); 
        },

        sendFileChat: function(input) {
            const file = input.files[0]; if (!file) return;
            if(file.size > 2 * 1024 * 1024) { alert("Dosya çok büyük! Maksimum 2MB."); return; }
            const reader = new FileReader(); reader.onload = (e) => { this.sendChat(e.target.result, 'image'); }; reader.readAsDataURL(file);
        },

        startVoice: function() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                this.state.mediaRec = new MediaRecorder(stream); this.state.audioChunks = [];
                document.getElementById('btn-mic').classList.add('recording-pulse');
                this.state.mediaRec.ondataavailable = event => { this.state.audioChunks.push(event.data); };
                this.state.mediaRec.onstop = () => {
                    document.getElementById('btn-mic').classList.remove('recording-pulse');
                    const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/webm' });
                    if(audioBlob.size > 1 * 1024 * 1024) { alert("Ses kaydı çok uzun!"); return; }
                    const reader = new FileReader(); reader.readAsDataURL(audioBlob); 
                    reader.onloadend = () => { this.sendChat(reader.result, 'audio'); }
                };
                this.state.mediaRec.start();
            }).catch(err => { alert("Mikrofon izni gerekli!"); });
        },
        stopVoice: function() { if (this.state.mediaRec && this.state.mediaRec.state !== 'inactive') { this.state.mediaRec.stop(); } },
        
        queryDB: function(){ 
            const q=document.getElementById('db-q').value; if(!q){SFX.error(); return;}
            this.logAudit('SORGU', `Aranan: ${q}`); SFX.success();
            const blood = ["A Rh+", "0 Rh+", "B Rh-", "AB Rh+"][Math.floor(Math.random()*4)];
            const gender = Math.random()>0.5 ? 'men' : 'women';
            const photo = Math.floor(Math.random()*80);
            const score = Math.floor(Math.random()*100);
            const status = score > 80 ? "<span style='color:red'>KRİMİNAL</span>" : "<span style='color:lime'>TEMİZ</span>";
            const hash = Array(16).fill(0).map(()=>Math.random().toString(36)[2]).join('').toUpperCase();
            const html = `<div class="bio-grid"><img src="https://randomuser.me/api/portraits/${gender}/${photo}.jpg" class="bio-img"><div class="bio-data"><div><span class="bio-label">KİMLİK</span> <span>${q.toUpperCase()}</span></div><div><span class="bio-label">KAN GRUBU</span> <span>${blood}</span></div><div><span class="bio-label">GSM SİNYAL</span> <span>AKTİF (Baz: İst-Avr-342)</span></div><div><span class="bio-label">PARMAK İZİ</span> <span>${hash}</span></div><div><span class="bio-label">GBT SKORU</span> <span>${score}/100</span></div><div><span class="bio-label">DURUM</span> <strong>${status}</strong></div></div></div>`;
            document.getElementById('db-res').innerHTML = html;
        },
        
        logAudit: function(act, det){ if(!this.state.db.audit) this.state.db.audit = []; this.state.db.audit.push({time:new Date().toLocaleString(), user:this.state.user?this.state.user.name:'SİSTEM', detail:`${act}: ${det}`}); this.save(); },
        initMap: function(){ if(this.mapInit)return; const m=L.map('map',{zoomControl:false}).setView([39.92,32.85],6); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(m); this.mapInit=true; m.invalidateSize(); },
        updateClock: function(){ document.getElementById('sys-clock').innerText=new Date().toLocaleTimeString(); }
    };
    window.onload = () => app.init();
</script>
</body>
</html>
